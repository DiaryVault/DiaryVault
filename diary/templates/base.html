{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Favicon and App Icons -->
    <link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/static/android-chrome-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/static/android-chrome-512x512.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon-16x16.png">
    <link rel="shortcut icon" href="/static/favicon.ico">
    <link rel="manifest" href="/static/manifest.json">
    <meta name="msapplication-config" content="/static/browserconfig.xml">
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0, viewport-fit=cover"/>
    <title>{% block title %}DiaryVault - Your Personal Digital Journal{% endblock %}</title>

    <meta name="stripe-publishable-key" content="{{ STRIPE_PUBLISHABLE_KEY|default:'pk_test_your_key_here' }}">
    <meta name="csrf-token" content="{{ csrf_token }}">

    <meta name="theme-color" content="#6366f1" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/alpinejs/3.13.3/cdn.min.js" defer></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Playfair+Display:wght@400;500;600;700&family=Caveat:wght@400;500;600;700&display=swap" rel="stylesheet">

    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'system-ui', 'sans-serif'],
              serif: ['Playfair Display', 'Georgia', 'serif'],
              handwritten: ['Caveat', 'cursive'],
            },
            colors: {
              primary: {
                50: '#eef2ff',
                100: '#e0e7ff',
                200: '#c7d2fe',
                300: '#a5b4fc',
                400: '#818cf8',
                500: '#6366f1',
                600: '#4f46e5',
                700: '#4338ca',
                800: '#3730a3',
                900: '#312e81',
                950: '#1e1b4b',
              },
              secondary: {
                50: '#f8fafc',
                100: '#f1f5f9',
                200: '#e2e8f0',
                300: '#cbd5e1',
                400: '#94a3b8',
                500: '#64748b',
                600: '#475569',
                700: '#334155',
                800: '#1e293b',
                900: '#0f172a',
                950: '#020617',
              },
              success: {
                50: '#f0fdf4',
                100: '#dcfce7',
                200: '#bbf7d0',
                300: '#86efac',
                400: '#4ade80',
                500: '#22c55e',
                600: '#16a34a',
                700: '#15803d',
                800: '#166534',
                900: '#14532d',
              },
              warning: {
                50: '#fffbeb',
                100: '#fef3c7',
                200: '#fde68a',
                300: '#fcd34d',
                400: '#fbbf24',
                500: '#f59e0b',
                600: '#d97706',
                700: '#b45309',
                800: '#92400e',
                900: '#78350f',
              },
              error: {
                50: '#fef2f2',
                100: '#fee2e2',
                200: '#fecaca',
                300: '#fca5a5',
                400: '#f87171',
                500: '#ef4444',
                600: '#dc2626',
                700: '#b91c1c',
                800: '#991b1b',
                900: '#7f1d1d',
              },
              neutral: {
                50: '#fafafa',
                100: '#f5f5f5',
                200: '#e5e5e5',
                300: '#d4d4d4',
                400: '#a3a3a3',
                500: '#737373',
                600: '#525252',
                700: '#404040',
                800: '#262626',
                900: '#171717',
                950: '#0a0a0a',
              }
            },
            animation: {
              'fade-in': 'fadeIn 0.6s ease-out forwards',
              'fade-in-up': 'fadeInUp 0.8s ease-out forwards',
              'slide-in': 'slideIn 0.5s ease-out forwards',
              'scale-in': 'scaleIn 0.4s ease-out forwards',
              'bounce-gentle': 'bounceGentle 2s ease-in-out infinite',
              'float': 'float 3s ease-in-out infinite',
              'pulse-soft': 'pulseSoft 2s ease-in-out infinite',
              'shimmer': 'shimmer 2s linear infinite',
              'pulse-ring': 'pulseRing 1.5s ease-out infinite',
              'slide-up': 'slideUp 0.3s ease-out',
              'pulse-badge': 'pulseBadge 2s ease-in-out infinite',
            },
            keyframes: {
              fadeIn: {
                '0%': { opacity: '0' },
                '100%': { opacity: '1' },
              },
              fadeInUp: {
                '0%': { opacity: '0', transform: 'translateY(20px)' },
                '100%': { opacity: '1', transform: 'translateY(0)' },
              },
              slideIn: {
                '0%': { transform: 'translateX(-100%)' },
                '100%': { transform: 'translateX(0)' },
              },
              scaleIn: {
                '0%': { opacity: '0', transform: 'scale(0.9)' },
                '100%': { opacity: '1', transform: 'scale(1)' },
              },
              bounceGentle: {
                '0%, 100%': { transform: 'translateY(0)' },
                '50%': { transform: 'translateY(-3px)' },
              },
              float: {
                '0%, 100%': { transform: 'translateY(0px)' },
                '50%': { transform: 'translateY(-6px)' },
              },
              pulseSoft: {
                '0%, 100%': { opacity: '1' },
                '50%': { opacity: '0.8' },
              },
              shimmer: {
                '0%': { transform: 'translateX(-100%)' },
                '100%': { transform: 'translateX(100%)' },
              },
              pulseRing: {
                '0%': { transform: 'scale(0.8)', opacity: '1' },
                '40%': { transform: 'scale(1)', opacity: '0.3' },
                '100%': { transform: 'scale(1.2)', opacity: '0' },
              },
              slideUp: {
                '0%': { transform: 'translateY(10px)', opacity: '0' },
                '100%': { transform: 'translateY(0)', opacity: '1' },
              },
              pulseBadge: {
                '0%, 100%': { transform: 'scale(1)' },
                '50%': { transform: 'scale(1.05)' },
              },
            },
            spacing: {
              '18': '4.5rem',
              '88': '22rem',
            },
            borderRadius: {
              '4xl': '2rem',
              '5xl': '2.5rem',
            },
            backdropBlur: {
              xs: '2px',
              '3xl': '64px',
            },
            boxShadow: {
              'soft': '0 2px 15px -3px rgba(0, 0, 0, 0.07), 0 10px 20px -2px rgba(0, 0, 0, 0.04)',
              'soft-lg': '0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)',
              'inner-soft': 'inset 0 2px 4px 0 rgba(0, 0, 0, 0.06)',
              'glow': '0 0 20px rgba(99, 102, 241, 0.15)',
              'glow-lg': '0 0 40px rgba(99, 102, 241, 0.2)',
              'nav': '0 -4px 32px rgba(0, 0, 0, 0.08), 0 -2px 16px rgba(0, 0, 0, 0.04)',
              'fab': '0 8px 32px rgba(99, 102, 241, 0.3), 0 4px 16px rgba(99, 102, 241, 0.2)',
              'fab-hover': '0 12px 40px rgba(99, 102, 241, 0.4), 0 6px 20px rgba(99, 102, 241, 0.3)',
            }
          },
        },
      }
    </script>

    <style>
      /* Enhanced Typography */
      .diary-font {
        font-family: 'Playfair Display', serif;
        letter-spacing: -0.025em;
        font-feature-settings: 'liga' 1, 'kern' 1;
      }

      .handwritten {
        font-family: 'Caveat', cursive;
        font-feature-settings: 'liga' 1;
      }

      /* Enhanced Base Styles */
      * {
        box-sizing: border-box;
      }

      html {
        overflow-x: hidden;
        scroll-behavior: smooth;
        width: 100%;
        max-width: 100%;
      }

      body {
        font-family: 'Inter', system-ui, sans-serif;
        font-feature-settings: 'liga' 1, 'kern' 1;
        overflow-x: hidden;
        width: 100%;
        max-width: 100%;
        min-width: 320px;
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 25%, #f1f5f9 50%, #e0e7ff 75%, #f8fafc 100%);
        background-size: 400% 400%;
        animation: gradientShift 20s ease infinite;
        position: relative;
        overscroll-behavior-x: none;
        -webkit-overflow-scrolling: touch;
      }

      /* Prevent horizontal scrolling globally */
      body, html {
        max-width: 100vw;
        overflow-x: hidden;
      }

      /* Container stability */
      .container {
        width: 100%;
        max-width: 100%;
        padding-left: 1rem;
        padding-right: 1rem;
        margin-left: auto;
        margin-right: auto;
        overflow-x: hidden;
      }

      /* Prevent content from causing horizontal scroll */
      * {
        max-width: 100%;
      }

      img, video, iframe, object, embed {
        max-width: 100%;
        height: auto;
      }

      @keyframes gradientShift {
        0%, 100% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
      }

      /* Mobile-specific fixes */
      @media screen and (max-width: 768px) {
        body {
          overflow-x: hidden !important;
          width: 100vw !important;
          max-width: 100vw !important;
          position: relative;
          -webkit-text-size-adjust: 100%;
          -webkit-tap-highlight-color: transparent;
        }

        /* Prevent zoom on input focus */
        input, textarea, select {
          font-size: 16px !important;
        }

        /* Prevent horizontal bounce */
        * {
          -webkit-transform: translateZ(0);
          transform: translateZ(0);
        }

        /* Fix for iOS bounce */
        html, body {
          overscroll-behavior: none;
          -webkit-overflow-scrolling: touch;
        }
      }

      /* Enhanced touch handling for mobile stability */
      @media (hover: none) and (pointer: coarse) {
        body {
          -webkit-touch-callout: none;
          -webkit-user-select: none;
          -khtml-user-select: none;
          -moz-user-select: none;
          -ms-user-select: none;
          user-select: none;
        }

        /* Allow text selection in specific areas */
        input, textarea, [contenteditable] {
          -webkit-user-select: text;
          -khtml-user-select: text;
          -moz-user-select: text;
          -ms-user-select: text;
          user-select: text;
        }
      }

      /* Enhanced Glass Morphism */
      .glass-card {
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        transition: all 0.4s cubic-bezier(0.23, 1, 0.320, 1);
        max-width: 100%;
        overflow-x: hidden;
      }

      .glass-card:hover {
        background: rgba(255, 255, 255, 0.95);
        transform: translateY(-2px);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        border-color: rgba(99, 102, 241, 0.2);
      }

      .glass-nav {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(24px) saturate(180%);
        -webkit-backdrop-filter: blur(24px) saturate(180%);
        border-bottom: 1px solid rgba(255, 255, 255, 0.3);
        width: 100%;
        max-width: 100vw;
        overflow-x: hidden;
      }

      /* Simplified Logo Styles */
      .logo-container {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        text-decoration: none;
        transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        border-radius: 12px;
        padding: 8px 12px;
        margin: -8px -12px;
      }

      .logo-container:hover {
        transform: translateY(-1px);
        background: rgba(99, 102, 241, 0.05);
      }

      .logo-icon {
        width: 32px;
        height: 32px;
        background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.25);
        transition: all 0.3s ease;
      }

      .logo-container:hover .logo-icon {
        transform: scale(1.05);
        box-shadow: 0 6px 16px rgba(99, 102, 241, 0.35);
      }

      .brand-text {
        font-size: 1.25rem;
        font-weight: 700;
        background: linear-gradient(135deg, #6366f1, #4f46e5);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .brand-badge {
        background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
        color: white;
        font-size: 0.625rem;
        font-weight: 700;
        padding: 2px 8px;
        border-radius: 6px;
        letter-spacing: 0.05em;
        text-transform: uppercase;
        transform: rotate(-1deg);
        box-shadow: 0 2px 6px rgba(245, 158, 11, 0.3);
        animation: pulse-badge 3s ease-in-out infinite;
      }

      /* Modern Button System */
      .btn-primary {
        background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
        color: white;
        font-weight: 600;
        border: none;
        border-radius: 10px;
        padding: 8px 16px;
        position: relative;
        overflow: hidden;
        transition: all 0.3s cubic-bezier(0.23, 1, 0.320, 1);
        box-shadow: 0 4px 15px rgba(99, 102, 241, 0.2);
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }

      .btn-primary::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: left 0.6s;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(99, 102, 241, 0.3);
      }

      .btn-primary:hover::before {
        left: 100%;
      }

      .btn-secondary {
        background: rgba(255, 255, 255, 0.9);
        color: #4f46e5;
        border: 1px solid rgba(99, 102, 241, 0.2);
        font-weight: 500;
        backdrop-filter: blur(10px);
        border-radius: 10px;
        padding: 8px 16px;
        transition: all 0.3s cubic-bezier(0.23, 1, 0.320, 1);
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }

      .btn-secondary:hover {
        background: rgba(255, 255, 255, 1);
        border-color: #6366f1;
        color: #4338ca;
        transform: translateY(-1px);
        box-shadow: 0 4px 15px rgba(99, 102, 241, 0.15);
      }

      /* Enhanced Navigation */
      .nav-link {
        position: relative;
        color: #64748b;
        font-weight: 500;
        padding: 8px 16px;
        border-radius: 10px;
        transition: all 0.3s cubic-bezier(0.23, 1, 0.320, 1);
        display: flex;
        align-items: center;
        gap: 8px;
        text-decoration: none;
        font-size: 0.875rem;
      }

      .nav-link:hover,
      .nav-link.active {
        color: #4f46e5;
        background: rgba(99, 102, 241, 0.08);
      }

      .nav-link.active {
        font-weight: 600;
        background: rgba(99, 102, 241, 0.12);
      }

      /* User Profile Section */
      .user-profile {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 6px 12px;
        border-radius: 12px;
        transition: all 0.3s ease;
        text-decoration: none;
        color: inherit;
      }

      .user-profile:hover {
        background: rgba(99, 102, 241, 0.05);
        transform: translateY(-1px);
      }

      .user-avatar {
        width: 32px;
        height: 32px;
        border-radius: 10px;
        background: linear-gradient(135deg, #6366f1, #4f46e5);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 700;
        font-size: 0.875rem;
        box-shadow: 0 3px 10px rgba(99, 102, 241, 0.3);
        position: relative;
      }

      .notification-dot {
        position: absolute;
        top: -2px;
        right: -2px;
        width: 12px;
        height: 12px;
        background: #ef4444;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.625rem;
        font-weight: 700;
        color: white;
        box-shadow: 0 0 0 2px white;
      }

      /* Menu Button */
      .menu-button {
        padding: 8px;
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.8);
        border: 1px solid rgba(203, 213, 225, 0.5);
        color: #64748b;
        transition: all 0.3s ease;
        position: relative;
        cursor: pointer;
      }

      .menu-button:hover {
        background: rgba(255, 255, 255, 0.95);
        border-color: rgba(99, 102, 241, 0.3);
        color: #4f46e5;
        transform: translateY(-1px);
      }

      /* Enhanced Mobile Menu */
      .mobile-menu {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(30px);
        border-top: 1px solid rgba(99, 102, 241, 0.1);
        box-shadow: 0 -8px 32px rgba(0, 0, 0, 0.1);
        transform: translateY(100%);
        transition: transform 0.4s cubic-bezier(0.23, 1, 0.320, 1);
        width: 100%;
        max-width: 100vw;
        overflow-x: hidden;
      }

      .mobile-menu.open {
        transform: translateY(0);
      }

      .menu-overlay {
        background: rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(8px);
        opacity: 0;
        transition: all 0.3s cubic-bezier(0.23, 1, 0.320, 1);
        pointer-events: none;
        width: 100%;
        max-width: 100vw;
        overflow: hidden;
      }

      .menu-overlay.active {
        opacity: 1;
        pointer-events: auto;
      }

      /* Enhanced Mobile Navigation */
      .mobile-nav-item {
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 10px 8px;
        border-radius: 12px;
        transition: all 0.3s cubic-bezier(0.23, 1, 0.320, 1);
        color: #64748b;
        min-height: 56px;
        cursor: pointer;
        user-select: none;
        text-decoration: none;
      }

      .mobile-nav-item::before {
        content: '';
        position: absolute;
        inset: 0;
        border-radius: 12px;
        background: linear-gradient(135deg, rgba(99, 102, 241, 0.08), rgba(79, 70, 229, 0.12));
        opacity: 0;
        transition: all 0.3s cubic-bezier(0.23, 1, 0.320, 1);
        transform: scale(0.8);
      }

      .mobile-nav-item.active {
        color: #4f46e5;
      }

      .mobile-nav-item.active::before {
        opacity: 1;
        transform: scale(1);
      }

      .mobile-nav-item span {
        font-weight: 500;
        font-size: 0.75rem;
        margin-top: 4px;
        transition: all 0.3s ease;
      }

      .mobile-nav-item.active span {
        font-weight: 600;
      }

      /* Enhanced Floating Action Button */
      .fab {
        background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
        color: white;
        border-radius: 16px;
        padding: 14px;
        box-shadow: 0 6px 24px rgba(99, 102, 241, 0.3);
        transition: all 0.4s cubic-bezier(0.23, 1, 0.320, 1);
        transform: translateY(-4px);
        cursor: pointer;
        user-select: none;
        text-decoration: none;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: float 3s ease-in-out infinite;
      }

      .fab:hover {
        transform: translateY(-6px) scale(1.05);
        box-shadow: 0 8px 30px rgba(99, 102, 241, 0.4);
      }

      .fab:active {
        transform: translateY(-5px) scale(0.98);
      }

      /* Notification Badge */
      .notification-badge {
        position: absolute;
        top: 4px;
        right: 4px;
        min-width: 16px;
        height: 16px;
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: white;
        font-size: 0.625rem;
        font-weight: 700;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 1px 6px rgba(239, 68, 68, 0.4);
        z-index: 10;
      }

      /* Enhanced Scrollbar */
      .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
      }

      .custom-scrollbar::-webkit-scrollbar-track {
        background: rgba(241, 245, 249, 0.5);
        border-radius: 8px;
      }

      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, #6366f1, #4f46e5);
        border-radius: 8px;
        transition: background 0.3s ease;
      }

      .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(135deg, #4f46e5, #4338ca);
      }

      /* Form Elements */
      .form-input {
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid rgba(226, 232, 240, 1);
        border-radius: 10px;
        padding: 12px 16px;
        font-weight: 500;
        transition: all 0.3s cubic-bezier(0.23, 1, 0.320, 1);
        backdrop-filter: blur(10px);
      }

      .form-input:focus {
        outline: none;
        border-color: #6366f1;
        background: rgba(255, 255, 255, 1);
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        transform: translateY(-1px);
      }

      /* Ripple Effect */
      .ripple {
        position: absolute;
        border-radius: 50%;
        background: rgba(99, 102, 241, 0.3);
        transform: scale(0);
        animation: ripple-animation 0.6s linear;
        pointer-events: none;
      }

      @keyframes ripple-animation {
        to {
          transform: scale(4);
          opacity: 0;
        }
      }

      /* Accessibility */
      :focus-visible {
        outline: 2px solid #6366f1;
        outline-offset: 2px;
        border-radius: 8px;
      }

      /* Dark Mode Support */
      @media (prefers-color-scheme: dark) {
        body {
          background: linear-gradient(135deg, #0f172a 0%, #1e293b 25%, #334155 50%, #1e293b 75%, #0f172a 100%);
        }

        .glass-card, .glass-nav {
          background: rgba(30, 41, 59, 0.8);
          border-color: rgba(148, 163, 184, 0.2);
        }

        .mobile-nav-item {
          color: #94a3b8;
        }

        .mobile-nav-item.active {
          color: #818cf8;
        }
      }

      /* Reduced Motion */
      @media (prefers-reduced-motion: reduce) {
        * {
          animation-duration: 0.01ms !important;
          animation-iteration-count: 1 !important;
          transition-duration: 0.01ms !important;
        }
      }

      /* Print Styles */
      @media print {
        .mobile-menu, .fab, .mobile-nav, .glass-nav {
          display: none !important;
        }
      }
    </style>

    {% block extra_css %}{% endblock %}
</head>

<body class="min-h-screen flex flex-col bg-gradient-to-br text-secondary-800 custom-scrollbar" style="max-width: 100vw; overflow-x: hidden;">
    <!-- Enhanced Header -->
    <header class="sticky top-0 z-50 w-full glass-nav transition-all duration-300"
            x-data="{ scrolled: false }"
            x-init="window.addEventListener('scroll', () => { scrolled = window.scrollY > 20 })"
            :class="{ 'shadow-soft-lg': scrolled }">
        <div class="container max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3">
            <div class="flex items-center justify-between">
                <!-- Smart Logo -->
                <a href="{% if user.is_authenticated %}{% url 'dashboard' %}{% else %}{% url 'home' %}{% endif %}" class="logo-container">
                    <div class="logo-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                        </svg>
                    </div>
                    <div class="flex items-center gap-2">
                        <h1 class="brand-text diary-font">DiaryVault</h1>
                        <span class="brand-badge">Beta</span>
                    </div>
                </a>

                <!-- Desktop Navigation -->
                {% if user.is_authenticated %}
                <nav class="hidden lg:flex items-center gap-2">
                    <a href="{% url 'dashboard' %}" class="nav-link {% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1h2a1 1 0 001-1v-7m-6 0h6" />
                        </svg>
                        Dashboard
                    </a>
                    <a href="{% url 'library' %}" class="nav-link {% if request.resolver_match.url_name == 'library' %}active{% endif %}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                        </svg>
                        Library
                    </a>
                    <a href="{% url 'new_entry' %}" class="nav-link {% if request.resolver_match.url_name == 'new_entry' %}active{% endif %}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                        </svg>
                        Write
                    </a>
                    <a href="{% url 'biography' %}" class="nav-link {% if request.resolver_match.url_name == 'biography' %}active{% endif %}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                        </svg>
                        Biography
                    </a>
                    <a href="{% url 'insights' %}" class="nav-link {% if request.resolver_match.url_name == 'insights' %}active{% endif %}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                        </svg>
                        Insights
                    </a>
                    <a href="{% url 'marketplace' %}" class="nav-link {% if request.resolver_match.url_name == 'marketplace' %}active{% endif %}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
                        </svg>
                        Marketplace
                    </a>
                </nav>
                {% else %}
                <nav class="hidden lg:flex items-center gap-2">
                    <a href="{% url 'signup' %}?feature=journal" class="nav-link">Journal</a>
                    <a href="{% url 'signup' %}?feature=library" class="nav-link">Library</a>
                    <a href="{% url 'signup' %}?feature=biography" class="nav-link">Biography</a>
                    <a href="{% url 'signup' %}?feature=insights" class="nav-link">Insights</a>
                    <a href="{% url 'marketplace' %}" class="nav-link {% if request.resolver_match.url_name == 'marketplace' %}active{% endif %}">Marketplace</a>
                </nav>
                {% endif %}

                <!-- Right Section -->
                <div class="flex items-center gap-3">
                    {% if user.is_authenticated %}
                    <!-- User Profile -->
                    <a href="{% url 'account_settings' %}" class="user-profile hidden sm:flex">
                        <div class="user-avatar">
                            {{ user.username|first|upper }}
                            {% if unread_notifications > 0 %}
                            <div class="notification-dot">{{ unread_notifications }}</div>
                            {% endif %}
                        </div>
                        <div class="hidden lg:block">
                            <div class="text-sm font-semibold text-secondary-700">{{ user.username }}</div>
                            <div class="text-xs text-secondary-500">{{ total_entries|default:'0' }} entries</div>
                        </div>
                    </a>
                    {% else %}
                    <!-- Auth Buttons -->
                    <div class="hidden md:flex gap-2">
                        <a href="{% url 'login' %}" class="btn-secondary">Log in</a>
                        <a href="{% url 'signup' %}" class="btn-primary">Sign up</a>
                    </div>
                    {% endif %}

                    <!-- Menu Button -->
                    <button id="menuToggleBtn" class="menu-button">
                        {% if user.is_authenticated and unread_notifications > 0 %}
                        <div class="notification-badge">{{ unread_notifications }}</div>
                        {% endif %}
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Enhanced Mobile Menu -->
    <div id="menuOverlay" class="menu-overlay fixed inset-0 bg-black/40 z-50 hidden">
        <div id="menuSheet" class="mobile-menu fixed bottom-0 left-0 right-0 rounded-t-3xl shadow-2xl z-50 max-h-[85vh] overflow-y-auto custom-scrollbar">
            <!-- Pull Indicator -->
            <div class="w-10 h-1.5 bg-gray-300 rounded-full mx-auto mt-3 mb-2"></div>

            <!-- Menu Header -->
            <div class="px-6 pt-2 pb-4 flex justify-between items-center border-b border-gray-100">
                <div class="flex items-center gap-3">
                    <div class="logo-icon w-8 h-8">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                        </svg>
                    </div>
                    <h2 class="brand-text diary-font text-lg">DiaryVault</h2>
                </div>
                <button id="closeMenuBtn" class="p-2 hover:bg-gray-100 rounded-xl transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            {% if user.is_authenticated %}
            <!-- User Profile Section -->
            <div class="px-6 pb-4">
                <a href="{% url 'account_settings' %}" class="block">
                    <div class="flex items-center p-4 glass-card rounded-2xl border border-primary-100/50">
                        <div class="user-avatar w-14 h-14 text-lg">
                            {{ user.username|first|upper }}
                        </div>
                        <div class="ml-4">
                            <div class="font-semibold text-gray-800">{{ user.username }}</div>
                            <div class="text-sm text-gray-500">{{ total_entries|default:'0' }} journal entries</div>
                        </div>
                        <div class="ml-auto">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                            </svg>
                        </div>
                    </div>
                </a>
            </div>

            <!-- Main Menu -->
            <div class="px-6 pb-6">
                <div class="space-y-2">
                    <a href="{% url 'dashboard' %}" class="flex items-center py-4 px-4 {% if request.resolver_match.url_name == 'dashboard' %}glass-card text-primary-600 border-primary-200{% else %}hover:bg-gray-50{% endif %} rounded-2xl border border-transparent transition-all">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-primary-600 mr-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1h2a1 1 0 001-1v-7m-6 0h6" />
                        </svg>
                        <span class="font-medium">Dashboard</span>
                    </a>

                    <a href="{% url 'library' %}" class="flex items-center py-4 px-4 {% if request.resolver_match.url_name == 'library' %}glass-card text-primary-600 border-primary-200{% else %}hover:bg-gray-50{% endif %} rounded-2xl border border-transparent transition-all">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-primary-600 mr-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                        </svg>
                        <span class="font-medium">Library</span>
                    </a>

                    <a href="{% url 'new_entry' %}" class="flex items-center py-4 px-4 {% if request.resolver_match.url_name == 'new_entry' %}glass-card text-primary-600 border-primary-200{% else %}hover:bg-gray-50{% endif %} rounded-2xl border border-transparent transition-all">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-primary-600 mr-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                        </svg>
                        <span class="font-medium">Write Entry</span>
                    </a>

                    <a href="{% url 'biography' %}" class="flex items-center py-4 px-4 {% if request.resolver_match.url_name == 'biography' %}glass-card text-primary-600 border-primary-200{% else %}hover:bg-gray-50{% endif %} rounded-2xl border border-transparent transition-all">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-primary-600 mr-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                        </svg>
                        <span class="font-medium">Biography</span>
                    </a>

                    <a href="{% url 'insights' %}" class="flex items-center py-4 px-4 {% if request.resolver_match.url_name == 'insights' %}glass-card text-primary-600 border-primary-200{% else %}hover:bg-gray-50{% endif %} rounded-2xl border border-transparent transition-all">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-primary-600 mr-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                        </svg>
                        <span class="font-medium">Insights</span>
                    </a>

                    <a href="{% url 'marketplace' %}" class="flex items-center py-4 px-4 {% if request.resolver_match.url_name == 'marketplace' %}glass-card text-primary-600 border-primary-200{% else %}hover:bg-gray-50{% endif %} rounded-2xl border border-transparent transition-all">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-primary-600 mr-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
                        </svg>
                        <span class="font-medium">Marketplace</span>
                    </a>

                    <a href="{% url 'account_settings' %}" class="flex items-center py-4 px-4 {% if request.resolver_match.url_name == 'account_settings' %}glass-card text-primary-600 border-primary-200{% else %}hover:bg-gray-50{% endif %} rounded-2xl border border-transparent transition-all">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-primary-600 mr-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                        <span class="font-medium">Settings</span>
                    </a>
                </div>

                <!-- Logout Button -->
                <div class="mt-6">
                    <form method="post" action="{% url 'logout' %}">
                        {% csrf_token %}
                        <button type="submit" class="w-full py-4 px-4 glass-card hover:bg-red-50 text-red-600 rounded-2xl flex items-center justify-center transition-all font-medium border border-red-100 hover:border-red-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                            </svg>
                            <span>Logout</span>
                        </button>
                    </form>
                </div>
            </div>
            {% else %}
            <!-- Non-authenticated Menu -->
            <div class="px-6 pb-6">
                <div class="space-y-3 mb-6">
                    <a href="{% url 'marketplace' %}" class="flex items-center gap-4 p-4 glass-card rounded-2xl transition-all hover:scale-[1.02]">
                        <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-green-400 to-green-600 flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
                            </svg>
                        </div>
                        <div class="flex-1">
                            <span class="font-semibold text-gray-800">Marketplace</span>
                            <span class="text-sm text-primary-600 block">Browse journal templates</span>
                        </div>
                    </a>
                </div>

                <!-- Auth Buttons -->
                <div class="space-y-3">
                    <a href="{% url 'login' %}" class="w-full py-4 px-4 glass-card hover:bg-white/80 rounded-2xl transition-all font-semibold border border-gray-200/50 hover:shadow-lg flex items-center justify-center gap-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-primary-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1" />
                        </svg>
                        <span>Log in</span>
                    </a>

                    <a href="{% url 'signup' %}" class="w-full btn-primary py-4 px-4 rounded-2xl font-semibold flex items-center justify-center gap-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
                        </svg>
                        <span>Sign up for free</span>
                    </a>
                </div>
            </div>
            {% endif %}

            <!-- Safe area at bottom -->
            <div class="h-8"></div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="flex-1 w-full max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        {% block content %}
        <!-- Page content will go here -->
        {% endblock %}
    </main>

    <!-- Enhanced Mobile Navigation -->
    {% if user.is_authenticated %}
    <nav class="lg:hidden fixed bottom-0 left-0 right-0 glass-nav shadow-nav z-30">
        <div class="px-4 py-3" style="padding-bottom: max(1rem, env(safe-area-inset-bottom));">
            <div class="flex justify-around items-end relative">
                <!-- Dashboard -->
                <a href="{% url 'dashboard' %}" class="mobile-nav-item {% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}">
                    {% if unread_notifications > 0 %}
                    <div class="notification-badge">{{ unread_notifications }}</div>
                    {% endif %}
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1h2a1 1 0 001-1v-7m-6 0h6" />
                    </svg>
                    <span>Home</span>
                </a>

                <!-- Library -->
                <a href="{% url 'library' %}" class="mobile-nav-item {% if request.resolver_match.url_name == 'library' %}active{% endif %}">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                    </svg>
                    <span>Library</span>
                </a>

                <!-- FAB for New Entry -->
                <a href="{% url 'new_entry' %}" class="fab">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                    </svg>
                </a>

                <!-- Biography -->
                <a href="{% url 'biography' %}" class="mobile-nav-item {% if request.resolver_match.url_name == 'biography' %}active{% endif %}">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                    <span>Bio</span>
                </a>

                <!-- Insights -->
                <a href="{% url 'insights' %}" class="mobile-nav-item {% if request.resolver_match.url_name == 'insights' %}active{% endif %}">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                    </svg>
                    <span>Insights</span>
                </a>
            </div>
        </div>
    </nav>
    {% endif %}

    <!-- Enhanced Footer -->
    <footer class="mt-12 glass-nav border-t border-primary-100" style="margin-bottom: env(safe-area-inset-bottom, 0px);">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex items-center gap-3">
                    <div class="logo-icon w-8 h-8">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                        </svg>
                    </div>
                    <div>
                        <div class="flex items-center gap-2">
                            <h3 class="brand-text text-sm diary-font">DiaryVault</h3>
                            <span class="brand-badge text-xs">Beta</span>
                        </div>
                        <p class="text-xs text-secondary-500">Â© 2025 DiaryVault. All rights reserved.</p>
                    </div>
                </div>

                <div class="flex items-center gap-4 text-sm">
                    <a href="https://crene.com" target="_blank" rel="noopener" class="flex items-center gap-2 text-secondary-600 hover:text-primary-600 transition-colors">
                        <span class="font-medium">Crene.com</span>
                    </a>
                    <a href="https://euphorie.com" target="_blank" rel="noopener" class="flex items-center gap-2 text-secondary-600 hover:text-primary-600 transition-colors">
                        <span class="font-medium">Euphorie.com</span>
                    </a>
                </div>
            </div>
        </div>
    </footer>

    <!-- Toast Notification Container -->
    <div id="toastContainer" class="fixed top-6 right-6 z-50 space-y-3 pointer-events-none">
        <!-- Notifications will be inserted here -->
    </div>

    <!-- Enhanced JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Enhanced menu functionality
            initMenuSystem();
            initMobileNavigation();
            initKeyboardShortcuts();
            initPageTransitions();
            initToastSystem();
            initMobileStability();

            // Initialize page
            document.body.style.opacity = '1';
        });

        function initMenuSystem() {
            const menuToggleBtn = document.getElementById('menuToggleBtn');
            const closeMenuBtn = document.getElementById('closeMenuBtn');
            const menuOverlay = document.getElementById('menuOverlay');
            const menuSheet = document.getElementById('menuSheet');

            // Only initialize if all required elements exist
            if (!menuToggleBtn || !menuOverlay || !menuSheet) {
                console.warn('Menu elements not found - menu functionality disabled');
                return;
            }

            let isMenuOpen = false;

            function toggleMenu() {
                try {
                    if (!isMenuOpen) {
                        // Show menu
                        menuOverlay.classList.remove('hidden');
                        document.body.style.overflow = 'hidden';
                        isMenuOpen = true;

                        requestAnimationFrame(() => {
                            if (menuOverlay) menuOverlay.classList.add('active');
                            if (menuSheet) menuSheet.classList.add('open');
                        });
                    } else {
                        // Hide menu
                        if (menuSheet) menuSheet.classList.remove('open');
                        if (menuOverlay) menuOverlay.classList.remove('active');
                        document.body.style.overflow = '';
                        isMenuOpen = false;

                        setTimeout(() => {
                            if (menuOverlay) menuOverlay.classList.add('hidden');
                        }, 400);
                    }
                } catch (error) {
                    console.error('Error toggling menu:', error);
                    // Reset state on error
                    isMenuOpen = false;
                    document.body.style.overflow = '';
                    if (menuOverlay) menuOverlay.classList.add('hidden');
                }
            }

            // Add event listeners with error handling
            try {
                menuToggleBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    toggleMenu();
                });

                if (closeMenuBtn) {
                    closeMenuBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        toggleMenu();
                    });
                }

                // Close menu when clicking outside
                menuOverlay.addEventListener('click', function(event) {
                    if (event.target === menuOverlay) {
                        toggleMenu();
                    }
                });

                // Keyboard support
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape' && isMenuOpen) {
                        toggleMenu();
                    }
                });

                // Touch support for swipe down to close with better stability
                if (menuSheet) {
                    let startY = 0;
                    let currentY = 0;
                    let startX = 0;
                    let isDragging = false;

                    menuSheet.addEventListener('touchstart', function(e) {
                        if (e.touches && e.touches.length > 0) {
                            startY = e.touches[0].clientY;
                            startX = e.touches[0].clientX;
                            isDragging = true;
                        }
                    }, { passive: true });

                    menuSheet.addEventListener('touchmove', function(e) {
                        if (!isDragging || !e.touches || e.touches.length === 0) return;

                        currentY = e.touches[0].clientY;
                        const currentX = e.touches[0].clientX;
                        const diffY = currentY - startY;
                        const diffX = Math.abs(currentX - startX);

                        // Only handle vertical swipes, prevent horizontal movement
                        if (diffX > 30) {
                            e.preventDefault();
                            return;
                        }

                        if (diffY > 0 && menuSheet.scrollTop === 0) {
                            menuSheet.style.transform = `translateY(${Math.min(diffY, 200)}px)`;
                            menuSheet.style.transition = 'none';
                            e.preventDefault();
                        }
                    }, { passive: false });

                    menuSheet.addEventListener('touchend', function() {
                        if (!isDragging) return;
                        isDragging = false;

                        const diff = currentY - startY;
                        if (menuSheet) {
                            menuSheet.style.transition = '';
                            menuSheet.style.transform = '';
                        }

                        if (diff > 100) {
                            toggleMenu();
                        }
                    }, { passive: true });
                }

                // Cleanup on page unload
                window.addEventListener('beforeunload', function() {
                    document.body.style.overflow = '';
                    isMenuOpen = false;
                });

                // Reset menu state on page show (back button)
                window.addEventListener('pageshow', function() {
                    if (menuOverlay && !menuOverlay.classList.contains('hidden')) {
                        menuOverlay.classList.add('hidden');
                        document.body.style.overflow = '';
                        isMenuOpen = false;
                    }
                });

            } catch (error) {
                console.error('Error initializing menu:', error);
            }
        }

        function initMobileNavigation() {
            try {
                const navItems = document.querySelectorAll('.mobile-nav-item, .fab');

                navItems.forEach(item => {
                    if (!item) return;

                    // Ripple effect on touch/click
                    item.addEventListener('click', function(e) {
                        try {
                            createRipple(e, this);

                            // Haptic feedback (if supported)
                            if (navigator.vibrate) {
                                navigator.vibrate(30);
                            }
                        } catch (error) {
                            console.warn('Error in mobile nav click:', error);
                        }
                    });

                    // Enhanced touch feedback
                    item.addEventListener('touchstart', function() {
                        try {
                            this.style.transform = this.classList.contains('fab') ?
                                'translateY(-6px) scale(0.95)' : 'scale(0.95)';
                        } catch (error) {
                            console.warn('Error in touch start:', error);
                        }
                    }, { passive: true });

                    item.addEventListener('touchend', function() {
                        try {
                            setTimeout(() => {
                                this.style.transform = this.classList.contains('fab') ?
                                    'translateY(-4px)' : '';
                            }, 150);
                        } catch (error) {
                            console.warn('Error in touch end:', error);
                        }
                    }, { passive: true });
                });
            } catch (error) {
                console.error('Error initializing mobile navigation:', error);
            }
        }

        function createRipple(event, element) {
            try {
                if (!element || !event) return;

                const ripple = document.createElement('span');
                const rect = element.getBoundingClientRect();
                const size = Math.max(rect.width, rect.height);

                let x, y;
                if (event.touches && event.touches.length > 0) {
                    x = event.touches[0].clientX - rect.left;
                    y = event.touches[0].clientY - rect.top;
                } else {
                    x = event.clientX - rect.left;
                    y = event.clientY - rect.top;
                }

                ripple.classList.add('ripple');
                ripple.style.width = ripple.style.height = size + 'px';
                ripple.style.left = (x - size / 2) + 'px';
                ripple.style.top = (y - size / 2) + 'px';

                element.style.position = 'relative';
                element.appendChild(ripple);

                setTimeout(() => {
                    if (ripple && ripple.parentNode) {
                        ripple.remove();
                    }
                }, 600);
            } catch (error) {
                console.warn('Error creating ripple:', error);
            }
        }

        function initKeyboardShortcuts() {
            try {
                document.addEventListener('keydown', function(e) {
                    try {
                        if (['INPUT', 'TEXTAREA', 'SELECT'].includes(document.activeElement.tagName)) return;

                        const shortcuts = {
                            '1': 'dashboard',
                            '2': 'library',
                            '3': 'new_entry',
                            '4': 'biography',
                            '5': 'insights'
                        };

                        if (shortcuts[e.key]) {
                            e.preventDefault();
                            const link = document.querySelector(`a[href*="${shortcuts[e.key]}"]`);
                            if (link) link.click();
                        }

                        // Ctrl/Cmd + M for menu
                        if ((e.ctrlKey || e.metaKey) && e.key === 'm') {
                            e.preventDefault();
                            const menuBtn = document.getElementById('menuToggleBtn');
                            if (menuBtn) {
                                menuBtn.click();
                            }
                        }
                    } catch (error) {
                        console.warn('Error in keyboard shortcut:', error);
                    }
                });
            } catch (error) {
                console.error('Error initializing keyboard shortcuts:', error);
            }
        }

        function initPageTransitions() {
            try {
                const links = document.querySelectorAll('a[href^="/"]');
                links.forEach(link => {
                    if (!link) return;

                    // Skip logo links and other important navigation
                    if (link.classList.contains('logo-container') ||
                        link.closest('.logo-container') ||
                        link.getAttribute('href') === '/' ||
                        link.getAttribute('href').includes('dashboard')) {
                        return; // Don't interfere with these links
                    }

                    if (!link.getAttribute('href').includes('://') &&
                        !link.getAttribute('href').startsWith('#') &&
                        link.getAttribute('target') !== '_blank') {

                        link.addEventListener('click', function(e) {
                            try {
                                if (e.metaKey || e.ctrlKey || e.shiftKey) return;

                                const href = this.getAttribute('href');
                                if (href && href !== window.location.pathname) {
                                    document.body.style.opacity = '0.8';
                                    document.body.style.transition = 'opacity 0.2s ease';
                                }
                            } catch (error) {
                                console.warn('Error in page transition:', error);
                            }
                        });
                    }
                });
            } catch (error) {
                console.error('Error initializing page transitions:', error);
            }
        }

        function initToastSystem() {
            try {
                window.showToast = function(message, type = 'info', duration = 4000) {
                    try {
                        const toast = document.createElement('div');
                        toast.className = `glass-card p-4 max-w-md pointer-events-auto border-l-4 ${type === 'success' ? 'border-l-green-500' : type === 'error' ? 'border-l-red-500' : type === 'warning' ? 'border-l-yellow-500' : 'border-l-blue-500'}`;

                        const icons = {
                            success: '<svg class="h-5 w-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>',
                            error: '<svg class="h-5 w-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>',
                            warning: '<svg class="h-5 w-5 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>',
                            info: '<svg class="h-5 w-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>'
                        };

                        toast.innerHTML = `
                            <div class="flex items-start gap-3">
                                <div class="flex-shrink-0 mt-0.5">
                                    ${icons[type] || icons.info}
                                </div>
                                <div class="flex-1">
                                    <p class="font-medium text-secondary-800">${message}</p>
                                </div>
                                <button onclick="this.closest('.glass-card').remove()" class="flex-shrink-0 text-secondary-400 hover:text-secondary-600 transition-colors">
                                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                        `;

                        const container = document.getElementById('toastContainer');
                        if (container) {
                            container.appendChild(toast);

                            // Animate in
                            setTimeout(() => toast.style.transform = 'translateX(0)', 100);

                            // Auto remove
                            setTimeout(() => {
                                if (toast && toast.parentNode) {
                                    toast.style.opacity = '0';
                                    toast.style.transform = 'translateX(100%)';
                                    setTimeout(() => {
                                        if (toast && toast.parentNode) {
                                            toast.remove();
                                        }
                                    }, 300);
                                }
                            }, duration);
                        }
                    } catch (error) {
                        console.error('Error showing toast:', error);
                    }
                };
            } catch (error) {
                console.error('Error initializing toast system:', error);
            }
        }

        // Enhanced mobile stability and scroll prevention
        function initMobileStability() {
            try {
                // Prevent horizontal scrolling aggressively
                function preventHorizontalScroll() {
                    if (window.scrollX !== 0) {
                        window.scrollTo(0, window.scrollY);
                    }
                }

                // Multiple event listeners for scroll prevention
                window.addEventListener('scroll', preventHorizontalScroll, { passive: true });
                window.addEventListener('touchmove', function(e) {
                    // Allow vertical scrolling but prevent horizontal
                    const touch = e.touches[0];
                    if (touch) {
                        const deltaX = Math.abs(touch.clientX - (touch.startX || touch.clientX));
                        const deltaY = Math.abs(touch.clientY - (touch.startY || touch.clientY));

                        // If horizontal movement is greater than vertical, prevent it
                        if (deltaX > deltaY && deltaX > 10) {
                            e.preventDefault();
                        }
                    }
                }, { passive: false });

                // Prevent zoom on double tap
                let lastTouchEnd = 0;
                document.addEventListener('touchend', function(event) {
                    const now = (new Date()).getTime();
                    if (now - lastTouchEnd <= 300) {
                        event.preventDefault();
                    }
                    lastTouchEnd = now;
                }, { passive: false });

                // Handle orientation changes
                window.addEventListener('orientationchange', function() {
                    setTimeout(() => {
                        // Reset any horizontal scroll after orientation change
                        window.scrollTo(0, window.scrollY);

                        // Ensure viewport is properly sized
                        const viewport = document.querySelector('meta[name="viewport"]');
                        if (viewport) {
                            viewport.setAttribute('content', 'width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0, viewport-fit=cover');
                        }
                    }, 100);
                });

                // Prevent elastic scrolling on iOS
                if (navigator.userAgent.match(/iPhone|iPad|iPod/)) {
                    document.body.addEventListener('touchstart', function(e) {
                        if (e.touches.length === 1) {
                            const touch = e.touches[0];
                            touch.startX = touch.clientX;
                            touch.startY = touch.clientY;
                        }
                    }, { passive: true });

                    document.body.addEventListener('touchmove', function(e) {
                        const touch = e.touches[0];
                        if (touch && touch.startX !== undefined) {
                            const deltaX = touch.clientX - touch.startX;
                            const deltaY = touch.clientY - touch.startY;

                            // Prevent horizontal swipe gestures
                            if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 30) {
                                e.preventDefault();
                            }
                        }
                    }, { passive: false });
                }

                // Ensure containers don't overflow
                function fixContainerOverflow() {
                    const containers = document.querySelectorAll('.container, main, .mobile-menu, .glass-nav');
                    containers.forEach(container => {
                        if (container) {
                            container.style.maxWidth = '100vw';
                            container.style.overflowX = 'hidden';
                        }
                    });
                }

                fixContainerOverflow();

                // Re-check container overflow periodically
                setInterval(fixContainerOverflow, 5000);

                // Force scroll position on page load
                setTimeout(() => {
                    window.scrollTo(0, window.scrollY);
                }, 100);

            } catch (error) {
                console.error('Error initializing mobile stability:', error);
            }
        }

        // Handle page visibility and cleanup
        document.addEventListener('visibilitychange', function() {
            try {
                const fab = document.querySelector('.fab');
                if (fab) {
                    fab.style.animationPlayState = document.hidden ? 'paused' : 'running';
                }
            } catch (error) {
                console.warn('Error handling visibility change:', error);
            }
        });

        // Handle page show event (back button, etc.)
        window.addEventListener('pageshow', function(event) {
            try {
                // Reset body styles
                document.body.style.opacity = '1';
                document.body.style.overflow = '';

                // Reset menu state if needed
                const menuOverlay = document.getElementById('menuOverlay');
                if (menuOverlay && !menuOverlay.classList.contains('hidden')) {
                    menuOverlay.classList.add('hidden');
                }
            } catch (error) {
                console.warn('Error handling page show:', error);
            }
        });

        // Global error handler to prevent JS errors from breaking functionality
        window.addEventListener('error', function(event) {
            console.warn('Global error caught:', event.error);
            // Don't show user notifications for JS errors in production
            // but log them for debugging
        });

        // Global utilities with error handling
        window.DiaryVault = {
            showToast: function(message, type, duration) {
                try {
                    if (window.showToast) {
                        window.showToast(message, type, duration);
                    }
                } catch (error) {
                    console.error('Error showing toast:', error);
                }
            },
            createRipple: function(event, element) {
                try {
                    createRipple(event, element);
                } catch (error) {
                    console.warn('Error creating ripple:', error);
                }
            },
            version: '2.1-stable'
        };

        // Ensure menu functionality works across page navigations
        function ensureMenuFunctionality() {
            const menuToggleBtn = document.getElementById('menuToggleBtn');
            if (menuToggleBtn && !menuToggleBtn.hasAttribute('data-initialized')) {
                initMenuSystem();
                menuToggleBtn.setAttribute('data-initialized', 'true');
            }
        }

        // Check menu functionality periodically (fallback)
        setInterval(ensureMenuFunctionality, 2000);
    </script>

    {% block extra_js %}{% endblock %}
</body>
</html>
