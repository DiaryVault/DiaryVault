{% extends 'base.html' %}
{% load static %}

{% block title %}Your Biography | DiaryVault{% endblock %}

{% block extra_css %}
<style>
  .chapter-navigation {
    position: sticky;
    top: 5rem;
  }

  .chapter-link {
    transition: all 0.2s ease;
  }

  .chapter-link:hover {
    transform: translateX(5px);
  }

  .chapter-link.active {
    font-weight: 600;
    color: #6366f1;
    border-right: 3px solid #6366f1;
  }

  .chapter-content {
    scroll-margin-top: 100px;
  }

  .biography-container {
    font-family: 'Playfair Display', serif;
    line-height: 1.8;
  }

  .auto-chapter {
    display: none;
  }
</style>
{% endblock %}

{% block content %}
<div class="w-full max-w-6xl mx-auto">

  <!-- Biography Header Section -->
  <div class="mb-8 text-center">
    <h1 class="text-3xl md:text-4xl font-bold diary-font mb-4">Your Life Story</h1>
    <p class="text-gray-600 max-w-3xl mx-auto">
      Turn your journal entries into a beautifully crafted biography that tells your life story.
      {% if entry_count > 0 %}
      Based on {{ entry_count }} journal entries from {{ date_range }}.
      {% else %}
      Start by adding journal entries to create your story.
      {% endif %}
    </p>
  </div>

  <!-- No Biography Yet - Initial State -->
  {% if not biography %}
  <div class="bg-white rounded-xl shadow-md p-6 md:p-10 max-w-3xl mx-auto text-center">
    <img src="{% static 'images/book-illustration.svg' %}" alt="Biography Book" class="h-48 mx-auto mb-6">

    <h2 class="text-2xl font-bold mb-4 diary-font">Your Journal, Your Story</h2>

    <p class="text-gray-600 mb-6">
      Let DiaryVault analyze your journal entries and transform them into a comprehensive biography.
      The more you journal, the richer your story will be!
    </p>

    {% if entry_count > 0 %}
      <form method="post" action="{% url 'biography' %}">
        {% csrf_token %}
        <button type="submit" name="generate_biography" class="btn-gradient px-6 py-3 rounded-lg text-white font-medium">
          Generate My Biography
        </button>
      </form>
    {% else %}
      <a href="{% url 'new_entry' %}" class="btn-gradient px-6 py-3 rounded-lg text-white font-medium inline-block">
        Start Journaling First
      </a>
      <p class="text-sm text-gray-500 mt-4">
        Add a few journal entries first so we have content to work with.
      </p>
    {% endif %}
  </div>
  {% else %}

  <!-- Biography Exists - Show Content -->
  <div class="flex flex-col md:flex-row gap-8">

    <!-- Chapter Navigation (only shown if chapters exist) -->
    {% if chapters %}
    <div class="md:w-1/4 chapter-navigation">
      <div class="bg-white rounded-xl shadow-md p-4 sticky top-24">
        <h3 class="font-bold mb-4 text-gray-700">Chapters</h3>
        <ul>
          <li class="mb-2">
            <a href="#full-story" class="chapter-link block py-2 px-3 rounded hover:bg-gray-50 active">
              Full Biography
            </a>
          </li>
          {% for chapter in chapters %}
          <li class="mb-2">
            <a href="#chapter-{{ chapter.id }}" class="chapter-link block py-2 px-3 rounded hover:bg-gray-50">
              {{ chapter.title }}
            </a>
          </li>
          {% endfor %}
        </ul>

        <div class="mt-6 pt-4 border-t border-gray-100">
          <form method="post" action="{% url 'biography' %}">
            {% csrf_token %}
            <button type="submit" name="generate_biography" class="text-sm text-secondary-600 hover:text-secondary-800 flex items-center gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
              </svg>
              Refresh Biography
            </button>
          </form>
        </div>
      </div>
    </div>
    {% endif %}

    <!-- Biography Content -->
    <div class="{% if chapters %}md:w-3/4{% endif %}">
      <!-- Full Biography Section -->
      <section id="full-story" class="biography-container bg-white rounded-xl shadow-md p-6 md:p-10 mb-8">
        <h2 class="text-2xl font-bold mb-6 diary-font">Your Life Story</h2>

        <div class="prose prose-lg max-w-none">
          {{ biography|linebreaks }}
        </div>

        <div class="mt-8 text-right">
          <form method="post" action="{% url 'biography' %}">
            {% csrf_token %}
            <button type="submit" name="generate_biography" class="text-secondary-600 hover:text-secondary-800 flex items-center gap-2 ml-auto">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
              </svg>
              Regenerate
            </button>
          </form>
        </div>
      </section>

      <!-- Individual Chapters (only shown if chapter content exists) -->
      {% for chapter in chapters %}
        {% for key, value in chapter_contents.items %}
          {% if key == chapter.title %}
          <section id="chapter-{{ chapter.id }}" class="biography-container bg-white rounded-xl shadow-md p-6 md:p-10 mb-8 chapter-content">
            <h2 class="text-2xl font-bold mb-6 diary-font">{{ chapter.title }}</h2>
            <div class="text-sm text-gray-500 mb-4">{{ chapter.time_period }}</div>

            <div class="prose prose-lg max-w-none">
              {{ value|linebreaks }}
            </div>

            <div class="mt-8 text-right">
              <a href="{% url 'regenerate_chapter' chapter.id %}" class="text-secondary-600 hover:text-secondary-800 flex items-center gap-2 ml-auto">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
                Refresh Chapter
              </a>
            </div>
          </section>
          {% endif %}
        {% endfor %}
      {% endfor %}
    </div>
  </div>
  {% endif %}
</div>

<!-- JavaScript for chapter navigation -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Chapter navigation highlighting
  const chapterLinks = document.querySelectorAll('.chapter-link');
  const chapterSections = document.querySelectorAll('section[id^="chapter-"], #full-story');

  // Highlight active chapter on scroll
  window.addEventListener('scroll', function() {
    let currentChapter = '';

    chapterSections.forEach(section => {
      const sectionTop = section.offsetTop;
      const sectionHeight = section.clientHeight;

      if (window.pageYOffset >= (sectionTop - 150) &&
          window.pageYOffset < (sectionTop + sectionHeight - 150)) {
        currentChapter = section.getAttribute('id');
      }
    });

    chapterLinks.forEach(link => {
      link.classList.remove('active');

      if (link.getAttribute('href') === '#' + currentChapter) {
        link.classList.add('active');
      }
    });
  });

  // Smooth scroll to chapter when clicking nav link
  chapterLinks.forEach(link => {
    link.addEventListener('click', function(e) {
      e.preventDefault();

      const targetId = this.getAttribute('href').substring(1);
      const targetSection = document.getElementById(targetId);

      window.scrollTo({
        top: targetSection.offsetTop - 100,
        behavior: 'smooth'
      });

      chapterLinks.forEach(l => l.classList.remove('active'));
      this.classList.add('active');
    });
  });
});
</script>
{% endblock %}
