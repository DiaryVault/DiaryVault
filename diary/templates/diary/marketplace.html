{% extends "base.html" %}
{% load static %}

{% block title %}DiaryVault - Journal Marketplace{% endblock %}

{% block extra_css %}
<style>
  /* Enhanced Typography & Fonts */
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Playfair+Display:wght@400;500;600;700&display=swap');

  * {
    box-sizing: border-box;
  }

  :root {
    --primary-gradient: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #d946ef 100%);
    --glass-bg: rgba(255, 255, 255, 0.7);
    --glass-border: rgba(255, 255, 255, 0.18);
    --shadow-soft: 0 8px 32px rgba(31, 38, 135, 0.37);
    --shadow-hover: 0 20px 40px rgba(31, 38, 135, 0.4);
    --border-radius: 20px;
    --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    --text-primary: #1f2937;
    --text-secondary: #6b7280;
    --accent-color: #6366f1;
  }

  body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    font-weight: 400;
    line-height: 1.6;
    color: var(--text-primary);
    background: linear-gradient(135deg, #f0f9ff 0%, #fafafa 50%, #f3e8ff 100%);
    min-height: 100vh;
  }

  .diary-font {
    font-family: 'Playfair Display', serif;
    font-weight: 600;
    letter-spacing: -0.025em;
  }

  /* Enhanced Glass Morphism */
  .glass-effect {
    background: var(--glass-bg);
    backdrop-filter: blur(24px);
    -webkit-backdrop-filter: blur(24px);
    border: 1px solid var(--glass-border);
    box-shadow: var(--shadow-soft);
    border-radius: var(--border-radius);
    transition: var(--transition);
  }

  .glass-effect:hover {
    background: rgba(255, 255, 255, 0.85);
    transform: translateY(-4px);
    box-shadow: var(--shadow-hover);
  }

  /* Modern Button System */
  .btn-modern {
    position: relative;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 12px 24px;
    font-weight: 600;
    font-size: 14px;
    border-radius: 12px;
    border: none;
    cursor: pointer;
    transition: var(--transition);
    text-decoration: none;
    overflow: hidden;
  }

  .btn-primary {
    background: var(--primary-gradient);
    color: white;
    box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
  }

  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
  }

  .btn-secondary {
    background: rgba(255, 255, 255, 0.9);
    color: var(--text-primary);
    border: 1px solid rgba(0, 0, 0, 0.1);
  }

  .btn-secondary:hover {
    background: white;
    transform: translateY(-1px);
  }

  .btn-ghost {
    background: transparent;
    color: var(--text-secondary);
    border: 1px solid rgba(0, 0, 0, 0.1);
  }

  .btn-ghost:hover {
    background: rgba(255, 255, 255, 0.5);
    color: var(--text-primary);
  }

  /* Enhanced Floating Actions */
  .floating-actions {
    position: fixed;
    top: 50%;
    right: 24px;
    transform: translateY(-50%);
    z-index: 100;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .floating-btn {
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: var(--glass-bg);
    backdrop-filter: blur(20px);
    border: 1px solid var(--glass-border);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: var(--transition);
    position: relative;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
  }

  .floating-btn:hover {
    transform: scale(1.1);
    background: rgba(255, 255, 255, 0.9);
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
  }

  .floating-btn .badge {
    position: absolute;
    top: -6px;
    right: -6px;
    background: linear-gradient(135deg, #ef4444, #dc2626);
    color: white;
    border-radius: 50%;
    width: 22px;
    height: 22px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    font-weight: 700;
    animation: pulse 2s infinite;
    box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
  }

  /* Enhanced Search Section */
  .search-container {
    position: relative;
    max-width: 700px;
    margin: 0 auto;
  }

  .search-input {
    width: 100%;
    padding: 20px 24px 20px 60px;
    border-radius: 50px;
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(20px);
    border: 2px solid transparent;
    font-size: 16px;
    font-weight: 500;
    transition: var(--transition);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    outline: none;
  }

  .search-input:focus {
    border-color: var(--accent-color);
    background: white;
    box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1), 0 8px 32px rgba(0, 0, 0, 0.15);
  }

  .search-input::placeholder {
    color: var(--text-secondary);
    font-weight: 400;
  }

  .search-icon {
    position: absolute;
    left: 24px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-secondary);
    z-index: 10;
  }

  /* Enhanced Product Cards */
  .product-card {
    background: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(20px);
    border-radius: 24px;
    overflow: hidden;
    border: 1px solid rgba(255, 255, 255, 0.2);
    transition: var(--transition);
    position: relative;
    cursor: pointer;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
  }

  .product-card:hover {
    transform: translateY(-8px);
    background: rgba(255, 255, 255, 0.95);
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
    border-color: rgba(99, 102, 241, 0.2);
  }

  .product-image {
    position: relative;
    height: 220px;
    overflow: hidden;
    border-radius: 20px 20px 0 0;
  }

  .product-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.5s ease;
  }

  .product-card:hover .product-image img {
    transform: scale(1.05);
  }

  .quick-actions {
    position: absolute;
    top: 16px;
    left: 16px;
    display: flex;
    flex-direction: column;
    gap: 8px;
    opacity: 0;
    transform: translateX(-20px);
    transition: var(--transition);
  }

  .product-card:hover .quick-actions {
    opacity: 1;
    transform: translateX(0);
  }

  .quick-action-btn {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    display: flex;
    align-items: center;
    justify-content: center;
    transition: var(--transition);
    border: 1px solid rgba(255, 255, 255, 0.3);
    cursor: pointer;
  }

  .quick-action-btn:hover {
    transform: scale(1.1);
    background: white;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }

  .product-content {
    padding: 24px;
  }

  .product-title {
    font-size: 18px;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 8px;
    line-height: 1.4;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .product-description {
    color: var(--text-secondary);
    font-size: 14px;
    line-height: 1.5;
    margin-bottom: 16px;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .author-info {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 16px;
    padding: 12px;
    background: rgba(99, 102, 241, 0.05);
    border-radius: 12px;
  }

  .author-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: var(--primary-gradient);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 14px;
  }

  .author-details h4 {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-primary);
    margin: 0;
  }

  .author-details p {
    font-size: 12px;
    color: var(--text-secondary);
    margin: 0;
  }

  .product-rating {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 16px;
  }

  .rating-stars {
    display: flex;
    gap: 2px;
  }

  .star {
    width: 14px;
    height: 14px;
    fill: #fbbf24;
  }

  .product-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-bottom: 20px;
  }

  .tag {
    padding: 4px 12px;
    background: rgba(99, 102, 241, 0.1);
    color: var(--accent-color);
    border-radius: 20px;
    font-size: 12px;
    font-weight: 500;
  }

  .product-footer {
    display: flex;
    align-items: center;
    justify-content: between;
    gap: 16px;
  }

  .price-section {
    flex: 1;
  }

  .price {
    font-size: 24px;
    font-weight: 800;
    color: #059669;
    margin: 0;
  }

  .price.free {
    color: var(--accent-color);
  }

  .price-subtitle {
    font-size: 12px;
    color: var(--text-secondary);
    margin: 0;
  }

  /* Enhanced Category Cards */
  .category-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 20px;
  }

  .category-card {
    background: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(20px);
    border-radius: 20px;
    padding: 24px;
    text-align: center;
    transition: var(--transition);
    border: 1px solid rgba(255, 255, 255, 0.3);
    position: relative;
    overflow: hidden;
    cursor: pointer;
  }

  .category-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: var(--primary-gradient);
    transform: scaleX(0);
    transition: transform 0.3s ease;
    transform-origin: left;
  }

  .category-card:hover::before {
    transform: scaleX(1);
  }

  .category-card:hover {
    transform: translateY(-6px);
    background: rgba(255, 255, 255, 0.95);
    box-shadow: 0 16px 40px rgba(0, 0, 0, 0.12);
  }

  .category-icon {
    width: 60px;
    height: 60px;
    border-radius: 16px;
    background: var(--primary-gradient);
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 16px;
    transition: transform 0.3s ease;
  }

  .category-card:hover .category-icon {
    transform: scale(1.1) rotate(5deg);
  }

  .category-title {
    font-size: 16px;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 6px;
  }

  .category-count {
    font-size: 13px;
    color: var(--text-secondary);
  }

  /* Enhanced Filters */
  .filters-section {
    background: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(20px);
    border-radius: 20px;
    padding: 24px;
    border: 1px solid rgba(255, 255, 255, 0.3);
    margin-bottom: 24px;
  }

  .filter-controls {
    display: flex;
    flex-wrap: wrap;
    gap: 16px;
    align-items: center;
    justify-content: space-between;
  }

  .filter-group {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .select-modern {
    background: rgba(255, 255, 255, 0.9);
    border: 1px solid rgba(0, 0, 0, 0.1);
    border-radius: 12px;
    padding: 12px 16px;
    font-size: 14px;
    font-weight: 500;
    color: var(--text-primary);
    cursor: pointer;
    transition: var(--transition);
    outline: none;
  }

  .select-modern:focus {
    border-color: var(--accent-color);
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
  }

  /* Shopping Cart Sidebar */
  .cart-sidebar {
    position: fixed;
    top: 0;
    right: 0;
    height: 100vh;
    width: 420px;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(30px);
    border-left: 1px solid rgba(255, 255, 255, 0.2);
    box-shadow: -10px 0 50px rgba(0, 0, 0, 0.1);
    transform: translateX(100%);
    transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 200;
    overflow-y: auto;
  }

  .cart-sidebar.open {
    transform: translateX(0);
  }

  .cart-header {
    padding: 24px;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    background: rgba(255, 255, 255, 0.8);
    position: sticky;
    top: 0;
    z-index: 10;
  }

  .cart-item {
    background: rgba(255, 255, 255, 0.6);
    border-radius: 16px;
    padding: 16px;
    margin-bottom: 12px;
    border: 1px solid rgba(255, 255, 255, 0.3);
    transition: var(--transition);
  }

  .cart-item:hover {
    background: rgba(255, 255, 255, 0.8);
    transform: translateY(-2px);
  }

  /* Enhanced Animations */
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes slideInRight {
    from {
      opacity: 0;
      transform: translateX(30px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }

  @keyframes pulse {
    0%, 100% {
      transform: scale(1);
    }
    50% {
      transform: scale(1.05);
    }
  }

  @keyframes shimmer {
    0% {
      background-position: -200px 0;
    }
    100% {
      background-position: 200px 0;
    }
  }

  .animate-fade-in-up {
    animation: fadeInUp 0.8s ease forwards;
  }

  .animate-slide-in-right {
    animation: slideInRight 0.6s ease forwards;
  }

  .skeleton {
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200px 100%;
    animation: shimmer 1.5s infinite;
  }

  /* Toast Notifications */
  .toast {
    position: fixed;
    top: 24px;
    right: 24px;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border-radius: 16px;
    padding: 16px 20px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
    border: 1px solid rgba(255, 255, 255, 0.3);
    z-index: 1000;
    animation: slideInRight 0.3s ease;
    display: flex;
    align-items: center;
    gap: 12px;
    max-width: 350px;
  }

  .toast.success {
    border-left: 4px solid #10b981;
  }

  .toast.error {
    border-left: 4px solid #ef4444;
  }

  .toast.warning {
    border-left: 4px solid #f59e0b;
  }

  /* Mobile Optimizations */
  @media (max-width: 768px) {
    .floating-actions {
      position: fixed;
      bottom: 24px;
      right: 16px;
      top: auto;
      transform: none;
      flex-direction: row;
      gap: 12px;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(20px);
      padding: 12px;
      border-radius: 20px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .floating-btn {
      width: 48px;
      height: 48px;
      background: transparent;
      border: none;
      box-shadow: none;
    }

    .search-input {
      padding: 16px 20px 16px 50px;
      font-size: 16px; /* Prevent zoom on iOS */
    }

    .search-icon {
      left: 20px;
    }

    .product-card .quick-actions {
      opacity: 1;
      transform: translateX(0);
      position: relative;
      top: auto;
      left: auto;
      flex-direction: row;
      justify-content: center;
      margin-bottom: 16px;
    }

    .category-grid {
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }

    .category-card {
      padding: 20px 16px;
    }

    .cart-sidebar {
      width: 100vw;
    }

    .filter-controls {
      flex-direction: column;
      align-items: stretch;
      gap: 12px;
    }

    .filter-group {
      flex-wrap: wrap;
      justify-content: center;
    }

    .btn-modern {
      padding: 14px 20px;
      font-size: 16px;
      width: 100%;
      justify-content: center;
    }

    .product-footer {
      flex-direction: column;
      align-items: stretch;
      gap: 12px;
    }

    .toast {
      top: auto;
      bottom: 100px;
      right: 16px;
      left: 16px;
      max-width: none;
    }
  }

  @media (max-width: 480px) {
    .floating-actions {
      bottom: 80px;
      right: 50%;
      transform: translateX(50%);
    }

    .product-content {
      padding: 20px;
    }

    .category-grid {
      grid-template-columns: 1fr;
    }
  }

  /* Dark Mode Support */
  @media (prefers-color-scheme: dark) {
    :root {
      --text-primary: #f9fafb;
      --text-secondary: #9ca3af;
      --glass-bg: rgba(17, 24, 39, 0.8);
      --glass-border: rgba(255, 255, 255, 0.1);
    }

    body {
      background: linear-gradient(135deg, #111827 0%, #1f2937 50%, #374151 100%);
      color: var(--text-primary);
    }

    .product-card,
    .category-card,
    .glass-effect {
      background: rgba(17, 24, 39, 0.8);
      color: var(--text-primary);
    }

    .search-input,
    .select-modern {
      background: rgba(17, 24, 39, 0.8);
      color: var(--text-primary);
      border-color: rgba(255, 255, 255, 0.1);
    }

    .author-info {
      background: rgba(99, 102, 241, 0.1);
    }
  }

  /* Focus Styles for Accessibility */
  *:focus {
    outline: 2px solid var(--accent-color);
    outline-offset: 2px;
  }

  .btn-modern:focus,
  .floating-btn:focus,
  .quick-action-btn:focus {
    outline: 2px solid var(--accent-color);
    outline-offset: 2px;
  }

  /* High Contrast Mode Support */
  @media (prefers-contrast: high) {
    .glass-effect {
      background: rgba(255, 255, 255, 0.95);
      border: 2px solid #000;
    }

    .btn-primary {
      background: #000;
      border: 2px solid #000;
    }

    .product-card {
      border: 2px solid #000;
    }
  }

  /* Reduced Motion Support */
  @media (prefers-reduced-motion: reduce) {
    *,
    *::before,
    *::after {
      animation-duration: 0.01ms !important;
      animation-iteration-count: 1 !important;
      transition-duration: 0.01ms !important;
    }
  }

  /* Loading States */
  .loading {
    position: relative;
    overflow: hidden;
  }

  .loading::after {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    bottom: 0;
    left: 0;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
    animation: shimmer 2s infinite;
  }

  /* Scroll Improvements */
  html {
    scroll-behavior: smooth;
  }

  ::-webkit-scrollbar {
    width: 8px;
  }

  ::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.1);
    border-radius: 4px;
  }

  ::-webkit-scrollbar-thumb {
    background: rgba(99, 102, 241, 0.3);
    border-radius: 4px;
  }

  ::-webkit-scrollbar-thumb:hover {
    background: rgba(99, 102, 241, 0.5);
  }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen">
  <!-- Enhanced Floating Actions -->
  {% if user.is_authenticated %}
  <div class="floating-actions">
    <button onclick="toggleCart()" class="floating-btn" title="Shopping Cart" aria-label="Open shopping cart">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4m2.6 8L6 4H2m5 9v6a1 1 0 001 1h9a1 1 0 001-1v-6M9 19a1 1 0 102 0M20 19a1 1 0 10-2 0" />
      </svg>
      <span id="cartCount" class="badge">0</span>
    </button>

    <button onclick="toggleWishlist()" class="floating-btn" title="Wishlist" aria-label="Open wishlist">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
      </svg>
      <span id="wishlistCount" class="badge">0</span>
    </button>

    <button onclick="toggleCompare()" class="floating-btn" title="Compare" aria-label="Compare journals">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
      </svg>
      <span id="compareCount" class="badge">0</span>
    </button>
  </div>
  {% endif %}

  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

    <!-- Enhanced Hero Search Section -->
    <div class="mb-16 animate-fade-in-up">
      <div class="text-center mb-12">
        <h1 class="text-4xl md:text-6xl font-bold diary-font mb-6 bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-600 bg-clip-text text-transparent">
          Discover Amazing Stories
        </h1>
        <p class="text-xl md:text-2xl text-gray-600 max-w-3xl mx-auto font-light">
          Explore authentic journals from writers around the world. Find inspiration, share experiences, and connect through stories.
        </p>
      </div>

      <div class="glass-effect p-8 mb-8">
        <form method="GET" action="{% url 'marketplace' %}" class="space-y-6">
          <!-- Main Search -->
          <div class="search-container">
            <input type="text" name="search" value="{{ search_query }}"
                   placeholder="Search journals, authors, topics..."
                   class="search-input"
                   aria-label="Search journals">
            <svg xmlns="http://www.w3.org/2000/svg" class="search-icon h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
          </div>

          <!-- Enhanced Filter Controls -->
          <div class="filter-controls">
            <div class="filter-group">
              <select name="sort" class="select-modern" aria-label="Sort by">
                <option value="trending" {% if current_sort == 'trending' %}selected{% endif %}>🔥 Trending Now</option>
                <option value="newest" {% if current_sort == 'newest' %}selected{% endif %}>🆕 Just Published</option>
                <option value="topRated" {% if current_sort == 'topRated' %}selected{% endif %}>⭐ Highly Rated</option>
                <option value="bestSelling" {% if current_sort == 'bestSelling' %}selected{% endif %}>💰 Best Sellers</option>
                <option value="priceLow" {% if current_sort == 'priceLow' %}selected{% endif %}>💲 Price: Low to High</option>
                <option value="priceHigh" {% if current_sort == 'priceHigh' %}selected{% endif %}>💲 Price: High to Low</option>
              </select>

              <button type="button" onclick="toggleFilters()" class="btn-secondary" aria-label="Toggle filters">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
                </svg>
                Filters
                <span class="bg-indigo-500 text-white text-xs rounded-full w-6 h-6 flex items-center justify-center ml-2" id="activeFiltersCount">0</span>
              </button>
            </div>

            <button type="submit" class="btn-primary">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
              </svg>
              Search Journals
            </button>
          </div>

          <!-- Advanced Filters (Hidden by default) -->
          <div id="advancedFilters" class="hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 pt-6 border-t border-gray-200">
              <!-- Price Range -->
              <div class="space-y-3">
                <label class="block text-sm font-semibold text-gray-700">Price Range</label>
                <input type="range" name="maxPrice" min="0" max="50" value="{{ request.GET.maxPrice|default:'50' }}"
                       class="w-full h-2 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-lg appearance-none cursor-pointer"
                       oninput="document.getElementById('maxPriceValue').textContent = this.value">
                <div class="flex justify-between text-sm text-gray-600">
                  <span>Free</span>
                  <span>$<span id="maxPriceValue">{{ request.GET.maxPrice|default:'50' }}</span></span>
                </div>
              </div>

              <!-- Rating Filter -->
              <div class="space-y-3">
                <label class="block text-sm font-semibold text-gray-700">Minimum Rating</label>
                <div class="space-y-2">
                  {% for rating in "54321" %}
                    <label class="flex items-center cursor-pointer">
                      <input type="radio" name="minRating" value="{{ rating }}" {% if request.GET.minRating == rating %}checked{% endif %}
                             class="mr-3 text-indigo-600 focus:ring-indigo-500">
                      <div class="flex items-center gap-2">
                        <div class="flex">
                          {% for i in "12345" %}
                            <svg class="w-4 h-4 {% if forloop.counter <= rating|add:0 %}text-yellow-400{% else %}text-gray-300{% endif %}" fill="currentColor" viewBox="0 0 20 20">
                              <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                            </svg>
                          {% endfor %}
                        </div>
                        <span class="text-sm text-gray-600">& up</span>
                      </div>
                    </label>
                  {% endfor %}
                </div>
              </div>

              <!-- Journal Length -->
              <div class="space-y-3">
                <label class="block text-sm font-semibold text-gray-700">Journal Length</label>
                <div class="space-y-2">
                  <label class="flex items-center cursor-pointer">
                    <input type="checkbox" name="length" value="short" {% if 'short' in request.GET.length %}checked{% endif %}
                           class="mr-3 text-indigo-600 focus:ring-indigo-500 rounded">
                    <span class="text-sm">Short (1-10 entries)</span>
                  </label>
                  <label class="flex items-center cursor-pointer">
                    <input type="checkbox" name="length" value="medium" {% if 'medium' in request.GET.length %}checked{% endif %}
                           class="mr-3 text-indigo-600 focus:ring-indigo-500 rounded">
                    <span class="text-sm">Medium (11-50 entries)</span>
                  </label>
                  <label class="flex items-center cursor-pointer">
                    <input type="checkbox" name="length" value="long" {% if 'long' in request.GET.length %}checked{% endif %}
                           class="mr-3 text-indigo-600 focus:ring-indigo-500 rounded">
                    <span class="text-sm">Long (50+ entries)</span>
                  </label>
                </div>
              </div>

              <!-- Special Offers -->
              <div class="space-y-3">
                <label class="block text-sm font-semibold text-gray-700">Special Offers</label>
                <div class="space-y-2">
                  <label class="flex items-center cursor-pointer">
                    <input type="checkbox" name="offers" value="free" {% if 'free' in request.GET.offers %}checked{% endif %}
                           class="mr-3 text-indigo-600 focus:ring-indigo-500 rounded">
                    <span class="text-sm">Free Journals</span>
                  </label>
                  <label class="flex items-center cursor-pointer">
                    <input type="checkbox" name="offers" value="bestseller" {% if 'bestseller' in request.GET.offers %}checked{% endif %}
                           class="mr-3 text-indigo-600 focus:ring-indigo-500 rounded">
                    <span class="text-sm">Bestsellers</span>
                  </label>
                  <label class="flex items-center cursor-pointer">
                    <input type="checkbox" name="offers" value="new" {% if 'new' in request.GET.offers %}checked{% endif %}
                           class="mr-3 text-indigo-600 focus:ring-indigo-500 rounded">
                    <span class="text-sm">New Releases</span>
                  </label>
                </div>
              </div>
            </div>

            <div class="flex flex-col sm:flex-row justify-between items-center mt-8 pt-6 border-t border-gray-200 gap-4">
              <button type="button" onclick="clearFilters()" class="btn-ghost">
                Clear all filters
              </button>
              <div class="flex gap-3">
                <button type="button" onclick="toggleFilters()" class="btn-secondary">
                  Cancel
                </button>
                <button type="submit" class="btn-primary">
                  Apply Filters
                </button>
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- Enhanced Categories Section -->
    <div class="mb-16 animate-fade-in-up">
      <div class="text-center mb-12">
        <h2 class="text-3xl md:text-4xl font-bold diary-font mb-4">
          Browse by Category
        </h2>
        <p class="text-lg text-gray-600 max-w-2xl mx-auto">
          Discover curated collections of authentic stories from various genres and life experiences.
        </p>
      </div>

      <div class="category-grid">
        {% for category in categories %}
          <a href="{% url 'marketplace' %}?category={{ category.slug }}" class="category-card">
            <div class="category-icon">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" viewBox="0 0 20 20" fill="currentColor">
                <path d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 015.5 14c1.669 0 3.218.51 4.5 1.385A7.962 7.962 0 0114.5 14c1.255 0 2.443.29 3.5.804v-10A7.968 7.968 0 0014.5 4c-1.255 0-2.443.29-3.5.804V12a1 1 0 11-2 0V4.804z" />
              </svg>
            </div>
            <h3 class="category-title">{{ category.name }}</h3>
            <p class="category-count">{{ category.journal_count }} journal{{ category.journal_count|pluralize }}</p>
          </a>
        {% empty %}
          <!-- Default categories when none exist -->
          <div class="category-card">
            <div class="category-icon">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" viewBox="0 0 20 20" fill="currentColor">
                <path d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 015.5 14c1.669 0 3.218.51 4.5 1.385A7.962 7.962 0 0114.5 14c1.255 0 2.443.29 3.5.804v-10A7.968 7.968 0 0014.5 4c-1.255 0-2.443.29-3.5.804V12a1 1 0 11-2 0V4.804z" />
              </svg>
            </div>
            <h3 class="category-title">Personal Growth</h3>
            <p class="category-count">{{ stats.total_journals|default:"0" }} journals</p>
          </div>
        {% endfor %}
      </div>
    </div>

    <!-- Enhanced Results Section -->
    <div class="mb-16">
      <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-8 gap-4">
        <div>
          <h2 class="text-2xl font-bold diary-font text-gray-800">
            {% if search_query %}
              Results for "{{ search_query }}"
            {% elif current_category and current_category != 'all' %}
              {{ current_category|title }} Journals
            {% else %}
              Featured Journals
            {% endif %}
          </h2>
          <p class="text-gray-600 mt-1">{{ total_results|default:journals.count }} result{{ total_results|pluralize }}</p>
        </div>

        <!-- View Toggle -->
        <div class="flex bg-white rounded-xl p-1 border border-gray-200">
          <button onclick="setGridView('grid')" id="gridViewBtn"
                  class="px-4 py-2 rounded-lg bg-indigo-500 text-white transition-colors"
                  aria-label="Grid view">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
            </svg>
          </button>
          <button onclick="setGridView('list')" id="listViewBtn"
                  class="px-4 py-2 rounded-lg text-gray-600 hover:bg-gray-100 transition-colors"
                  aria-label="List view">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16" />
            </svg>
          </button>
        </div>
      </div>

      <!-- Enhanced Products Grid -->
      {% if journals %}
        <div id="productsGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
          {% for journal in journals %}
            <article class="product-card animate-fade-in-up" data-journal-id="{{ journal.id }}"
                     style="animation-delay: {{ forloop.counter0|floatformat:1 }}00ms"
                     onclick="window.location.href='{% url 'marketplace_journal_detail' journal.id %}'">

              <!-- Product Image -->
              <div class="product-image">
                <!-- Quick Actions -->
                <div class="quick-actions">
                  {% if user.is_authenticated %}
                    <button onclick="event.stopPropagation(); toggleWishlist({{ journal.id }})"
                            class="quick-action-btn" title="Add to Wishlist" aria-label="Add to wishlist">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                      </svg>
                    </button>
                    <button onclick="event.stopPropagation(); quickView({{ journal.id }})"
                            class="quick-action-btn" title="Quick View" aria-label="Quick view">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                      </svg>
                    </button>
                  {% endif %}
                </div>

                <!-- Journal Cover -->
                {% if journal.cover_image %}
                  <img src="{{ journal.cover_image.url }}" alt="{{ journal.title }}" class="w-full h-full object-cover">
                {% else %}
                  <div class="w-full h-full bg-gradient-to-br from-indigo-400 via-purple-500 to-pink-500 flex items-center justify-center">
                    <div class="text-white text-center p-6">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                      </svg>
                      <p class="font-medium text-sm">{{ journal.title|truncatewords:4 }}</p>
                    </div>
                  </div>
                {% endif %}

                <!-- Price Badge -->
                <div class="absolute top-4 right-4">
                  {% if journal.price > 0 %}
                    <span class="bg-gradient-to-r from-emerald-500 to-emerald-600 text-white px-3 py-1.5 rounded-full text-sm font-bold shadow-lg">
                      ${{ journal.price }}
                    </span>
                  {% else %}
                    <span class="bg-gradient-to-r from-indigo-500 to-indigo-600 text-white px-3 py-1.5 rounded-full text-sm font-bold shadow-lg">
                      FREE
                    </span>
                  {% endif %}
                </div>

                <!-- Staff Pick Badge -->
                {% if journal.is_staff_pick %}
                  <div class="absolute top-4 left-4">
                    <span class="bg-gradient-to-r from-yellow-400 to-orange-500 text-white px-2 py-1 rounded-lg text-xs font-bold shadow-lg">
                      ⭐ Staff Pick
                    </span>
                  </div>
                {% endif %}
              </div>

              <!-- Product Content -->
              <div class="product-content">
                <!-- Author Info -->
                <div class="author-info">
                  <div class="author-avatar">
                    {{ journal.author.username|first|upper }}
                  </div>
                  <div class="author-details flex-1">
                    <h4>{{ journal.author.get_full_name|default:journal.author.username }}</h4>
                    <p>@{{ journal.author.username }}</p>
                  </div>
                  <div class="text-xs text-gray-500 flex items-center gap-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                    </svg>
                    {{ journal.view_count|default:0 }}
                  </div>
                </div>

                <!-- Title -->
                <h3 class="product-title">{{ journal.title }}</h3>

                <!-- Description -->
                <p class="product-description">{{ journal.description|truncatewords:15 }}</p>

                <!-- Rating -->
                <div class="product-rating">
                  <div class="rating-stars">
                    {% for i in "12345" %}
                      <svg class="star" viewBox="0 0 20 20">
                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                      </svg>
                    {% endfor %}
                  </div>
                  <span class="text-sm text-gray-600">({{ journal.likes.count|default:0 }})</span>
                </div>

                <!-- Tags -->
                <div class="product-tags">
                  {% for tag in journal.marketplace_tags.all|slice:":3" %}
                    <span class="tag">{{ tag.name }}</span>
                  {% empty %}
                    <span class="tag">Journal</span>
                  {% endfor %}
                </div>

                <!-- Product Footer -->
                <div class="product-footer">
                  <div class="price-section">
                    {% if journal.price > 0 %}
                      <p class="price">${{ journal.price }}</p>
                      {% if journal.total_tips > 0 %}
                        <p class="price-subtitle">${{ journal.total_tips|floatformat:0 }} earned</p>
                      {% endif %}
                    {% else %}
                      <p class="price free">FREE</p>
                      <p class="price-subtitle">{{ journal.entries.count|default:0 }} entries</p>
                    {% endif %}
                  </div>

                  {% if user.is_authenticated %}
                    <button onclick="event.stopPropagation(); addToCart({{ journal.id }})"
                            class="btn-primary" aria-label="Add to cart">
                      {% if journal.price > 0 %}Buy Now{% else %}Get Free{% endif %}
                    </button>
                  {% else %}
                    <a href="{% url 'signup' %}" class="btn-primary" onclick="event.stopPropagation();">
                      Sign Up
                    </a>
                  {% endif %}
                </div>
              </div>
            </article>
          {% endfor %}
        </div>

        <!-- Enhanced Pagination -->
        {% if journals.has_other_pages %}
        <nav class="mt-16 flex justify-center" aria-label="Pagination">
          <div class="glass-effect rounded-2xl p-2 flex items-center gap-2">
            {% if journals.has_previous %}
              <a href="?page={{ journals.previous_page_number }}"
                 class="px-4 py-2 rounded-xl text-gray-600 hover:bg-white/50 transition-colors"
                 aria-label="Previous page">
                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
              </a>
            {% endif %}

            {% for i in journals.paginator.page_range %}
              {% if journals.number == i %}
                <span class="px-4 py-2 rounded-xl bg-indigo-500 text-white font-medium" aria-current="page">{{ i }}</span>
              {% else %}
                <a href="?page={{ i }}" class="px-4 py-2 rounded-xl text-gray-600 hover:bg-white/50 transition-colors">{{ i }}</a>
              {% endif %}
            {% endfor %}

            {% if journals.has_next %}
              <a href="?page={{ journals.next_page_number }}"
                 class="px-4 py-2 rounded-xl text-gray-600 hover:bg-white/50 transition-colors"
                 aria-label="Next page">
                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
              </a>
            {% endif %}
          </div>
        </nav>
        {% endif %}

      {% else %}
        <!-- Enhanced Empty State -->
        <div class="text-center py-20">
          <div class="glass-effect rounded-3xl p-16 max-w-2xl mx-auto">
            <div class="w-24 h-24 bg-gradient-to-br from-indigo-400 to-purple-500 rounded-full flex items-center justify-center mx-auto mb-6">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
              </svg>
            </div>
            <h3 class="text-2xl font-bold diary-font text-gray-900 mb-4">No journals found</h3>
            <p class="text-gray-600 mb-8 text-lg">
              {% if search_query %}
                No journals match your search for "{{ search_query }}". Try different keywords or browse our categories.
              {% else %}
                Be the first to share your story and inspire others!
              {% endif %}
            </p>
            <div class="flex flex-col sm:flex-row gap-4 justify-center">
              {% if search_query %}
                <a href="{% url 'marketplace' %}" class="btn-primary">
                  Browse All Journals
                </a>
              {% endif %}
              {% if user.is_authenticated %}
                <a href="{% url 'publish_journal' %}" class="btn-secondary">
                  Publish Your Journal
                </a>
              {% else %}
                <a href="{% url 'signup' %}" class="btn-secondary">
                  Start Selling Your Story
                </a>
              {% endif %}
            </div>
          </div>
        </div>
      {% endif %}
    </div>

  </div>
</div>

<!-- Enhanced Shopping Cart Sidebar -->
{% if user.is_authenticated %}
<div id="cartSidebar" class="cart-sidebar" role="dialog" aria-labelledby="cartTitle" aria-modal="true">
  <div class="cart-header">
    <div class="flex items-center justify-between">
      <h3 id="cartTitle" class="text-xl font-bold text-gray-800">Shopping Cart</h3>
      <button onclick="toggleCart()" class="text-gray-500 hover:text-gray-700 p-2 rounded-full hover:bg-gray-100 transition-colors" aria-label="Close cart">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
  </div>

  <div id="cartItems" class="p-6 flex-1">
    <div class="text-center text-gray-500 py-16">
      <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4m2.6 8L6 4H2m5 9v6a1 1 0 001 1h9a1 1 0 001-1v-6M9 19a1 1 0 102 0M20 19a1 1 0 10-2 0" />
        </svg>
      </div>
      <h4 class="font-semibold text-gray-700 mb-2">Your cart is empty</h4>
      <p class="text-sm">Add some journals to get started!</p>
    </div>
  </div>

  <div id="cartFooter" class="p-6 border-t border-gray-200/50 hidden">
    <div class="flex justify-between items-center mb-6">
      <span class="text-lg font-semibold text-gray-800">Total:</span>
      <span id="cartTotal" class="text-2xl font-bold text-emerald-600">$0.00</span>
    </div>
    <button onclick="checkout()" class="w-full btn-primary py-4 text-lg">
      Proceed to Checkout
    </button>
  </div>
</div>

<!-- Cart Overlay -->
<div id="cartOverlay" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-40 hidden" onclick="toggleCart()"></div>
{% endif %}

<!-- Toast Notification Container -->
<div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>

{% endblock %}

{% block extra_js %}
<script>
// Enhanced JavaScript with better performance and UX
class MarketplaceApp {
  constructor() {
    this.cart = JSON.parse(localStorage.getItem('diaryvault_cart') || '[]');
    this.wishlist = JSON.parse(localStorage.getItem('diaryvault_wishlist') || '[]');
    this.comparison = JSON.parse(localStorage.getItem('diaryvault_comparison') || '[]');
    this.init();
  }

  init() {
    this.updateCounts();
    this.initializeEventListeners();
    this.initializeAnimations();
    this.initializeAccessibility();
  }

  // Toast System
  showToast(message, type = 'info', duration = 4000) {
    const toast = document.createElement('div');
    toast.className = `toast ${type} transform translate-x-full`;

    const icons = {
      success: '✅',
      error: '❌',
      warning: '⚠️',
      info: 'ℹ️'
    };

    toast.innerHTML = `
      <div class="flex items-center gap-3">
        <span class="text-lg" role="img" aria-label="${type}">${icons[type] || icons.info}</span>
        <span class="font-medium">${message}</span>
        <button onclick="this.parentElement.parentElement.remove()" class="ml-auto text-gray-400 hover:text-gray-600" aria-label="Close notification">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
    `;

    const container = document.getElementById('toastContainer');
    container.appendChild(toast);

    // Animate in
    requestAnimationFrame(() => {
      toast.classList.remove('translate-x-full');
    });

    // Auto remove
    setTimeout(() => {
      toast.classList.add('translate-x-full');
      setTimeout(() => toast.remove(), 300);
    }, duration);

    // Announce to screen readers
    const announcement = document.createElement('div');
    announcement.setAttribute('aria-live', 'polite');
    announcement.setAttribute('aria-atomic', 'true');
    announcement.className = 'sr-only';
    announcement.textContent = message;
    document.body.appendChild(announcement);
    setTimeout(() => announcement.remove(), 1000);
  }

  // Cart Management
  addToCart(journalId, title = `Journal ${journalId}`, price = 9.99) {
    const existingItem = this.cart.find(item => item.id === journalId);

    if (!existingItem) {
      this.cart.push({
        id: journalId,
        title: title,
        price: parseFloat(price),
        quantity: 1,
        addedAt: new Date().toISOString()
      });

      this.saveCart();
      this.updateCounts();
      this.animateCartButton();
      this.showToast('Added to cart! 🛒', 'success');
    } else {
      this.showToast('Already in cart!', 'info');
    }
  }

  removeFromCart(journalId) {
    const initialLength = this.cart.length;
    this.cart = this.cart.filter(item => item.id !== journalId);

    if (this.cart.length < initialLength) {
      this.saveCart();
      this.updateCounts();
      this.renderCartItems();
      this.showToast('Removed from cart', 'info');
    }
  }

  saveCart() {
    localStorage.setItem('diaryvault_cart', JSON.stringify(this.cart));
  }

  // Wishlist Management
  toggleWishlist(journalId) {
    const index = this.wishlist.indexOf(journalId);

    if (index === -1) {
      this.wishlist.push(journalId);
      this.showToast('Added to wishlist! ❤️', 'success');
    } else {
      this.wishlist.splice(index, 1);
      this.showToast('Removed from wishlist', 'info');
    }

    localStorage.setItem('diaryvault_wishlist', JSON.stringify(this.wishlist));
    this.updateCounts();
  }

  // Comparison Management
  addToCompare(journalId) {
    if (this.comparison.length >= 4) {
      this.showToast('Maximum 4 items can be compared!', 'warning');
      return;
    }

    if (!this.comparison.includes(journalId)) {
      this.comparison.push(journalId);
      localStorage.setItem('diaryvault_comparison', JSON.stringify(this.comparison));
      this.updateCounts();
      this.showToast('Added to comparison!', 'success');
    }
  }

  // UI Updates
  updateCounts() {
    const cartCount = document.getElementById('cartCount');
    const wishlistCount = document.getElementById('wishlistCount');
    const compareCount = document.getElementById('compareCount');

    if (cartCount) cartCount.textContent = this.cart.length;
    if (wishlistCount) wishlistCount.textContent = this.wishlist.length;
    if (compareCount) compareCount.textContent = this.comparison.length;
  }

  animateCartButton() {
    const cartBtn = document.querySelector('[onclick*="toggleCart"]');
    if (cartBtn) {
      cartBtn.style.transform = 'scale(1.2)';
      cartBtn.style.transition = 'transform 0.2s ease';
      setTimeout(() => {
        cartBtn.style.transform = 'scale(1)';
      }, 200);
    }
  }

  // Cart UI
  toggleCart() {
    const sidebar = document.getElementById('cartSidebar');
    const overlay = document.getElementById('cartOverlay');

    if (sidebar.classList.contains('open')) {
      sidebar.classList.remove('open');
      overlay.classList.add('hidden');
      document.body.style.overflow = '';
    } else {
      sidebar.classList.add('open');
      overlay.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      this.renderCartItems();
    }
  }

  renderCartItems() {
    const container = document.getElementById('cartItems');
    const footer = document.getElementById('cartFooter');

    if (this.cart.length === 0) {
      container.innerHTML = `
        <div class="text-center text-gray-500 py-16">
          <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4m2.6 8L6 4H2m5 9v6a1 1 0 001 1h9a1 1 0 001-1v-6M9 19a1 1 0 102 0M20 19a1 1 0 10-2 0" />
            </svg>
          </div>
          <h4 class="font-semibold text-gray-700 mb-2">Your cart is empty</h4>
          <p class="text-sm">Add some journals to get started!</p>
        </div>`;
      footer.classList.add('hidden');
      return;
    }

    container.innerHTML = this.cart.map(item => `
      <div class="cart-item">
        <div class="flex items-center gap-4">
          <div class="w-16 h-16 bg-gradient-to-br from-indigo-400 to-purple-500 rounded-xl flex items-center justify-center flex-shrink-0">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
            </svg>
          </div>
          <div class="flex-1 min-w-0">
            <h4 class="font-semibold text-gray-800 truncate">${item.title}</h4>
            <p class="text-sm text-gray-600">${item.price.toFixed(2)}</p>
            <p class="text-xs text-gray-500">Qty: ${item.quantity}</p>
          </div>
          <button onclick="app.removeFromCart(${item.id})"
                  class="text-red-500 hover:text-red-700 p-2 rounded-full hover:bg-red-50 transition-colors flex-shrink-0"
                  aria-label="Remove ${item.title} from cart">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
          </button>
        </div>
      </div>
    `).join('');

    const total = this.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    document.getElementById('cartTotal').textContent = `${total.toFixed(2)}`;
    footer.classList.remove('hidden');
  }

  // Filter Management
  toggleFilters() {
    const filters = document.getElementById('advancedFilters');
    const isHidden = filters.classList.contains('hidden');

    if (isHidden) {
      filters.classList.remove('hidden');
      filters.style.maxHeight = '0';
      filters.style.overflow = 'hidden';

      requestAnimationFrame(() => {
        filters.style.transition = 'max-height 0.3s ease-out';
        filters.style.maxHeight = filters.scrollHeight + 'px';
      });
    } else {
      filters.style.maxHeight = '0';
      setTimeout(() => {
        filters.classList.add('hidden');
        filters.style.maxHeight = '';
        filters.style.transition = '';
        filters.style.overflow = '';
      }, 300);
    }
  }

  clearFilters() {
    const form = document.querySelector('form');
    const inputs = form.querySelectorAll('input[type="checkbox"], input[type="radio"]');
    const selects = form.querySelectorAll('select');
    const ranges = form.querySelectorAll('input[type="range"]');

    inputs.forEach(input => input.checked = false);
    selects.forEach(select => select.selectedIndex = 0);
    ranges.forEach(range => {
      range.value = range.max;
      const event = new Event('input', { bubbles: true });
      range.dispatchEvent(event);
    });

    form.querySelector('input[name="search"]').value = '';
    this.updateActiveFiltersCount();
    this.showToast('Filters cleared', 'info');
  }

  updateActiveFiltersCount() {
    const form = document.querySelector('form');
    if (!form) return;

    let count = 0;
    const checkedInputs = form.querySelectorAll('input[type="checkbox"]:checked, input[type="radio"]:checked');
    count += checkedInputs.length;

    const searchInput = form.querySelector('input[name="search"]');
    if (searchInput && searchInput.value.trim()) count++;

    const sortSelect = form.querySelector('select[name="sort"]');
    if (sortSelect && sortSelect.value !== 'trending') count++;

    const priceRange = form.querySelector('input[name="maxPrice"]');
    if (priceRange && priceRange.value !== priceRange.max) count++;

    const countElement = document.getElementById('activeFiltersCount');
    if (countElement) {
      countElement.textContent = count;
      countElement.style.display = count > 0 ? 'flex' : 'none';
    }
  }

  // View Management
  setGridView(view) {
    const grid = document.getElementById('productsGrid');
    const gridBtn = document.getElementById('gridViewBtn');
    const listBtn = document.getElementById('listViewBtn');

    if (!grid || !gridBtn || !listBtn) return;

    if (view === 'list') {
      grid.className = 'space-y-6';
      gridBtn.className = 'px-4 py-2 rounded-lg text-gray-600 hover:bg-gray-100 transition-colors';
      listBtn.className = 'px-4 py-2 rounded-lg bg-indigo-500 text-white transition-colors';

      // Modify cards for list view
      const cards = grid.querySelectorAll('.product-card');
      cards.forEach(card => {
        card.style.display = 'flex';
        card.style.flexDirection = 'row';
        card.style.height = 'auto';
      });
    } else {
      grid.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8';
      gridBtn.className = 'px-4 py-2 rounded-lg bg-indigo-500 text-white transition-colors';
      listBtn.className = 'px-4 py-2 rounded-lg text-gray-600 hover:bg-gray-100 transition-colors';

      // Reset cards for grid view
      const cards = grid.querySelectorAll('.product-card');
      cards.forEach(card => {
        card.style.display = '';
        card.style.flexDirection = '';
        card.style.height = '';
      });
    }

    localStorage.setItem('diaryvault_view_preference', view);
  }

  // Checkout
  checkout() {
    if (this.cart.length === 0) {
      this.showToast('Your cart is empty!', 'warning');
      return;
    }

    // Show loading state
    const checkoutBtn = document.querySelector('[onclick*="checkout"]');
    const originalText = checkoutBtn.innerHTML;
    checkoutBtn.innerHTML = `
      <svg class="animate-spin h-5 w-5 mr-2" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      Processing...
    `;
    checkoutBtn.disabled = true;

    this.showToast('Processing your order...', 'info');

    // Simulate checkout process
    setTimeout(() => {
      this.cart = [];
      this.saveCart();
      this.updateCounts();
      this.toggleCart();
      this.showToast('Order placed successfully! 🎉', 'success', 5000);

      // Reset button
      checkoutBtn.innerHTML = originalText;
      checkoutBtn.disabled = false;
    }, 2000);
  }

  // Event Listeners
  initializeEventListeners() {
    // Form submission handling
    document.addEventListener('submit', (e) => {
      if (e.target.tagName === 'FORM') {
        const submitBtn = e.target.querySelector('button[type="submit"]');
        if (submitBtn) {
          const originalText = submitBtn.innerHTML;
          submitBtn.disabled = true;
          submitBtn.innerHTML = `
            <svg class="animate-spin h-5 w-5 mr-2" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Searching...
          `;

          // Reset after a delay if form doesn't actually submit
          setTimeout(() => {
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
          }, 5000);
        }
      }
    });

    // Filter change monitoring
    const form = document.querySelector('form');
    if (form) {
      form.addEventListener('change', () => {
        this.updateActiveFiltersCount();
      });

      form.addEventListener('input', () => {
        this.updateActiveFiltersCount();
      });
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      // Escape key closes modals
      if (e.key === 'Escape') {
        const cartSidebar = document.getElementById('cartSidebar');
        if (cartSidebar && cartSidebar.classList.contains('open')) {
          this.toggleCart();
        }
      }

      // Ctrl/Cmd + K for search focus
      if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault();
        const searchInput = document.querySelector('.search-input');
        if (searchInput) {
          searchInput.focus();
          searchInput.select();
        }
      }
    });

    // Load saved view preference
    const savedView = localStorage.getItem('diaryvault_view_preference');
    if (savedView) {
      this.setGridView(savedView);
    }
  }

  // Animations
  initializeAnimations() {
    // Intersection Observer for scroll animations
    const observerOptions = {
      threshold: 0.1,
      rootMargin: '0px 0px -50px 0px'
    };

    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          entry.target.style.opacity = '1';
          entry.target.style.transform = 'translateY(0)';
          observer.unobserve(entry.target);
        }
      });
    }, observerOptions);

    // Observe elements with fade-in-up class
    document.querySelectorAll('.animate-fade-in-up').forEach(el => {
      el.style.opacity = '0';
      el.style.transform = 'translateY(30px)';
      el.style.transition = 'opacity 0.8s ease, transform 0.8s ease';
      observer.observe(el);
    });

    // Stagger product card animations
    const cards = document.querySelectorAll('.product-card');
    cards.forEach((card, index) => {
      card.style.animationDelay = `${index * 50}ms`;
    });
  }

  // Accessibility
  initializeAccessibility() {
    // Announce page changes to screen readers
    const announcer = document.createElement('div');
    announcer.setAttribute('aria-live', 'polite');
    announcer.setAttribute('aria-atomic', 'true');
    announcer.className = 'sr-only';
    announcer.id = 'page-announcer';
    document.body.appendChild(announcer);

    // Improve focus management
    document.addEventListener('focusin', (e) => {
      if (e.target.matches('.floating-btn, .quick-action-btn')) {
        e.target.setAttribute('aria-expanded', 'false');
      }
    });

    // Add skip links
    const skipLink = document.createElement('a');
    skipLink.href = '#main-content';
    skipLink.textContent = 'Skip to main content';
    skipLink.className = 'sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 bg-indigo-600 text-white px-4 py-2 rounded z-50';
    document.body.insertBefore(skipLink, document.body.firstChild);

    const mainContent = document.querySelector('.max-w-7xl');
    if (mainContent) {
      mainContent.id = 'main-content';
      mainContent.setAttribute('tabindex', '-1');
    }
  }

  // Quick View (placeholder)
  quickView(journalId) {
    this.showToast('Quick view opening...', 'info');
    // Implementation would go here
  }

  // Compare toggle
  toggleCompare() {
    if (this.comparison.length === 0) {
      this.showToast('No items to compare!', 'info');
      return;
    }
    this.showToast(`Comparing ${this.comparison.length} items...`, 'info');
    // Implementation would go here
  }
}

// Global functions for onclick handlers (backwards compatibility)
let app;

document.addEventListener('DOMContentLoaded', function() {
  app = new MarketplaceApp();

  // Make functions globally available
  window.addToCart = (id, title, price) => app.addToCart(id, title, price);
  window.toggleWishlist = (id) => app.toggleWishlist(id);
  window.addToCompare = (id) => app.addToCompare(id);
  window.toggleCart = () => app.toggleCart();
  window.toggleCompare = () => app.toggleCompare();
  window.quickView = (id) => app.quickView(id);
  window.checkout = () => app.checkout();
  window.toggleFilters = () => app.toggleFilters();
  window.clearFilters = () => app.clearFilters();
  window.setGridView = (view) => app.setGridView(view);
});

// Performance optimizations
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js')
      .then(registration => console.log('SW registered'))
      .catch(error => console.log('SW registration failed'));
  });
}

// Lazy loading for images
if ('IntersectionObserver' in window) {
  const imageObserver = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        const img = entry.target;
        if (img.dataset.src) {
          img.src = img.dataset.src;
          img.removeAttribute('data-src');
          imageObserver.unobserve(img);
        }
      }
    });
  });

  document.querySelectorAll('img[data-src]').forEach(img => {
    imageObserver.observe(img);
  });
}
</script>
{% endblock %}
