{% extends "base.html" %}

{% block title %}DiaryVault - Dashboard{% endblock %}

{% block extra_css %}
<style>
  /* Modern gradient animations */
  @keyframes gradient-shift {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
  }

  .animated-gradient {
    background: linear-gradient(135deg, #667eea, #764ba2, #f093fb, #f5576c);
    background-size: 300% 300%;
    animation: gradient-shift 15s ease infinite;
  }

  /* Enhanced card styles with glassmorphism */
  .glass-card {
    background: rgba(255, 255, 255, 0.85);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
  }

  .glass-card-dark {
    background: rgba(30, 41, 59, 0.85);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.25);
  }

  /* Journal input styling from home.html */
  #journalInput {
    resize: none !important;
    width: 100% !important;
    border: none !important;
    outline: none !important;
    min-height: 150px;
    overflow-wrap: break-word;
    font-family: 'Playfair Display', serif;
    font-size: 1.125rem;
    line-height: 1.75;
  }

  #journalContainer {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border: 2px solid transparent;
    position: relative;
  }

  #journalContainer:focus-within {
    border-color: rgba(99, 102, 241, 0.5) !important;
    box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1) !important;
    background-color: rgba(255, 255, 255, 0.98);
  }

  /* Diary fonts */
  .diary-font {
    font-family: 'Playfair Display', serif;
    letter-spacing: -0.01em;
  }

  .handwritten {
    font-family: 'Satisfy', cursive;
    letter-spacing: 0.01em;
    line-height: 1.7;
  }

  /* Enhanced animations */
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @keyframes scaleIn {
    from { opacity: 0; transform: scale(0.95); }
    to { opacity: 1; transform: scale(1); }
  }

  @keyframes pulse-soft {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.8; }
  }

  .animate-fade-in {
    animation: fadeIn 0.6s ease forwards;
  }

  .animate-scale-in {
    animation: scaleIn 0.4s ease forwards;
  }

  .animate-pulse-soft {
    animation: pulse-soft 2s ease-in-out infinite;
  }

  /* Animation delays */
  .animation-delay-100 { animation-delay: 100ms; }
  .animation-delay-200 { animation-delay: 200ms; }
  .animation-delay-300 { animation-delay: 300ms; }
  .animation-delay-400 { animation-delay: 400ms; }

  /* Enhanced button styles */
  .btn-gradient {
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
  }

  .btn-gradient::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: left 0.5s;
  }

  .btn-gradient:hover::before {
    left: 100%;
  }

  .btn-gradient:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 25px -5px rgba(99, 102, 241, 0.4);
  }

  /* Stats card styling */
  .stat-card {
    position: relative;
    overflow: hidden;
    transition: all 0.3s ease;
  }

  .stat-card::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
    transform: rotate(45deg);
    transition: all 0.5s ease;
    opacity: 0;
  }

  .stat-card:hover::before {
    opacity: 1;
  }

  .stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 12px 24px -5px rgba(0, 0, 0, 0.1);
  }

  /* Memory card enhancements */
  .memory-card {
    background-color: white;
    border-radius: 1rem;
    overflow: hidden;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    cursor: pointer;
  }

  .memory-card:hover {
    transform: translateY(-8px) scale(1.02);
    box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.2);
  }

  .memory-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .memory-card:hover .memory-image {
    transform: scale(1.1);
  }

  .memory-overlay {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0.4) 50%, transparent 100%);
    color: white;
    padding: 1.5rem;
    transform: translateY(100%);
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .memory-card:hover .memory-overlay {
    transform: translateY(0);
  }

  /* Suggestion pills */
  .suggestion-pill {
    background: rgba(99, 102, 241, 0.1);
    border: 1px solid rgba(99, 102, 241, 0.2);
    color: #6366f1;
    padding: 0.5rem 1rem;
    border-radius: 9999px;
    font-size: 0.875rem;
    font-weight: 500;
    transition: all 0.2s ease;
    cursor: pointer;
    white-space: nowrap;
  }

  .suggestion-pill:hover {
    background: rgba(99, 102, 241, 0.2);
    border-color: rgba(99, 102, 241, 0.3);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px -2px rgba(99, 102, 241, 0.2);
  }

  /* Loading states */
  .skeleton {
    background: linear-gradient(90deg, #f3f4f6 25%, #e5e7eb 50%, #f3f4f6 75%);
    background-size: 200% 100%;
    animation: loading 1.5s ease-in-out infinite;
  }

  @keyframes loading {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
  }

  /* Enhanced photo grid */
  .photo-grid {
    display: grid;
    gap: 1rem;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  }

  @media (min-width: 768px) {
    .photo-grid {
      grid-template-columns: repeat(3, 1fr);
    }
  }

  @media (min-width: 1024px) {
    .photo-grid {
      grid-template-columns: repeat(4, 1fr);
    }
  }

  .photo-grid-item-large {
    grid-column: span 2;
    grid-row: span 2;
  }

  /* Progress rings */
  .progress-ring {
    transform: rotate(-90deg);
  }

  .progress-ring-circle {
    transition: stroke-dashoffset 1s cubic-bezier(0.4, 0, 0.2, 1);
  }

  /* Floating elements */
  @keyframes float {
    0% { transform: translateY(0px); }
    50% { transform: translateY(-10px); }
    100% { transform: translateY(0px); }
  }

  .float-animation {
    animation: float 3s ease-in-out infinite;
  }

  /* Blob animations */
  @keyframes blob {
    0% { transform: translate(0px, 0px) scale(1); }
    33% { transform: translate(20px, -20px) scale(1.1); }
    66% { transform: translate(-10px, 10px) scale(0.9); }
    100% { transform: translate(0px, 0px) scale(1); }
  }

  .blob {
    position: absolute;
    filter: blur(40px);
    opacity: 0.7;
    animation: blob 7s infinite;
  }

  .blob-1 { background: #6366f1; top: 0; left: 0; width: 200px; height: 200px; }
  .blob-2 { background: #8b5cf6; bottom: 0; right: 0; width: 250px; height: 250px; animation-delay: 2s; }
  .blob-3 { background: #ec4899; top: 50%; left: 50%; width: 150px; height: 150px; animation-delay: 4s; }

  /* Mobile optimizations */
  @media (max-width: 640px) {
    .container {
      padding: 1rem;
    }

    .glass-card {
      border-radius: 1rem;
      padding: 1rem;
    }

    .btn-gradient {
      width: 100%;
      justify-content: center;
    }

    .suggestion-pill {
      font-size: 0.75rem;
      padding: 0.375rem 0.75rem;
    }
  }

  /* Dark mode support */
  @media (prefers-color-scheme: dark) {
    .glass-card {
      background: rgba(30, 41, 59, 0.85);
      color: #f1f5f9;
    }

    .suggestion-pill {
      background: rgba(99, 102, 241, 0.2);
      color: #a5b4fc;
    }
  }

  /* Smooth scrollbar */
  ::-webkit-scrollbar {
    width: 8px;
    height: 8px;
  }

  ::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: 4px;
  }

  ::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 4px;
  }

  ::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
  }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen relative overflow-hidden" data-is-anonymous="{{ is_anonymous|yesno:'true,false' }}">
  <!-- Background blobs -->
  <div class="absolute inset-0 overflow-hidden pointer-events-none">
    <div class="blob blob-1"></div>
    <div class="blob blob-2"></div>
    <div class="blob blob-3"></div>
  </div>

  <div class="container mx-auto px-4 py-6 max-w-7xl relative z-10">
    {% if not is_anonymous %}
    <!-- Authenticated User Welcome - Simple Version -->
    <div class="glass-card rounded-2xl p-6 mb-8 animate-fade-in">
      <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-6">
        <div>
          <h1 class="text-3xl lg:text-4xl font-bold mb-2 diary-font">
            Welcome back, {{ request.user.username }}
          </h1>
          <p class="text-gray-600 text-lg">Continue your journey or explore past memories</p>
        </div>
        <a href="{% url 'new_entry' %}" class="btn-gradient text-white px-6 py-3 rounded-xl font-semibold flex items-center gap-2 shadow-lg">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
          </svg>
          New Entry
        </a>
      </div>
    </div>
    {% endif %}

    <!-- Success Messages -->
    {% if request.GET.entry_saved == 'true' or messages %}
    <div id="entrySuccess" class="mb-6 animate-fade-in">
      <div class="glass-card bg-green-50 border-green-200 text-green-800 rounded-xl p-4">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center">
              <svg class="w-6 h-6 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
              </svg>
            </div>
            <div>
              <div class="font-semibold">Entry Saved Successfully!</div>
              <div class="text-sm opacity-75">Your journal entry has been added to your collection.</div>
            </div>
          </div>
          <button class="p-2 hover:bg-green-100 rounded-lg transition-colors" onclick="document.getElementById('entrySuccess').remove()">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
          </button>
        </div>
      </div>
    </div>

    <script>
      setTimeout(() => {
        const successMsg = document.getElementById('entrySuccess');
        if (successMsg) {
          successMsg.style.transition = 'opacity 0.5s ease';
          successMsg.style.opacity = '0';
          setTimeout(() => successMsg.remove(), 500);
        }
      }, 5000);

      if (window.location.search.includes('entry_saved=true')) {
        const url = new URL(window.location);
        url.searchParams.delete('entry_saved');
        window.history.replaceState({}, document.title, url.pathname);
      }
    </script>
    {% endif %}

    <!-- Stats Overview -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
      {% if is_anonymous %}
      <!-- Sample stats for anonymous users -->
      <div class="stat-card glass-card rounded-xl p-6 opacity-75 animate-fade-in animation-delay-100">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-600">Total Entries</p>
            <p class="text-3xl font-bold text-gray-900" data-stat="total-entries">0</p>
            <p class="text-xs text-gray-500 mt-1">Start writing to build your collection</p>
          </div>
          <div class="w-14 h-14 bg-gradient-to-br from-blue-400 to-blue-600 rounded-xl flex items-center justify-center text-white">
            <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
            </svg>
          </div>
        </div>
      </div>

      <div class="stat-card glass-card rounded-xl p-6 opacity-75 animate-fade-in animation-delay-200">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-600">Writing Streak</p>
            <p class="text-3xl font-bold text-gray-900" data-stat="streak">0</p>
            <p class="text-xs text-gray-500 mt-1">Build consistency</p>
          </div>
          <div class="w-14 h-14 bg-gradient-to-br from-orange-400 to-red-600 rounded-xl flex items-center justify-center text-white">
            <span class="text-2xl">üî•</span>
          </div>
        </div>
      </div>

      <div class="stat-card glass-card rounded-xl p-6 opacity-75 animate-fade-in animation-delay-300">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-600">Total Words</p>
            <p class="text-3xl font-bold text-gray-900" data-stat="total-words">0</p>
            <p class="text-xs text-gray-500 mt-1">Express yourself</p>
          </div>
          <div class="w-14 h-14 bg-gradient-to-br from-purple-400 to-purple-600 rounded-xl flex items-center justify-center text-white">
            <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z" />
            </svg>
          </div>
        </div>
      </div>

      <div class="stat-card glass-card rounded-xl p-6 opacity-75 animate-fade-in animation-delay-400">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-600">Mood Insights</p>
            <p class="text-3xl font-bold text-gray-900" data-stat="dominant-mood">‚Äî</p>
            <p class="text-xs text-gray-500 mt-1">Track emotions</p>
          </div>
          <div class="w-14 h-14 bg-gradient-to-br from-green-400 to-teal-600 rounded-xl flex items-center justify-center text-white">
            <span class="text-2xl">üòä</span>
          </div>
        </div>
      </div>
      {% else %}
      <!-- Real stats for authenticated users -->
      <div class="stat-card glass-card rounded-xl p-6 animate-fade-in animation-delay-100">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-600">Total Entries</p>
            <p class="text-3xl font-bold text-gray-900" data-stat="total-entries">{{ total_entries }}</p>
            <p class="text-xs text-gray-500 mt-1">Keep it up!</p>
          </div>
          <div class="w-14 h-14 bg-gradient-to-br from-blue-400 to-blue-600 rounded-xl flex items-center justify-center text-white">
            <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
            </svg>
          </div>
        </div>
      </div>

      <div class="stat-card glass-card rounded-xl p-6 animate-fade-in animation-delay-200">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-600">Writing Streak</p>
            <p class="text-3xl font-bold text-gray-900" data-stat="streak">{{ streak }}</p>
            <p class="text-xs text-gray-500 mt-1">{% if streak > 0 %}Keep going!{% else %}Start today{% endif %}</p>
          </div>
          <div class="w-14 h-14 bg-gradient-to-br from-orange-400 to-red-600 rounded-xl flex items-center justify-center text-white">
            <span class="text-2xl">üî•</span>
          </div>
        </div>
      </div>

      <div class="stat-card glass-card rounded-xl p-6 animate-fade-in animation-delay-300">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-600">Total Words</p>
            <p class="text-3xl font-bold text-gray-900" data-stat="total-words">{{ total_words|default:0 }}</p>
            <p class="text-xs text-gray-500 mt-1">Amazing progress!</p>
          </div>
          <div class="w-14 h-14 bg-gradient-to-br from-purple-400 to-purple-600 rounded-xl flex items-center justify-center text-white">
            <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z" />
            </svg>
          </div>
        </div>
      </div>

      <div class="stat-card glass-card rounded-xl p-6 animate-fade-in animation-delay-400">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-600">Dominant Mood</p>
            <p class="text-3xl font-bold text-gray-900" data-stat="dominant-mood">{{ dominant_mood|default:"‚Äî" }}</p>
            <p class="text-xs text-gray-500 mt-1">{% if dominant_mood %}This month{% else %}No data yet{% endif %}</p>
          </div>
          <div class="w-14 h-14 bg-gradient-to-br from-green-400 to-teal-600 rounded-xl flex items-center justify-center text-white">
            <span class="text-2xl">üòä</span>
          </div>
        </div>
      </div>
      {% endif %}
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Main content area -->
      <div class="lg:col-span-2 space-y-6">
        <!-- Quick Journal Form (from home.html) -->
        <div class="glass-card rounded-2xl p-6 animate-fade-in">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-bold text-gray-800 diary-font flex items-center gap-2">
              <svg class="w-5 h-5 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
              </svg>
              Quick Journal Entry
            </h2>
            <div class="text-xs font-medium bg-gradient-to-r from-primary-50 to-purple-50 px-3 py-1 rounded-full text-primary-700 flex items-center gap-1 border border-primary-100">
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
              </svg>
              AI-powered
            </div>
          </div>

          <form id="dashboardJournalForm" enctype="multipart/form-data">
            {% csrf_token %}

            <!-- Character counter -->
            <div class="flex items-center justify-between mb-3">
              <p class="text-sm text-gray-600">Share what's on your mind...</p>
              <div class="text-xs font-medium bg-gray-100 px-3 py-1 rounded-full text-gray-600">
                <span id="charCount">0</span> characters
              </div>
            </div>

            <!-- Journal input container -->
            <div id="journalContainer" class="relative border-2 border-gray-200 rounded-xl bg-gray-50/50 focus-within:bg-white transition-all">
              <textarea
                id="journalInput"
                name="journal_content"
                class="w-full p-4 bg-transparent resize-none focus:outline-none"
                placeholder="What's on your mind? Share your thoughts, feelings, or experiences..."
                oninput="countChars()"></textarea>

              <!-- Photo preview -->
              <div id="photoPreviewContainer" class="hidden p-3 border-t border-gray-200 bg-white/80">
                <div class="flex items-center gap-3">
                  <div class="relative inline-block group">
                    <img id="photoPreview" class="h-20 w-20 object-cover rounded-lg border-2 border-gray-200" src="" alt="Photo preview">
                    <button type="button" onclick="removePhoto()" class="absolute -top-2 -right-2 bg-white rounded-full p-1 shadow-md border border-gray-200 hover:bg-red-50">
                      <svg class="w-4 h-4 text-gray-600" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                      </svg>
                    </button>
                  </div>
                  <div class="text-sm text-gray-600">
                    <div class="font-medium">Photo added</div>
                    <div class="text-xs" id="photoName">image.jpg</div>
                  </div>
                </div>
              </div>

              <!-- Tools -->
              <div class="absolute bottom-2 right-3">
                <input id="journalPhoto" name="journal_photo" type="file" accept="image/*" class="hidden" onchange="previewPhoto(event)">
                <label for="journalPhoto" class="cursor-pointer p-2 hover:bg-gray-100 rounded-full transition-colors" title="Add a photo">
                  <svg class="w-5 h-5 text-gray-500 hover:text-primary-600" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd" />
                  </svg>
                </label>
              </div>
            </div>

            <!-- Suggestions -->
            <div class="mt-4">
              <div class="text-xs font-medium text-gray-600 mb-2 flex items-center gap-1">
                <svg class="w-4 h-4 text-primary-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                </svg>
                Quick prompts:
              </div>
              <div class="flex flex-wrap gap-2">
                <button type="button" onclick="addSuggestion('Today I\'m feeling')" class="suggestion-pill">Today I'm feeling</button>
                <button type="button" onclick="addSuggestion('I accomplished')" class="suggestion-pill">I accomplished</button>
                <button type="button" onclick="addSuggestion('I learned that')" class="suggestion-pill">I learned that</button>
                <button type="button" onclick="addSuggestion('I\'m grateful for')" class="suggestion-pill">I'm grateful for</button>
                <button type="button" onclick="addSuggestion('A moment worth remembering:')" class="suggestion-pill">Worth remembering</button>
              </div>
            </div>

            <!-- Personalization toggle -->
            <div class="mt-4 p-3 bg-gray-50 rounded-lg">
              <label class="flex items-start gap-3 cursor-pointer">
                <input type="checkbox" id="personalizationToggle" class="mt-1 w-4 h-4 text-primary-600 border-gray-300 rounded focus:ring-primary-500">
                <div class="text-sm">
                  <div class="font-medium text-gray-700">Use AI enhancement</div>
                  <div class="text-gray-500">Transform your notes into a polished journal entry</div>
                </div>
              </label>
            </div>

            <!-- Submit button -->
            <div class="mt-6">
              <button type="button" id="generateButton" onclick="generateEntry()" class="btn-gradient w-full text-white py-3 px-6 rounded-xl font-semibold flex items-center justify-center gap-2">
                <span>Transform into Journal Entry</span>
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
              </button>
            </div>
          </form>

          <!-- Loading state -->
          <div id="loadingIndicator" class="hidden mt-6">
            <div class="flex flex-col items-center justify-center p-8">
              <div class="w-16 h-16 border-4 border-primary-200 border-t-primary-600 rounded-full animate-spin mb-4"></div>
              <p class="text-gray-600 font-medium handwritten text-xl">Crafting your journal entry...</p>
              <p class="text-gray-500 text-sm mt-2">This takes just a moment</p>
            </div>
          </div>

          <!-- Result preview -->
          <div id="resultPreview" class="hidden mt-6 animate-scale-in">
            <div class="border-t border-gray-200 pt-6">
              <div class="flex items-center justify-between mb-4">
                <div>
                  <h3 class="font-bold text-gray-800 text-lg diary-font">Your Journal Entry</h3>
                  <p class="text-gray-600 text-sm">Generated from your notes</p>
                </div>
                <button onclick="editJournalEntry()" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                  <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                  </svg>
                </button>
              </div>

              <div class="bg-gradient-to-br from-white to-gray-50 p-6 rounded-xl border border-gray-100">
                <div id="journalEntry" class="handwritten text-xl text-gray-800 leading-relaxed">
                  <!-- Generated content appears here -->
                </div>
              </div>

              <div class="mt-4 text-center">
                <span class="text-sm text-gray-600">Title: </span>
                <span id="entryTitle" class="text-sm font-medium text-gray-800">My Journal Entry</span>
              </div>

              <div class="mt-6 flex flex-wrap gap-3">
                <button type="button" onclick="editJournalEntry()" class="flex-1 sm:flex-none border border-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-50 transition-colors flex items-center justify-center gap-2">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                  </svg>
                  Edit
                </button>
                <button type="button" onclick="restartEntry()" class="flex-1 sm:flex-none border border-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-50 transition-colors flex items-center justify-center gap-2">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                  </svg>
                  Try Again
                </button>
                <button type="button" onclick="saveEntry(event)" class="flex-1 sm:flex-none bg-gradient-to-r from-green-500 to-green-600 text-white px-4 py-2 rounded-lg hover:from-green-600 hover:to-green-700 transition-all flex items-center justify-center gap-2">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                  </svg>
                  Save Entry
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Recent Memories -->
        <div class="glass-card rounded-2xl p-6 animate-fade-in">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-xl font-bold text-gray-800 diary-font">Recent Memories</h2>
            <a href="{% url 'library' %}" class="text-sm text-primary-600 hover:text-primary-700 font-medium flex items-center gap-1">
              View all
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
            </a>
          </div>

          {% if recent_entries and not is_anonymous %}
          <div class="photo-grid">
            {% for entry in recent_entries|slice:":6" %}
            <a href="{% url 'entry_detail' entry.id %}" class="memory-card {% if forloop.first %}photo-grid-item-large{% endif %}">
              {% if entry.photos.first %}
                <img src="{{ entry.photos.first.photo.url }}" alt="Memory" class="memory-image" />
              {% elif entry.photo %}
                <img src="{{ entry.photo.url }}" alt="Memory" class="memory-image" />
              {% else %}
                <div class="memory-image animated-gradient flex items-center justify-center">
                  <div class="text-white text-center p-4">
                    <div class="text-4xl mb-2">üìù</div>
                  </div>
                </div>
              {% endif %}
              <div class="memory-overlay">
                <h3 class="font-semibold mb-1">{{ entry.title|default:"Untitled" }}</h3>
                <p class="text-sm opacity-90">{{ entry.created_at|date:"M j, Y" }}</p>
              </div>
            </a>
            {% endfor %}
          </div>
          {% else %}
          <div class="text-center py-12">
            <div class="w-20 h-20 bg-gray-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
              <svg class="w-10 h-10 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
              </svg>
            </div>
            <h3 class="text-lg font-semibold text-gray-800 mb-2">No memories yet</h3>
            <p class="text-gray-600 mb-4">Start journaling to create your first memory</p>
            {% if is_anonymous %}
            <button onclick="connectWallet()" class="btn-gradient text-white px-6 py-2 rounded-lg">
              Connect Wallet to Start
            </button>
            {% else %}
            <a href="{% url 'new_entry' %}" class="btn-gradient text-white px-6 py-2 rounded-lg inline-block">
              Create Your First Memory
            </a>
            {% endif %}
          </div>
          {% endif %}
        </div>
      </div>

      <!-- Sidebar -->
      <div class="space-y-6">
        <!-- Quick Actions -->
        <div class="glass-card rounded-2xl p-6 animate-fade-in">
          <h3 class="text-lg font-bold text-gray-800 mb-4">Quick Actions</h3>
          <div class="space-y-3">
            <a href="{% url 'new_entry' %}" class="flex items-center gap-3 p-3 rounded-lg hover:bg-gray-50 transition-colors">
              <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
              </div>
              <div>
                <div class="font-medium text-gray-800">New Entry</div>
                <div class="text-xs text-gray-500">Start writing</div>
              </div>
            </a>

            <a href="{% url 'library' %}" class="flex items-center gap-3 p-3 rounded-lg hover:bg-gray-50 transition-colors">
              <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
                <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                </svg>
              </div>
              <div>
                <div class="font-medium text-gray-800">Library</div>
                <div class="text-xs text-gray-500">Browse entries</div>
              </div>
            </a>

            <a href="{% url 'insights' %}" class="flex items-center gap-3 p-3 rounded-lg hover:bg-gray-50 transition-colors">
              <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                </svg>
              </div>
              <div>
                <div class="font-medium text-gray-800">Insights</div>
                <div class="text-xs text-gray-500">View analytics</div>
              </div>
            </a>
          </div>
        </div>

        <!-- Time Periods -->
        {% if time_periods and not is_anonymous %}
        <div class="glass-card rounded-2xl p-6 animate-fade-in">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-bold text-gray-800">Time Periods</h3>
            <a href="{% url 'library' %}?tab=journals" class="text-sm text-primary-600 hover:text-primary-700">View all</a>
          </div>
          <div class="space-y-3">
            {% for period in time_periods|slice:":5" %}
            <a href="{% url 'library' %}?tab=journals" class="block p-3 rounded-lg hover:bg-gray-50 transition-colors">
              <div class="flex items-center justify-between">
                <div>
                  <div class="font-medium text-gray-800">{{ period.period }}</div>
                  <div class="text-xs text-gray-500">{{ period.count }} entries</div>
                </div>
                <div class="w-8 h-8 bg-{{ period.color }} bg-opacity-10 rounded-lg flex items-center justify-center">
                  <svg class="w-4 h-4 text-{{ period.color }}" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" />
                    <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 1 1 0 000 2H6a2 2 0 00-2 2v6a2 2 0 002 2h2a1 1 0 100-2H6V7h8v6h-2a1 1 0 100 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2a1 1 0 100-2 2 2 0 012 2z" clip-rule="evenodd" />
                  </svg>
                </div>
              </div>
            </a>
            {% endfor %}
          </div>
        </div>
        {% endif %}

        <!-- Mood Overview -->
        {% if mood_counts and not is_anonymous %}
        <div class="glass-card rounded-2xl p-6 animate-fade-in">
          <h3 class="text-lg font-bold text-gray-800 mb-4">Mood Overview</h3>
          <div class="space-y-3">
            {% for mood, count in mood_counts.items %}
            <div class="flex items-center justify-between">
              <span class="text-sm text-gray-600 capitalize">{{ mood }}</span>
              <div class="flex items-center gap-2">
                <div class="w-24 h-2 bg-gray-200 rounded-full overflow-hidden">
                  <div class="h-full bg-gradient-to-r from-primary-400 to-purple-400 rounded-full" style="width: {{ count|floatformat:0 }}%"></div>
                </div>
                <span class="text-xs text-gray-500 w-8 text-right">{{ count }}</span>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    countChars();
    setupDragAndDrop();
    initializePersonalization();
    initializeAnimations();
    checkWalletConnection();
    checkForPendingEntry();
    
    // Initialize anonymous stats on page load
    initializeAnonymousStats();
});

// Check for pending journal entry from home page
function checkForPendingEntry() {
    const pendingEntry = sessionStorage.getItem('pendingJournalEntry');
    
    if (pendingEntry) {
        try {
            const entryData = JSON.parse(pendingEntry);
            
            showToast('We found your draft entry! Loading it now...', 'info');
            
            const journalInput = document.getElementById('journalInput');
            if (journalInput && entryData.content) {
                journalInput.value = entryData.content;
                countChars();
            }
            
            if (entryData.photoData && entryData.photoName) {
                fetch(entryData.photoData)
                    .then(res => res.blob())
                    .then(blob => {
                        const file = new File([blob], entryData.photoName, { type: blob.type });
                        currentPhotoFile = file;
                        currentPhotoDataUrl = entryData.photoData;
                        
                        document.getElementById('photoPreview').src = currentPhotoDataUrl;
                        document.getElementById('photoName').textContent = entryData.photoName;
                        document.getElementById('photoPreviewContainer').classList.remove('hidden');
                    });
            }
            
            if (entryData.fromDemo && entryData.title) {
                displayGeneratedEntry({
                    entry: entryData.content,
                    title: entryData.title
                });
                
                if (entryData.hasWallet && entryData.rewards) {
                    showToast(`Ready to save! You'll earn ${entryData.rewards} tokens`, 'success');
                }
            }
            
            sessionStorage.removeItem('pendingJournalEntry');
            
        } catch (error) {
            console.error('Error loading pending entry:', error);
            sessionStorage.removeItem('pendingJournalEntry');
        }
    }
}

// Character counting
function countChars() {
    const input = document.getElementById('journalInput');
    const count = document.getElementById('charCount');
    if (input && count) {
        count.textContent = input.value.length;
    }
}

// Add suggestion to input
function addSuggestion(text) {
    const input = document.getElementById('journalInput');
    if (!input) return;
    
    let currentText = input.value;
    if (currentText && !currentText.endsWith(' ')) {
        currentText += ' ';
    }
    input.value = currentText + text + ' ';
    input.focus();
    countChars();
    
    input.dispatchEvent(new Event('input'));
}

// Photo handling
let currentPhotoFile = null;
let currentPhotoDataUrl = null;

function previewPhoto(event) {
    const file = event.target.files[0];
    if (file && file.type.match('image.*')) {
        if (file.size > 5 * 1024 * 1024) {
            showToast('Image must be smaller than 5MB', 'error');
            event.target.value = '';
            return;
        }
        
        currentPhotoFile = file;
        const reader = new FileReader();
        reader.onload = function(e) {
            currentPhotoDataUrl = e.target.result;
            document.getElementById('photoPreview').src = currentPhotoDataUrl;
            document.getElementById('photoName').textContent = file.name;
            document.getElementById('photoPreviewContainer').classList.remove('hidden');
        };
        reader.readAsDataURL(file);
    }
}

function removePhoto() {
    currentPhotoFile = null;
    currentPhotoDataUrl = null;
    document.getElementById('journalPhoto').value = '';
    document.getElementById('photoPreviewContainer').classList.add('hidden');
}

// Drag and drop functionality
function setupDragAndDrop() {
    const dropZone = document.getElementById('journalContainer');
    if (!dropZone) return;

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, unhighlight, false);
    });

    function highlight(e) {
        dropZone.classList.add('border-primary-500', 'bg-primary-50');
    }

    function unhighlight(e) {
        dropZone.classList.remove('border-primary-500', 'bg-primary-50');
    }

    dropZone.addEventListener('drop', handleDrop, false);

    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;

        if (files.length > 0 && files[0].type.match('image.*')) {
            const fileInput = document.getElementById('journalPhoto');
            fileInput.files = files;
            previewPhoto({ target: fileInput });
        }
    }
}

// Initialize personalization
function initializePersonalization() {
    const toggle = document.getElementById('personalizationToggle');
    if (toggle) {
        const saved = localStorage.getItem('usePersonalization');
        if (saved !== null) {
            toggle.checked = saved === 'true';
        }

        toggle.addEventListener('change', function() {
            localStorage.setItem('usePersonalization', this.checked);
        });
    }
}

// Generate journal entry
function generateEntry() {
    const journalInput = document.getElementById('journalInput');
    const inputText = journalInput.value.trim();

    if (!inputText || inputText.length < 10) {
        showToast('Please write at least 10 characters to generate an entry', 'warning');
        return;
    }

    document.getElementById('dashboardJournalForm').classList.add('hidden');
    document.getElementById('loadingIndicator').classList.remove('hidden');

    const generateButton = document.getElementById('generateButton');
    generateButton.disabled = true;

    const formData = new FormData();
    formData.append('journal_content', inputText);
    formData.append('csrfmiddlewaretoken', getCsrfToken());

    const personalizationToggle = document.getElementById('personalizationToggle');
    if (personalizationToggle && personalizationToggle.checked) {
        formData.append('personalize', 'true');
    }

    if (currentPhotoFile) {
        formData.append('journal_photo', currentPhotoFile);
    }

    const walletInfo = getWalletInfo();
    if (walletInfo.isConnected) {
        formData.append('wallet_address', walletInfo.address);
        formData.append('chain_id', walletInfo.chainId);
        formData.append('encrypted', 'true');
    }

    fetch('/api/demo-journal/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCsrfToken()
        },
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            if (response.status === 429) {
                throw new Error('Rate limit exceeded. Please wait a moment before trying again.');
            }
            throw new Error(`Server error: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        document.getElementById('loadingIndicator').classList.add('hidden');
        generateButton.disabled = false;

        if (data.error) {
            showToast(data.error, 'error');
            document.getElementById('dashboardJournalForm').classList.remove('hidden');
            return;
        }

        displayGeneratedEntry(data);
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('loadingIndicator').classList.add('hidden');
        document.getElementById('dashboardJournalForm').classList.remove('hidden');
        generateButton.disabled = false;
        showToast(error.message || 'Failed to generate entry. Please try again.', 'error');
    });
}

// Display generated entry
function displayGeneratedEntry(data) {
    const journalEntry = document.getElementById('journalEntry');
    const entryTitle = document.getElementById('entryTitle');

    if (journalEntry) {
        journalEntry.innerHTML = data.entry.replace(/\n/g, '<br>');
    }

    if (entryTitle) {
        entryTitle.textContent = data.title || `My Journal Entry - ${new Date().toLocaleDateString()}`;
    }

    document.getElementById('resultPreview').classList.remove('hidden');

    setTimeout(() => {
        document.getElementById('resultPreview').scrollIntoView({ 
            behavior: 'smooth', 
            block: 'center' 
        });
    }, 100);
}

// Edit journal entry
function editJournalEntry() {
    const journalEntry = document.getElementById('journalEntry');
    const journalInput = document.getElementById('journalInput');

    if (!journalEntry || !journalInput) return;

    const content = journalEntry.innerHTML.replace(/<br\s*\/?>/gi, '\n');
    journalInput.value = content;

    document.getElementById('resultPreview').classList.add('hidden');
    document.getElementById('dashboardJournalForm').classList.remove('hidden');

    countChars();
    journalInput.focus();
}

// Restart entry
function restartEntry() {
    document.getElementById('journalInput').value = '';
    removePhoto();
    countChars();

    document.getElementById('resultPreview').classList.add('hidden');
    document.getElementById('dashboardJournalForm').classList.remove('hidden');

    document.getElementById('journalInput').focus();
}

// Function to fetch and update dashboard stats from server
function updateDashboardStats() {
    console.log('Fetching updated stats...');
    
    // Check if user is anonymous
    const isAnonymous = document.querySelector('[data-is-anonymous]')?.dataset.isAnonymous === 'true';
    
    if (isAnonymous) {
        console.log('Anonymous user - updating local stats only');
        updateAnonymousStats();
        return;
    }
    
    // Fetch updated stats from the server for authenticated users
    fetch('/api/user-stats/', {
        method: 'GET',
        headers: {
            'X-CSRFToken': getCsrfToken(),
            'Accept': 'application/json',
        },
        credentials: 'include'
    })
    .then(response => {
        console.log('Stats response status:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Stats data received:', data);
        
        // Update total entries
        const totalEntriesEl = document.querySelector('[data-stat="total-entries"]');
        if (totalEntriesEl && data.total_entries !== undefined) {
            animateStatUpdate(totalEntriesEl, data.total_entries);
            
            // Update helper text
            const helperText = totalEntriesEl.parentElement?.querySelector('.text-xs');
            if (helperText) {
                helperText.textContent = data.total_entries > 0 ? 'Keep it up!' : 'Start writing to build your collection';
            }
        }
        
        // Update streak
        const streakEl = document.querySelector('[data-stat="streak"]');
        if (streakEl && data.streak !== undefined) {
            animateStatUpdate(streakEl, data.streak);
            
            // Update helper text
            const helperText = streakEl.parentElement?.querySelector('.text-xs');
            if (helperText) {
                helperText.textContent = data.streak > 0 ? 'Keep going!' : 'Start today';
            }
        }
        
        // Update total words
        const totalWordsEl = document.querySelector('[data-stat="total-words"]');
        if (totalWordsEl && data.total_words !== undefined) {
            animateStatUpdate(totalWordsEl, data.total_words);
            
            // Update helper text
            const helperText = totalWordsEl.parentElement?.querySelector('.text-xs');
            if (helperText) {
                helperText.textContent = 'Amazing progress!';
            }
        }
        
        // Update dominant mood if provided
        const moodEl = document.querySelector('[data-stat="dominant-mood"]');
        if (moodEl && data.dominant_mood) {
            moodEl.textContent = data.dominant_mood;
            
            // Update helper text
            const helperText = moodEl.parentElement?.querySelector('.text-xs');
            if (helperText) {
                helperText.textContent = 'This month';
            }
        }
        
        // Show success animation on stat cards
        document.querySelectorAll('.stat-card').forEach(card => {
            card.classList.add('animate-pulse-soft');
            setTimeout(() => {
                card.classList.remove('animate-pulse-soft');
            }, 2000);
        });
        
    })
    .catch(error => {
        console.error('Error updating stats:', error);
        // Fallback: do a simple increment based on what we know
        fallbackStatUpdate();
    });
}

// Update stats for anonymous users locally (FIXED to use localStorage)
function updateAnonymousStats() {
    console.log('Updating anonymous user stats locally');
    
    // Get current stats
    const stats = getAnonymousStats();
    const anonymousEntries = getAnonymousEntries();
    const entryCount = Object.keys(anonymousEntries).length;
    
    // Update stats
    stats.totalEntries = entryCount;
    
    // Update total entries UI
    const totalEntriesEl = document.querySelector('[data-stat="total-entries"]');
    if (totalEntriesEl) {
        animateStatUpdate(totalEntriesEl, entryCount);
        
        // Update helper text
        const helperText = totalEntriesEl.parentElement?.querySelector('.text-xs');
        if (helperText) {
            helperText.textContent = entryCount > 0 ? 
                'Connect wallet to save permanently' : 
                'Start writing to build your collection';
        }
        
        // Remove opacity if user has entries
        if (entryCount > 0) {
            const statCard = totalEntriesEl.closest('.stat-card');
            if (statCard) {
                statCard.classList.remove('opacity-75');
            }
        }
    }
    
    // Update total words from latest entry
    const journalContent = document.getElementById('journalEntry');
    if (journalContent) {
        const wordCount = journalContent.textContent.split(/\s+/).filter(word => word.length > 0).length;
        stats.totalWords += wordCount;
        
        const totalWordsEl = document.querySelector('[data-stat="total-words"]');
        if (totalWordsEl) {
            animateStatUpdate(totalWordsEl, stats.totalWords);
            
            // Remove opacity
            const statCard = totalWordsEl.closest('.stat-card');
            if (statCard) {
                statCard.classList.remove('opacity-75');
            }
        }
    }
    
    // Update streak
    const now = new Date();
    if (stats.lastEntryDate) {
        const lastEntry = new Date(stats.lastEntryDate);
        const hoursSinceLastEntry = (now - lastEntry) / (1000 * 60 * 60);
        
        if (hoursSinceLastEntry <= 24) {
            // Within 24 hours, continue streak
            const isSameDay = lastEntry.toDateString() === now.toDateString();
            if (!isSameDay) {
                stats.streak += 1; // Increment only if it's a different day
            }
        } else {
            // More than 24 hours, reset streak
            stats.streak = 1;
        }
    } else {
        // First entry
        stats.streak = 1;
    }
    
    stats.lastEntryDate = now.toISOString();
    
    const streakEl = document.querySelector('[data-stat="streak"]');
    if (streakEl) {
        animateStatUpdate(streakEl, stats.streak);
        
        // Update helper text
        const helperText = streakEl.parentElement?.querySelector('.text-xs');
        if (helperText) {
            helperText.textContent = stats.streak > 1 ? 'Keep going!' : 'Great start!';
        }
        
        // Remove opacity
        const statCard = streakEl.closest('.stat-card');
        if (statCard) {
            statCard.classList.remove('opacity-75');
        }
    }
    
    // Save updated stats to localStorage
    saveAnonymousStats(stats);
    
    // Show success animation on stat cards
    document.querySelectorAll('.stat-card').forEach(card => {
        card.classList.add('animate-pulse-soft');
        setTimeout(() => {
            card.classList.remove('animate-pulse-soft');
        }, 2000);
    });
}

// Get anonymous entries from localStorage (not sessionStorage!)
function getAnonymousEntries() {
    try {
        const stored = localStorage.getItem('anonymousEntries');
        if (stored) {
            return JSON.parse(stored);
        }
    } catch (e) {
        console.error('Error reading anonymous entries:', e);
    }
    
    // Default
    return {};
}

// Save anonymous entries to localStorage
function saveAnonymousEntries(entries) {
    try {
        localStorage.setItem('anonymousEntries', JSON.stringify(entries));
        console.log('Saved anonymous entries to localStorage:', entries);
    } catch (e) {
        console.error('Error saving anonymous entries:', e);
    }
}

// Get anonymous stats from localStorage
function getAnonymousStats() {
    try {
        const stored = localStorage.getItem('anonymousStats');
        if (stored) {
            return JSON.parse(stored);
        }
    } catch (e) {
        console.error('Error reading anonymous stats:', e);
    }
    
    // Default stats
    return {
        totalEntries: 0,
        totalWords: 0,
        streak: 0,
        lastEntryDate: null
    };
}

// Save anonymous stats to localStorage
function saveAnonymousStats(stats) {
    try {
        localStorage.setItem('anonymousStats', JSON.stringify(stats));
        console.log('Saved anonymous stats to localStorage:', stats);
    } catch (e) {
        console.error('Error saving anonymous stats:', e);
    }
}

// Initialize stats on page load for anonymous users
function initializeAnonymousStats() {
    const isAnonymous = document.querySelector('[data-is-anonymous]')?.dataset.isAnonymous === 'true';
    
    if (isAnonymous) {
        const stats = getAnonymousStats();
        
        // Update UI with stored stats
        const totalEntriesEl = document.querySelector('[data-stat="total-entries"]');
        if (totalEntriesEl) {
            totalEntriesEl.textContent = stats.totalEntries;
            if (stats.totalEntries > 0) {
                totalEntriesEl.closest('.stat-card')?.classList.remove('opacity-75');
            }
        }
        
        const totalWordsEl = document.querySelector('[data-stat="total-words"]');
        if (totalWordsEl) {
            totalWordsEl.textContent = stats.totalWords;
            if (stats.totalWords > 0) {
                totalWordsEl.closest('.stat-card')?.classList.remove('opacity-75');
            }
        }
        
        const streakEl = document.querySelector('[data-stat="streak"]');
        if (streakEl) {
            // Check if streak is still valid (entry within last 24 hours)
            if (stats.lastEntryDate) {
                const lastEntry = new Date(stats.lastEntryDate);
                const now = new Date();
                const hoursSinceLastEntry = (now - lastEntry) / (1000 * 60 * 60);
                
                if (hoursSinceLastEntry > 24) {
                    stats.streak = 0; // Reset streak if more than 24 hours
                    saveAnonymousStats(stats);
                }
            }
            
            streakEl.textContent = stats.streak;
            if (stats.streak > 0) {
                streakEl.closest('.stat-card')?.classList.remove('opacity-75');
            }
        }
    }
}

// Fallback function if API fails
function fallbackStatUpdate() {
    console.log('Using fallback stat update');
    
    const totalEntriesEl = document.querySelector('[data-stat="total-entries"]');
    if (totalEntriesEl) {
        const currentEntries = parseInt(totalEntriesEl.textContent) || 0;
        animateStatUpdate(totalEntriesEl, currentEntries + 1);
    }
    
    const streakEl = document.querySelector('[data-stat="streak"]');
    if (streakEl) {
        const currentStreak = parseInt(streakEl.textContent) || 0;
        if (currentStreak === 0) {
            animateStatUpdate(streakEl, 1);
        }
    }
    
    // Estimate word count from the journal entry
    const journalContent = document.getElementById('journalEntry');
    if (journalContent) {
        const wordCount = journalContent.textContent.split(/\s+/).filter(word => word.length > 0).length;
        const totalWordsEl = document.querySelector('[data-stat="total-words"]');
        if (totalWordsEl) {
            const currentWords = parseInt(totalWordsEl.textContent) || 0;
            animateStatUpdate(totalWordsEl, currentWords + wordCount);
        }
    }
}

// Animate stat value changes
function animateStatUpdate(element, newValue) {
    if (!element) return;
    
    const startValue = parseInt(element.textContent) || 0;
    const endValue = parseInt(newValue) || 0;
    const duration = 1000; // 1 second
    const steps = 30;
    const increment = (endValue - startValue) / steps;
    let currentStep = 0;
    
    // Add scale animation
    element.style.transform = 'scale(1.2)';
    element.style.transition = 'transform 0.3s ease';
    
    const timer = setInterval(() => {
        currentStep++;
        if (currentStep <= steps) {
            element.textContent = Math.round(startValue + (increment * currentStep));
        } else {
            element.textContent = endValue;
            clearInterval(timer);
            
            // Reset scale
            setTimeout(() => {
                element.style.transform = 'scale(1)';
            }, 300);
        }
    }, duration / steps);
}

// Save entry - FIXED WITH STATS UPDATE AND LOCALSTORAGE
function saveEntry(event) {
    console.log('=== SAVE ENTRY STARTED ===');
    
    if (event && event.preventDefault) {
        event.preventDefault();
    }

    const isAnonymous = document.querySelector('[data-is-anonymous]')?.dataset.isAnonymous === 'true';
    
    if (isAnonymous) {
        // For anonymous users, save to localStorage (not sessionStorage!)
        const journalContent = document.getElementById('journalEntry').innerHTML.replace(/<br\s*\/?>/gi, '\n');
        const entryTitle = document.getElementById('entryTitle').textContent;
        
        // Get existing entries from localStorage
        const anonymousEntries = getAnonymousEntries();
        const entryId = Date.now().toString();
        
        // Add new entry
        anonymousEntries[entryId] = {
            id: entryId,
            title: entryTitle,
            content: journalContent,
            created_at: new Date().toISOString(),
            wordCount: journalContent.split(/\s+/).filter(word => word.length > 0).length
        };
        
        // Save to localStorage
        saveAnonymousEntries(anonymousEntries);
        
        // Update stats immediately
        updateAnonymousStats();
        
        showToast('Entry saved locally! Your stats are updated. Connect wallet to sync to blockchain.', 'success');
        
        // Show wallet prompt after a delay
        setTimeout(() => {
            if (window.connectWallet) {
                showToast('Connect your wallet to save permanently and earn rewards!', 'info');
            }
        }, 3000);
        
        return;
    }

    const journalContent = document.getElementById('journalEntry').innerHTML.replace(/<br\s*\/?>/gi, '\n');
    const entryTitle = document.getElementById('entryTitle').textContent;

    if (!journalContent) {
        showToast('No content to save', 'error');
        return;
    }

    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', getCsrfToken());
    formData.append('title', entryTitle);
    formData.append('content', journalContent);

    if (currentPhotoFile) {
        formData.append('photo', currentPhotoFile);
    }

    // Get the save button - handle both click from button or function call
    const saveButton = event && event.target ? event.target : document.querySelector('[onclick*="saveEntry"]');
    const originalText = saveButton.innerHTML;
    saveButton.disabled = true;
    saveButton.innerHTML = `
        <svg class="animate-spin h-4 w-4 mr-2 inline-block" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        Saving...
    `;

    console.log('Sending save request to /api/save-entry/');
    
    fetch('/api/save-entry/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCsrfToken()
        },
        credentials: 'include',
        body: formData
    })
    .then(response => {
        console.log('Save response status:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Save response data:', data);
        
        if (data.success) {
            // Update save button to show success
            saveButton.innerHTML = `
                <svg class="w-4 h-4 mr-2 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
                Saved!
            `;

            // Show success message
            showToast('Entry saved successfully!', 'success');
            
            console.log('Entry saved successfully, now updating stats...');
            
            // Update stats immediately without page reload
            updateDashboardStats();

            // Reset the form after a short delay
            setTimeout(() => {
                restartEntry();
                saveButton.disabled = false;
                saveButton.innerHTML = originalText;
                
                // Optionally refresh recent memories section
                refreshRecentMemories();
            }, 2000);
        } else {
            throw new Error(data.error || 'Failed to save entry');
        }
    })
    .catch(error => {
        console.error('Save error:', error);
        saveButton.disabled = false;
        saveButton.innerHTML = originalText;
        showToast(error.message || 'Failed to save entry. Please try again.', 'error');
    });
}

// Function to refresh recent memories section
function refreshRecentMemories() {
    // Simply reload the page after a delay to show updated content
    // This is simpler than creating another API endpoint
    const memoriesSection = document.querySelector('.photo-grid')?.closest('.glass-card');
    if (memoriesSection) {
        const heading = memoriesSection.querySelector('h2');
        if (heading) {
            const originalText = heading.textContent;
            heading.innerHTML = originalText + ' <span class="text-green-600 text-sm ml-2">(New entry added!)</span>';
            setTimeout(() => {
                heading.textContent = originalText;
                // Optional: reload the page to show the new entry
                // window.location.reload();
            }, 3000);
        }
    }
}

// Wallet connection functions
function checkWalletConnection() {
    const isAnonymous = document.querySelector('[data-is-anonymous]')?.dataset.isAnonymous === 'true';
    
    if (!isAnonymous) {
        updateUIForAuthenticatedUser();
        return;
    }
    
    window.addEventListener('walletConnectionChanged', function(event) {
        const { isConnected, address, chainId } = event.detail;
        updateUIForWalletStatus(isConnected, address, chainId);
    });

    setTimeout(() => {
        const walletInfo = getWalletInfo();
        if (walletInfo.isConnected) {
            updateUIForWalletStatus(true, walletInfo.address, walletInfo.chainId);
        }
    }, 500);
}

function updateUIForAuthenticatedUser() {
    const walletPrompts = document.querySelectorAll('.wallet-connection-prompt');
    walletPrompts.forEach(el => el.style.display = 'none');
    
    const authContent = document.querySelectorAll('.authenticated-only');
    authContent.forEach(el => el.style.display = 'block');
}

function updateUIForWalletStatus(isConnected, address, chainId) {
    const walletButtons = document.querySelectorAll('[data-wallet-action]');
    walletButtons.forEach(button => {
        if (isConnected) {
            button.textContent = `${address.slice(0, 6)}...${address.slice(-4)}`;
        }
    });
}

function getWalletInfo() {
    const userElement = document.querySelector('[data-user-authenticated]');
    if (userElement && userElement.dataset.userAuthenticated === 'true') {
        return {
            isConnected: true,
            address: userElement.dataset.walletAddress || null,
            chainId: parseInt(userElement.dataset.chainId) || 8453
        };
    }
    
    if (window.ethereum && window.ethereum.selectedAddress) {
        return {
            isConnected: true,
            address: window.ethereum.selectedAddress,
            chainId: window.ethereum.chainId ? parseInt(window.ethereum.chainId, 16) : null
        };
    }
    
    const walletSession = localStorage.getItem('walletSession');
    if (walletSession) {
        try {
            const session = JSON.parse(walletSession);
            if (session.address) {
                return {
                    isConnected: true,
                    address: session.address,
                    chainId: session.chainId || null
                };
            }
        } catch (e) {
            // Invalid session data
        }
    }
    
    return {
        isConnected: false,
        address: null,
        chainId: null
    };
}

function connectWallet() {
    if (window.connectWeb3Wallet) {
        window.connectWeb3Wallet();
    } else if (window.ethereum) {
        window.ethereum.request({ method: 'eth_requestAccounts' })
            .then(accounts => {
                if (accounts.length > 0) {
                    showToast('Wallet connected successfully!', 'success');
                    window.location.reload();
                }
            })
            .catch(error => {
                showToast('Failed to connect wallet', 'error');
            });
    } else {
        showToast('No wallet detected. Please install MetaMask or another Web3 wallet.', 'error');
    }
}

// Utility functions
function getCsrfToken() {
    const token = document.querySelector('[name=csrfmiddlewaretoken]');
    return token ? token.value : '';
}

function calculateRewards(content) {
    const wordCount = content.split(' ').length;
    const baseReward = Math.floor(wordCount / 10);
    const bonusReward = wordCount > 100 ? 5 : 0;
    return baseReward + bonusReward;
}

function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg transform transition-all duration-300 z-50 translate-x-full`;
    
    switch(type) {
        case 'success':
            toast.className += ' bg-green-500 text-white';
            break;
        case 'error':
            toast.className += ' bg-red-500 text-white';
            break;
        case 'warning':
            toast.className += ' bg-yellow-500 text-white';
            break;
        default:
            toast.className += ' bg-blue-500 text-white';
    }

    toast.innerHTML = `
        <div class="flex items-center gap-3">
            <span>${message}</span>
            <button onclick="this.parentElement.parentElement.remove()" class="ml-2 hover:opacity-75">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
            </button>
        </div>
    `;

    document.body.appendChild(toast);

    setTimeout(() => {
        toast.style.transform = 'translateX(0)';
    }, 10);

    setTimeout(() => {
        toast.style.transform = 'translateX(100%)';
        setTimeout(() => toast.remove(), 300);
    }, 5000);
}

// Initialize animations
function initializeAnimations() {
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.add('animate-fade-in');
                observer.unobserve(entry.target);
            }
        });
    }, {
        threshold: 0.1,
        rootMargin: '50px'
    });

    document.querySelectorAll('.animate-on-scroll').forEach(el => {
        observer.observe(el);
    });
}

// Auto-resize textarea
document.addEventListener('input', function(e) {
    if (e.target.id === 'journalInput') {
        e.target.style.height = 'auto';
        e.target.style.height = Math.min(e.target.scrollHeight, 400) + 'px';
    }
});

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        const journalInput = document.getElementById('journalInput');
        if (journalInput && journalInput === document.activeElement) {
            e.preventDefault();
            generateEntry();
        }
    }

    if (e.key === 'Escape') {
        const resultPreview = document.getElementById('resultPreview');
        if (resultPreview && !resultPreview.classList.contains('hidden')) {
            restartEntry();
        }
    }
});

// Smooth scroll for anchor links
document.querySelectorAll('a[href^="#"]').forEach(anchor => {
    anchor.addEventListener('click', function(e) {
        e.preventDefault();
        const target = document.querySelector(this.getAttribute('href'));
        if (target) {
            target.scrollIntoView({
                behavior: 'smooth',
                block: 'center'
            });
        }
    });
});

// Export functions for global use
window.countChars = countChars;
window.addSuggestion = addSuggestion;
window.previewPhoto = previewPhoto;
window.removePhoto = removePhoto;
window.generateEntry = generateEntry;
window.editJournalEntry = editJournalEntry;
window.restartEntry = restartEntry;
window.saveEntry = saveEntry;
window.connectWallet = connectWallet;
window.showToast = showToast;
window.updateDashboardStats = updateDashboardStats;
window.animateStatUpdate = animateStatUpdate;
</script>
{% endblock %}