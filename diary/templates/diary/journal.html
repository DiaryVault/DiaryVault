{% extends "base.html" %}

{% block title %}{% if is_edit_mode %}Edit Entry{% else %}New Entry{% endif %} - DiaryVault{% endblock %}

{% block extra_css %}
<style>
  /* SCROLL FIX: Remove conflicting scroll behaviors */
  html, body {
    overflow-x: visible !important;
    scroll-behavior: smooth !important;
  }

  #main-content {
    min-height: auto;
    overflow: visible;
  }

  /* Core branding elements */
  .diary-font {
    font-family: 'Playfair Display', serif;
    letter-spacing: -0.01em;
    line-height: 1.5;
  }

  .handwritten {
    font-family: 'Satisfy', cursive;
    letter-spacing: 0.01em;
    line-height: 1.7;
  }

  /* Enhanced animations - REDUCED for better scroll performance */
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @keyframes scaleIn {
    from { opacity: 0; transform: scale(0.98); }
    to { opacity: 1; transform: scale(1); }
  }

  @keyframes float {
    0% { transform: translateY(0px) translateZ(0); }
    50% { transform: translateY(-8px) translateZ(0); }
    100% { transform: translateY(0px) translateZ(0); }
  }

  .animate-fade-in {
    animation: fadeIn 0.6s ease forwards;
    will-change: transform, opacity;
  }

  .animate-scale-in {
    animation: scaleIn 0.4s ease forwards;
    will-change: transform, opacity;
  }

  .animate-float {
    animation: float 4s ease-in-out infinite;
    will-change: transform;
  }

  .animation-delay-300 {
    animation-delay: 300ms;
  }

  .animation-delay-500 {
    animation-delay: 500ms;
  }

  .animation-delay-700 {
    animation-delay: 700ms;
  }

  /* Enhanced shadows and hover effects - OPTIMIZED */
  .btn-gradient {
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    transform: translateZ(0);
  }

  .btn-gradient:hover {
    background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
    transform: translateY(-2px) translateZ(0);
    box-shadow: 0 8px 20px -5px rgba(99, 102, 241, 0.4);
  }

  .card-hover {
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    transform: translateZ(0);
  }

  .card-hover:hover {
    transform: translateY(-4px) translateZ(0);
    box-shadow: 0 15px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -5px rgba(0, 0, 0, 0.04);
  }

  /* SCROLL FIX: Input container improvements */
  #journalContainer {
    box-sizing: border-box;
    overflow: visible;
    position: relative;
    transition: all 0.2s ease-in-out;
    border-color: rgba(99, 102, 241, 0.3);
    max-height: none;
  }

  #journalContainer.input-focused {
    border-color: #6366f1 !important;
    box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2) !important;
  }

  #journalInput {
    box-sizing: border-box;
    outline: none !important;
    border: none !important;
    width: 100%;
    overflow-y: auto;
    resize: none;
    max-height: 400px;
  }

  #journalInput:focus {
    outline: none !important;
    box-shadow: none !important;
    border-color: transparent !important;
  }

  /* Photo preview container */
  #photoPreviewContainer {
    border-top-left-radius: 0;
    border-top-right-radius: 0;
    border-bottom-left-radius: 0.75rem;
    border-bottom-right-radius: 0.75rem;
  }

  /* Toast notification system - OPTIMIZED */
  .feedback-toast {
    padding: 0.75rem 1rem;
    border-radius: 0.5rem;
    box-shadow: 0 8px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    transform: translateX(100%) translateZ(0);
    opacity: 0;
    transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    display: flex;
    align-items: center;
    gap: 0.5rem;
    max-width: 18rem;
    will-change: transform, opacity;
  }

  .feedback-toast.show {
    transform: translateX(0) translateZ(0);
    opacity: 1;
  }

  .feedback-toast.success {
    background-color: #10b981;
    color: white;
  }

  .feedback-toast.error {
    background-color: #ef4444;
    color: white;
  }

  .feedback-toast.info {
    background-color: #6366f1;
    color: white;
  }

  .feedback-toast.warning {
    background-color: #f59e0b;
    color: white;
  }

  /* Enhanced form styling */
  .floating-label {
    position: relative;
    margin-bottom: 1.25rem;
  }

  .floating-label input,
  .floating-label textarea {
    width: 100%;
    padding: 1rem 1rem 0.5rem 1rem;
    border: 1px solid #e5e7eb;
    border-radius: 0.75rem;
    background-color: #f9fafb;
    font-size: 1rem;
    transition: all 0.3s ease;
    font-family: 'Playfair Display', serif;
  }

  .floating-label label {
    position: absolute;
    top: 1rem;
    left: 1rem;
    font-size: 1rem;
    color: #6b7280;
    pointer-events: none;
    transition: all 0.3s ease;
    background-color: transparent;
  }

  .floating-label input:focus,
  .floating-label textarea:focus,
  .floating-label input:not(:placeholder-shown),
  .floating-label textarea:not(:placeholder-shown) {
    padding-top: 1.5rem;
    padding-bottom: 0.5rem;
    border-color: #6366f1;
    background-color: white;
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
  }

  .floating-label input:focus ~ label,
  .floating-label textarea:focus ~ label,
  .floating-label input:not(:placeholder-shown) ~ label,
  .floating-label textarea:not(:placeholder-shown) ~ label {
    top: 0.5rem;
    left: 0.8rem;
    font-size: 0.75rem;
    color: #6366f1;
    font-weight: 500;
  }

  /* Modern Photo Upload */
  .photo-upload-modern {
    position: relative;
    margin: 1.5rem 0;
    border-radius: 0.75rem;
    background: #f9fafb;
    border: 2px dashed #d1d5db;
    transition: all 0.3s ease;
    overflow: hidden;
  }

  .photo-upload-modern:hover {
    border-color: #6366f1;
    background-color: rgba(99, 102, 241, 0.05);
  }

  .photo-upload-input {
    display: none;
  }

  .photo-upload-label {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 2rem;
    cursor: pointer;
    height: 12rem;
  }

  .photo-upload-icon {
    width: 3rem;
    height: 3rem;
    color: #9ca3af;
    margin-bottom: 1rem;
  }

  .photo-upload-text {
    color: #6b7280;
    text-align: center;
  }

  .photo-upload-text strong {
    color: #6366f1;
  }

  .photo-preview-modern {
    width: 100%;
    height: 12rem;
    object-fit: cover;
    display: none;
  }

  .photo-preview-modern.has-image {
    display: block;
  }

  .photo-controls-modern {
    position: absolute;
    top: 0.75rem;
    right: 0.75rem;
    display: flex;
    gap: 0.5rem;
    opacity: 0;
    transition: all 0.3s ease;
  }

  .photo-upload-modern:hover .photo-controls-modern {
    opacity: 1;
  }

  .photo-control-btn-modern {
    background-color: rgba(255, 255, 255, 0.9);
    border-radius: 50%;
    width: 2rem;
    height: 2rem;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    transition: all 0.3s ease;
    border: none;
  }

  .photo-control-btn-modern:hover {
    transform: scale(1.1);
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
  }

  /* Modern Mood Selector */
  .mood-selector-container {
    position: relative;
    margin: 1.5rem 0;
  }

  .mood-slider {
    position: relative;
    height: 5rem;
    background: linear-gradient(to right,
      #4ade80 0%,
      #a78bfa 50%,
      #f87171 100%
    );
    border-radius: 0.75rem;
    margin-top: 0.5rem;
  }

  .mood-slider-track {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 100%;
    height: 0.5rem;
    background: rgba(255, 255, 255, 0.5);
    border-radius: 999px;
  }

  .mood-slider-thumb {
    position: absolute;
    top: 50%;
    transform: translate(-50%, -50%);
    width: 3rem;
    height: 3rem;
    background: white;
    border-radius: 50%;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    transition: transform 0.2s ease;
    z-index: 10;
  }

  .mood-slider-thumb:hover {
    transform: translate(-50%, -50%) scale(1.1);
  }

  .mood-labels {
    display: flex;
    justify-content: space-between;
    margin-top: 0.5rem;
  }

  .mood-labels span {
    font-size: 0.8rem;
    color: #6b7280;
  }

  /* Tags Input Modern */
  .tags-container {
    position: relative;
    margin-top: 1rem;
  }

  .tags-input {
    width: 100%;
    padding: 0.75rem;
    border-radius: 0.5rem;
    border: 1px solid #d1d5db;
    transition: all 0.3s ease;
    font-family: 'Playfair Display', serif;
  }

  .tags-input:focus {
    border-color: #6366f1;
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
    outline: none;
  }

  .tags-pills {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 0.75rem;
  }

  .tag-pill {
    display: inline-flex;
    align-items: center;
    padding: 0.375rem 0.75rem;
    background: rgba(99, 102, 241, 0.1);
    color: #4f46e5;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 500;
    transition: all 0.3s ease;
  }

  .tag-pill:hover {
    background: #6366f1;
    color: white;
  }

  .tag-pill .remove-tag {
    margin-left: 0.25rem;
    cursor: pointer;
  }

  .tag-suggestions {
    margin-top: 0.75rem;
  }

  .tag-suggestion {
    display: inline-block;
    padding: 0.375rem 0.75rem;
    margin-right: 0.5rem;
    margin-bottom: 0.5rem;
    background-color: #f9fafb;
    border: 1px solid #d1d5db;
    border-radius: 9999px;
    font-size: 0.75rem;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .tag-suggestion:hover {
    background-color: rgba(99, 102, 241, 0.1);
    border-color: #6366f1;
    color: #4f46e5;
  }

  /* Button Styles */
  .btn-modern {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0.75rem 1.5rem;
    border-radius: 0.5rem;
    font-weight: 500;
    transition: all 0.3s ease;
    cursor: pointer;
    transform: translateZ(0);
  }

  .btn-primary {
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    color: white;
    border: none;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
  }

  .btn-primary:hover {
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    transform: translateY(-2px) translateZ(0);
  }

  .btn-secondary {
    background: white;
    color: #374151;
    border: 1px solid #d1d5db;
  }

  .btn-secondary:hover {
    background: #f9fafb;
    border-color: #9ca3af;
  }

  /* Animation for auto-populated content */
  @keyframes fadeHighlight {
    0% { background-color: rgba(99, 102, 241, 0.2); }
    100% { background-color: transparent; }
  }

  .auto-populated {
    animation: fadeHighlight 2s ease;
  }

  /* Content Editor */
  .content-editor {
    position: relative;
    margin-bottom: 1.5rem;
  }

  .content-editor-container {
    border: 1px solid #d1d5db;
    border-radius: 0.75rem;
    overflow: hidden;
    transition: all 0.3s ease;
  }

  .content-editor-container:focus-within {
    border-color: #6366f1;
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
  }

  .content-editor-textarea {
    width: 100%;
    min-height: 300px;
    padding: 1rem;
    border: none;
    resize: vertical;
    font-family: 'Satisfy', cursive;
    font-size: 1.125rem;
    color: #1f2937;
    background-color: white;
  }

  .content-editor-textarea:focus {
    outline: none;
  }

  .word-counter {
    position: absolute;
    bottom: 0.5rem;
    right: 0.5rem;
    font-size: 0.75rem;
    color: #9ca3af;
    background: white;
    padding: 0.25rem 0.5rem;
    border-radius: 0.375rem;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
  }

  /* Better chat bubbles - OPTIMIZED */
  .chat-bubble {
    will-change: transform;
    transform: translateZ(0);
    transition: all 0.2s ease;
    position: relative;
    padding: 1rem 1.5rem;
    border-radius: 1.25rem;
    max-width: 85%;
    margin-bottom: 1rem;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  }

  .chat-bubble:hover {
    transform: scale(1.01) translateZ(0);
  }

  .chat-bubble.ai {
    background-color: rgba(243, 244, 246, 0.8);
    backdrop-filter: blur(8px);
    border: 1px solid rgba(255, 255, 255, 0.5);
    align-self: flex-start;
    border-bottom-left-radius: 0.25rem;
    border-top-right-radius: 1.5rem;
    box-shadow: 0 4px 15px -3px rgba(0, 0, 0, 0.1);
  }

  .chat-bubble.user {
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    color: white;
    align-self: flex-end;
    border-bottom-right-radius: 0.25rem;
    border-top-left-radius: 1.5rem;
    margin-left: auto;
    box-shadow: 0 4px 15px -3px rgba(0, 0, 0, 0.15);
  }

  /* Fixed Input Container Styles */
  .input-tools {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem;
    border-top: 1px solid #e5e7eb;
    background: #f9fafb;
    border-bottom-left-radius: 0.75rem;
    border-bottom-right-radius: 0.75rem;
  }

  .tool-button {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 2.5rem;
    height: 2.5rem;
    border-radius: 0.5rem;
    background: white;
    border: 1px solid #e5e7eb;
    color: #6b7280;
    transition: all 0.2s ease;
    cursor: pointer;
    flex-shrink: 0;
  }

  .tool-button:hover {
    background: #f3f4f6;
    color: #4f46e5;
    border-color: #c7d2fe;
  }

  .tool-button.active {
    background: #6366f1;
    color: white;
    border-color: #6366f1;
  }

  .voice-recording {
    background: #ef4444 !important;
    color: white !important;
    animation: pulse 1.5s infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
  }

  .send-button {
    margin-left: auto;
  }

  .character-counter {
    font-size: 0.75rem;
    color: #9ca3af;
    display: flex;
    align-items: center;
    gap: 0.25rem;
  }

  .shortcuts-hint {
    font-size: 0.75rem;
    color: #9ca3af;
    display: flex;
    align-items: center;
    gap: 0.25rem;
  }

  .shortcut-key {
    background: #f3f4f6;
    border: 1px solid #d1d5db;
    border-radius: 0.25rem;
    padding: 0.125rem 0.25rem;
    font-family: monospace;
    font-size: 0.625rem;
  }

  /* Enhanced input container */
  .enhanced-input-container {
    border: 2px solid #e5e7eb;
    border-radius: 0.75rem;
    background: white;
    transition: all 0.2s ease;
    overflow: hidden;
  }

  .enhanced-input-container:focus-within {
    border-color: #6366f1;
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
  }

  /* SCROLL FIX: Mobile optimizations */
  @media (max-width: 640px) {
    input, textarea, select {
      font-size: 16px !important;
      padding-top: 0.75rem;
      padding-bottom: 0.75rem;
    }

    .card-hover {
      margin-bottom: 1rem;
    }

    .suggestions-pill {
      min-height: 36px;
      padding: 0.4rem 0.8rem;
    }

    #journalContainer {
      min-height: 120px;
      max-height: 300px;
    }

    #journalInput {
      max-height: 280px;
    }

    button,
    .suggestions-pill,
    input[type="checkbox"] + label,
    .card-hover,
    .btn-gradient {
      min-height: 44px;
      min-width: 44px;
    }

    .mobile-friendly-padding {
      padding: 0.75rem !important;
    }

    .form-group {
      margin-bottom: 1.25rem;
    }

    body {
      overflow-x: visible !important;
      -webkit-overflow-scrolling: touch;
    }

    .shortcuts-hint {
      display: none !important;
    }
  }

  /* Loading spinner improvements */
  @keyframes pulse-ring {
    0% {
      transform: scale(0.8);
      opacity: 0;
    }
    50% {
      opacity: 0.5;
    }
    100% {
      transform: scale(1.3);
      opacity: 0;
    }
  }

  .loading-pulse-ring::before {
    content: '';
    position: absolute;
    inset: -4px;
    border-radius: 50%;
    background: rgba(99, 102, 241, 0.3);
    animation: pulse-ring 2s cubic-bezier(0.455, 0.03, 0.515, 0.955) infinite;
  }

  /* Animation for loading dots */
  .loading-dots:after {
    content: '.';
    animation: dots 1.5s steps(5, end) infinite;
  }

  @keyframes dots {
    0%, 20% { content: '.'; }
    40% { content: '..'; }
    60% { content: '...'; }
    80%, 100% { content: ''; }
  }

  /* Enhanced chat bubbles */
  .chat-container {
    max-height: 400px;
    overflow-y: auto;
    padding-right: 0.5rem;
  }

  .chat-container::-webkit-scrollbar {
    width: 4px;
  }

  .chat-container::-webkit-scrollbar-track {
    background: rgba(241, 245, 249, 0.5);
    border-radius: 4px;
  }

  .chat-container::-webkit-scrollbar-thumb {
    background: rgba(99, 102, 241, 0.3);
    border-radius: 4px;
  }

  /* Custom scrollbar */
  ::-webkit-scrollbar {
    width: 8px;
    height: 8px;
  }

  ::-webkit-scrollbar-track {
    background: rgba(241, 245, 249, 0.5);
    border-radius: 4px;
  }

  ::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, #6366f1, #4f46e5);
    border-radius: 4px;
    transition: background 0.3s ease;
  }

  ::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(135deg, #4f46e5, #4338ca);
  }

  /* Focus states */
  :focus {
    outline: 2px solid #6366f1 !important;
    outline-offset: 2px;
  }

  :focus:not(:focus-visible) {
    outline: none !important;
  }

  :focus-visible {
    outline: 2px solid #6366f1 !important;
    outline-offset: 2px;
  }
</style>
{% endblock %}

{% block content %}
<!-- Skip link for accessibility -->
<a href="#main-content" class="sr-only focus:not-sr-only focus:absolute focus:top-0 focus:left-0 focus:z-50 focus:px-4 focus:py-2 focus:bg-white focus:text-secondary-600 focus:outline-offset-0">Skip to main content</a>

<!-- SCROLL FIX: Simplified main container -->
<div id="main-content" class="max-w-4xl w-full mx-auto relative">
  <!-- Enhanced decorative elements - REDUCED for performance -->
  <div class="hidden sm:block absolute -top-10 -left-16 h-48 w-48 bg-secondary-300 rounded-full mix-blend-multiply filter blur-xl opacity-15 animate-blob"></div>
  <div class="hidden sm:block absolute -bottom-32 -right-16 h-48 w-48 bg-primary-300 rounded-full mix-blend-multiply filter blur-xl opacity-15 animate-blob animation-delay-500"></div>
  <div class="absolute top-1/3 left-1/3 h-16 w-16 sm:h-20 sm:w-20 bg-amber-300 rounded-full mix-blend-multiply filter blur-xl opacity-10 animate-blob animation-delay-700"></div>

  <!-- Enhanced feedback container -->
  <div id="feedback-container" class="fixed bottom-4 right-4 flex flex-col gap-2 z-50">
    <!-- Feedback toasts will be added here dynamically -->
  </div>

  {% if messages %}
    <div class="mb-6">
      {% for message in messages %}
        {% if message.tags != 'success' or "signed in" not in message.message %}
          <div class="{% if message.tags == 'error' %}bg-red-100 border-red-400 text-red-700{% elif message.tags == 'success' %}bg-green-100 border-green-400 text-green-700{% else %}bg-blue-100 border-blue-400 text-blue-700{% endif %} px-4 py-3 rounded-xl shadow-sm border mb-4 animate-scale-in">
            {{ message }}
          </div>
        {% endif %}
      {% endfor %}
    </div>
  {% endif %}

  <!-- Header with date -->
  <div class="text-center mb-10 relative z-10">
    <div class="inline-block mb-3 animate-pulse">
      <span class="px-3 py-1 bg-white/50 backdrop-blur-sm rounded-full text-xs font-medium text-gray-500 shadow-sm border border-white/50">
        {{ today|date:"l, F j, Y" }}
      </span>
    </div>
    <h2 class="text-2xl sm:text-3xl font-bold text-gray-800 diary-font mb-2 animate-fade-in">
      {% if is_edit_mode %}Edit Your Journal Entry{% else %}Create Your Journal Entry{% endif %}
    </h2>
    <p class="text-gray-600 text-sm max-w-md mx-auto animate-fade-in animation-delay-300">
      {% if is_edit_mode %}
        Update your thoughts and feelings for this entry
      {% else %}
        Share your thoughts, feelings and experiences - our AI will help you create a beautiful journal entry
      {% endif %}
    </p>
  </div>

  <!-- Advanced AI Chat area for journal generation (visible if not in edit mode) -->
  {% if not is_edit_mode %}
  <div id="chatArea" class="mb-8 space-y-4 animate-fade-in">
    <div class="bg-white rounded-xl sm:rounded-2xl shadow-xl overflow-hidden border border-white transition-all hover:shadow-2xl card-hover">
      <!-- Enhanced Chat Header with AI Status -->
      <div class="bg-gradient-to-r from-secondary-50 to-primary-50 px-4 sm:px-6 py-4 border-b border-white flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="relative">
            <div class="w-10 h-10 bg-gradient-to-br from-secondary-500 to-primary-500 rounded-full flex items-center justify-center shadow-md">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
              </svg>
            </div>
            <div class="absolute -bottom-1 -right-1 w-4 h-4 bg-green-400 rounded-full border-2 border-white animate-pulse" id="aiStatusIndicator"></div>
          </div>
          <div>
            <h3 class="font-semibold text-gray-800 flex items-center gap-2">
              AI Journal Assistant
              <span class="px-2 py-0.5 bg-green-100 text-green-700 text-xs rounded-full font-medium">Online</span>
            </h3>
            <p class="text-xs text-gray-600 mt-0.5" id="aiStatusText">Ready to help you create amazing journal entries</p>
          </div>
        </div>
        <div class="text-xs font-medium bg-white/50 px-3 py-1 rounded-full text-gray-500 flex items-center gap-1 shadow-inner">
          <span id="quickCharCount">0</span>
          <span>characters</span>
          <span class="text-gray-400 ml-1">(min. 10)</span>
        </div>
      </div>

      <!-- Enhanced Chat Container with Smart Features -->
      <div class="p-4 sm:p-6">
        <!-- Smart Conversation Starter -->
        <div id="conversationStarter" class="mb-4 bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-xl border border-blue-200">
          <div class="flex items-start gap-3">
            <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
              </svg>
            </div>
            <div class="flex-1">
              <h4 class="text-sm font-semibold text-blue-900 mb-2">Let's create something amazing together!</h4>
              <div class="space-y-2">
                <button onclick="useQuickStart('daily-reflection')" class="w-full text-left p-3 bg-white rounded-lg border border-blue-200 hover:border-blue-300 hover:bg-blue-50 transition-all group">
                  <div class="flex items-center justify-between">
                    <div>
                      <div class="font-medium text-gray-800 text-sm">📝 Daily Reflection</div>
                      <div class="text-xs text-gray-600">Reflect on your day's experiences and emotions</div>
                    </div>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-blue-500 group-hover:translate-x-1 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                    </svg>
                  </div>
                </button>
                <button onclick="useQuickStart('gratitude-practice')" class="w-full text-left p-3 bg-white rounded-lg border border-blue-200 hover:border-blue-300 hover:bg-blue-50 transition-all group">
                  <div class="flex items-center justify-between">
                    <div>
                      <div class="font-medium text-gray-800 text-sm">🙏 Gratitude Practice</div>
                      <div class="text-xs text-gray-600">Focus on what you're thankful for today</div>
                    </div>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-blue-500 group-hover:translate-x-1 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                    </svg>
                  </div>
                </button>
                <button onclick="useQuickStart('goal-tracking')" class="w-full text-left p-3 bg-white rounded-lg border border-blue-200 hover:border-blue-300 hover:bg-blue-50 transition-all group">
                  <div class="flex items-center justify-between">
                    <div>
                      <div class="font-medium text-gray-800 text-sm">🎯 Goal & Progress</div>
                      <div class="text-xs text-gray-600">Track your goals and celebrate achievements</div>
                    </div>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-blue-500 group-hover:translate-x-1 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                    </svg>
                  </div>
                </button>
                <button onclick="useQuickStart('free-form')" class="w-full text-left p-3 bg-white rounded-lg border border-blue-200 hover:border-blue-300 hover:bg-blue-50 transition-all group">
                  <div class="flex items-center justify-between">
                    <div>
                      <div class="font-medium text-gray-800 text-sm">✨ Free Form</div>
                      <div class="text-xs text-gray-600">Just tell me about your day in your own words</div>
                    </div>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-blue-500 group-hover:translate-x-1 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                    </svg>
                  </div>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Advanced Chat Container -->
        <div class="chat-container" id="chatContainer">
          <!-- AI Introduction Message -->
          <div class="chat-bubble ai" id="initialGreeting">
            <div class="flex items-start gap-3">
              <div class="w-8 h-8 bg-gradient-to-br from-secondary-400 to-primary-400 rounded-full flex items-center justify-center flex-shrink-0 mt-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                </svg>
              </div>
              <div class="flex-1">
                <p class="handwritten text-gray-800 text-lg leading-relaxed mb-2">
                  Hello! I'm your personal journal assistant. I'm here to help you create beautiful, meaningful journal entries.
                </p>
                <p class="handwritten text-gray-700 text-base leading-relaxed">
                  Choose a template above to get started, or simply tell me about your day. I'll ask thoughtful questions to help you explore your experiences and emotions deeply.
                </p>
              </div>
            </div>
          </div>

          <!-- Dynamic conversation history -->
          <div id="chatHistory"></div>

          <!-- Enhanced thinking indicator -->
          <div class="chat-bubble ai hidden" id="thinkingIndicator">
            <div class="flex items-start gap-3">
              <div class="w-8 h-8 bg-gradient-to-br from-secondary-400 to-primary-400 rounded-full flex items-center justify-center flex-shrink-0 mt-1">
                <div class="w-4 h-4 relative">
                  <div class="absolute inset-0 rounded-full border-2 border-white border-t-transparent animate-spin"></div>
                </div>
              </div>
              <div class="flex-1">
                <div class="flex items-center gap-2">
                  <div class="flex gap-1">
                    <div class="w-2 h-2 bg-secondary-500 rounded-full animate-bounce"></div>
                    <div class="w-2 h-2 bg-secondary-500 rounded-full animate-bounce" style="animation-delay: 0.1s;"></div>
                    <div class="w-2 h-2 bg-secondary-500 rounded-full animate-bounce" style="animation-delay: 0.2s;"></div>
                  </div>
                  <span class="handwritten text-gray-600" id="thinkingText">Thinking deeply about your experience...</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Enhanced Smart Input Container -->
        <div class="mt-6 space-y-4">
          <!-- Enhanced Smart Input Container -->
          <div class="relative">
            <div class="enhanced-input-container">
              <!-- Input Header with Context -->
              <div id="inputContext" class="hidden px-4 py-2 bg-gray-50 border-b border-gray-200 text-sm text-gray-600">
                <span id="contextText"></span>
              </div>

              <!-- Main Textarea -->
              <textarea id="quickNotes" class="w-full p-4 border-0 focus:ring-0 focus:outline-none handwritten bg-transparent text-lg resize-none min-h-[100px]"
                placeholder="Share what's on your mind..."
                oninput="handleSmartInput(this)"
                onkeydown="handleKeyboardShortcuts(event)"
                rows="3"></textarea>

              <!-- Fixed Input Tools Bar -->
              <div class="input-tools">
                <!-- Voice Input Button -->
                <button type="button" id="voiceInputBtn" class="tool-button" onclick="toggleVoiceInput()" title="Voice Input">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                  </svg>
                </button>

                <!-- Photo Upload Tool -->
                <button type="button" class="tool-button" onclick="document.getElementById('quickPhotoInput').click()" title="Add Photo">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                  </svg>
                </button>
                <input type="file" id="quickPhotoInput" class="hidden" accept="image/*" onchange="handleQuickFileSelect(this)">

                <!-- Character Counter -->
                <div class="character-counter">
                  <span id="quickCharCount">0</span>/2000
                </div>

                <!-- Smart Suggestion Indicator -->
                <span id="smartSuggestion" class="text-secondary-600 italic hidden text-xs"></span>

                <!-- Keyboard Shortcuts Hint -->
                <div class="shortcuts-hint hidden sm:flex">
                  <span>Press</span>
                  <kbd class="shortcut-key">Ctrl+Enter</kbd>
                  <span>to send</span>
                </div>

                <!-- Smart Send Button -->
                <button type="button" class="btn-gradient text-white tool-button send-button"
                        id="smartSendBtn"
                        onclick="handleSmartSend()"
                        disabled
                        title="Send Message">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                  </svg>
                </button>
              </div>
            </div>
          </div>

          <!-- Enhanced Photo Preview -->
          <div id="quickPhotoContainer" class="hidden mt-4">
            <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
              <div class="relative">
                <img id="quickPhotoPreview" class="w-full max-h-60 object-cover" src="" alt="Photo preview">
                <div class="absolute inset-0 bg-gradient-to-t from-black/20 via-transparent to-transparent"></div>
              </div>
              <div class="p-4 bg-gray-50 flex items-center justify-between">
                <div class="flex-1">
                  <div class="font-medium text-gray-800" id="quickPhotoName">photo.jpg</div>
                  <div class="text-sm text-gray-600">This will be included with your journal entry</div>
                </div>
                <div class="flex gap-2">
                  <button type="button" class="tool-button" onclick="document.getElementById('quickPhotoInput').click()" title="Change photo">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                    </svg>
                  </button>
                  <button type="button" class="tool-button hover:bg-red-50 hover:border-red-200 hover:text-red-600" onclick="removeQuickPhoto()" title="Remove photo">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Smart Topic Suggestions -->
          <div id="smartTopics" class="space-y-3">
            <div class="text-xs font-medium text-gray-700 mb-2 flex items-center gap-1.5">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 text-secondary-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
              </svg>
              <span>Smart suggestions based on your writing:</span>
            </div>
            <div class="flex flex-wrap gap-2" id="dynamicSuggestions">
              <!-- Dynamic suggestions will be added here -->
            </div>
          </div>
        </div>
      </div>

      <!-- Advanced Action Footer -->
      <div class="bg-gradient-to-r from-secondary-50 to-primary-50 p-4 border-t border-white">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <div class="text-xs text-gray-600 flex items-center gap-1">
              <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
              <span>AI is ready</span>
            </div>
            <div class="text-xs text-gray-500">|</div>
            <div class="text-xs text-gray-600" id="conversationProgress">
              Ready to start your journal
            </div>
          </div>
          <button type="button" id="useManualFormBtn" onclick="switchToManualForm()" class="btn-modern btn-secondary flex items-center gap-2 text-sm">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
            </svg>
            <span>Write manually</span>
          </button>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Enhanced loading indicator with better animations -->
  <div id="loadingIndicator" class="mt-6 sm:mt-12 hidden animate-fade-in">
    <div class="flex flex-col items-center justify-center p-4 sm:p-8 bg-white/70 backdrop-blur-sm rounded-xl shadow-lg border border-white">
      <div class="relative">
        <div class="w-12 sm:w-16 h-12 sm:h-16 border-4 border-secondary-200 border-t-secondary-600 rounded-full animate-spin mb-4"></div>
        <div class="absolute inset-0 bg-secondary-100 rounded-full scale-125 animate-ping opacity-30"></div>
      </div>
      <p class="text-center text-gray-600 handwritten text-lg sm:text-xl">Crafting your journal entry<span class="loading-dots"></span></p>
      <p class="text-center text-gray-500 text-sm mt-2">This takes just a moment</p>
    </div>
  </div>

  <!-- Enhanced Main entry form with improved styling -->
  <form method="post" enctype="multipart/form-data" id="journalForm" class="w-full relative z-10 animate-scale-in {% if not is_edit_mode %}hidden{% endif %}">
    {% csrf_token %}
    <div class="bg-white rounded-xl sm:rounded-2xl shadow-xl overflow-hidden border border-white transition-all hover:shadow-2xl card-hover">
      <div class="p-3 sm:p-6">
        <!-- Header section with responsive layout -->
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-3 gap-2">
          <h3 class="font-semibold text-gray-800 flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-secondary-500" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM7 9a1 1 0 100-2 1 1 0 000 2zm7-1a1 1 0 11-2 0 1 1 0 012 0zm-.464 5.535a1 1 0 10-1.415-1.414 3 3 0 01-4.242 0 1 1 0 00-1.415 1.414 5 5 0 007.072 0z" clip-rule="evenodd" />
            </svg>
            Journal Entry Details
          </h3>
          <div class="text-xs font-medium bg-gray-100 px-3 py-1 rounded-full text-gray-500 flex items-center gap-1 shadow-inner w-fit">
            <span id="charCount">{{ form.content.value|length|default:0 }}</span>
            <span>characters</span>
          </div>
        </div>

        <!-- Title field with floating label -->
        <div class="form-field mb-6">
          <div class="floating-label">
            <input type="text" id="id_title" name="title" placeholder=" "
                  class="focus:ring-primary-color focus:border-primary-color"
                  value="{{ form.title.value|default:'' }}">
            <label for="id_title">Journal Title</label>
          </div>
          {% if form.title.errors %}
            <p class="text-red-600 text-xs mt-1">{{ form.title.errors.0 }}</p>
          {% endif %}
        </div>

        <!-- SCROLL FIX: Enhanced integrated input container -->
        <div id="journalContainer" class="relative border border-gray-200 rounded-xl focus-within:border-secondary-400 transition bg-gray-50/50 min-h-[200px] sm:min-h-[300px] shadow-inner mb-6">
          <!-- SCROLL FIX: Input textarea with improved styling -->
          <textarea
            id="journalInput"
            name="content"
            class="input-area w-full p-3 sm:p-4 border-0 focus:ring-0 focus:outline-none handwritten bg-transparent min-h-[200px] sm:min-h-[300px] resize-none text-lg"
            placeholder="Tell me about your day... What did you do? How did you feel? What are you grateful for?"
            oninput="countChars()"
            data-dropzone="true"
            aria-label="Journal content"
            autocomplete="off"
            spellcheck="true">{{ form.content.value|default:'' }}</textarea>

          <!-- Photo preview container with improved styling (initially hidden) -->
          <div id="photoPreviewContainer" class="{% if not form.instance.photo %}hidden{% endif %} p-3 border-t border-gray-200 bg-white/80">
            <div class="flex items-center gap-3">
              <div class="relative inline-block group">
                <img id="photoPreview" class="h-20 w-20 sm:h-24 sm:w-24 object-cover rounded-lg border-2 border-secondary-200 shadow-sm"
                     src="{% if form.instance.photo %}{{ form.instance.photo.url }}{% endif %}" alt="Your photo">
                <div class="absolute inset-0 bg-black/0 group-hover:bg-black/10 rounded-lg transition-colors flex items-center justify-center">
                  <button type="button" id="removePhotoBtn" class="absolute -top-2 -right-2 bg-white rounded-full p-1 shadow-md border border-gray-200 opacity-100 hover:bg-red-50 transition-colors"
                    onclick="removePhoto()" title="Remove photo" aria-label="Remove photo">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-600" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                  </button>
                </div>
              </div>
              <div class="text-sm text-gray-600">
                <div class="font-medium">Photo added</div>
                <div class="text-xs" id="photoName">{% if form.instance.photo %}{{ form.instance.photo.name }}{% else %}image.jpg{% endif %}</div>
              </div>
            </div>
          </div>

          <!-- Enhanced tools container with tooltip -->
          <div class="absolute bottom-2 right-3 flex items-center gap-2">
            <div class="relative group">
              <input id="journalPhoto" name="entry_photo" type="file" accept="image/*" class="hidden" onchange="previewPhoto(event)" aria-label="Add a photo to your journal">
              <label for="journalPhoto" class="cursor-pointer p-2 hover:bg-gray-100 rounded-full transition-colors flex items-center justify-center" title="Add a photo">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500 group-hover:text-secondary-500 transition-colors" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd" />
                </svg>
              </label>
              <div class="absolute bottom-full right-0 mb-2 w-max bg-gray-800 text-white text-xs rounded px-2 py-1 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">
                Add a photo
              </div>
            </div>
          </div>

          <!-- Enhanced drop zone indicator with animation (hidden by default) -->
          <div id="dropZoneIndicator" class="hidden absolute inset-0 bg-secondary-50 border-2 border-dashed border-secondary-400 rounded-xl flex items-center justify-center pointer-events-none z-10 opacity-95">
            <div class="text-center p-4 animate-scale-in">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-secondary-400 mx-auto mb-2 animate-pulse" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
              </svg>
              <p class="text-secondary-600 font-medium">Drop your photo here</p>
            </div>
          </div>
        </div>

        {% if form.content.errors %}
          <p class="text-red-600 text-xs mb-4">{{ form.content.errors.0 }}</p>
        {% endif %}

        <!-- Enhanced drag-and-drop hint message -->
        <div class="mb-4 text-xs text-gray-500 flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 text-secondary-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <span>You can drag & drop a photo directly into the input box</span>
        </div>

        <!-- Modern Mood Selector -->
        <div class="form-field mb-6">
          <h3 class="text-sm font-medium mb-2 text-gray-700 flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5 text-secondary-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            How are you feeling today?
          </h3>

          <div class="mood-selector-container">
            <div class="flex justify-between items-center mb-3">
              <span class="text-sm font-medium text-gray-700" id="moodValue">Select a mood</span>
              <span class="text-2xl" id="moodEmoji">😐</span>
            </div>

            <div class="mood-slider" id="moodSlider">
              <div class="mood-slider-track"></div>
              <div class="mood-slider-thumb" id="moodThumb" style="left: 50%;">
                <span id="moodThumbEmoji">😐</span>
              </div>
            </div>

            <div class="mood-labels mt-1">
              <span>Happy</span>
              <span>Content</span>
              <span>Sad</span>
            </div>
          </div>

          <!-- Hidden radio buttons (for form submission) -->
          <div class="hidden">
            {% for choice in form.mood %}
              {{ choice.tag }}
            {% endfor %}
          </div>
        </div>

        <!-- Tags field with modern input -->
        <div class="form-field mb-6">
          <h3 class="text-sm font-medium mb-2 text-gray-700 flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5 text-secondary-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
            </svg>
            Tags
          </h3>

          <div class="tags-container">
            <input type="text" id="id_tags" name="tags" class="tags-input" placeholder="Add tags separated by commas" value="{{ form.tags.value|default:'' }}">

            <!-- Selected tags will appear here -->
            <div class="tags-pills" id="selectedTags"></div>

            <!-- Tag suggestions -->
            <div class="tag-suggestions mt-3">
              <p class="text-xs text-gray-500 mb-2">Suggested tags:</p>
              <button type="button" class="tag-suggestion" onclick="addTag('work')">work</button>
              <button type="button" class="tag-suggestion" onclick="addTag('family')">family</button>
              <button type="button" class="tag-suggestion" onclick="addTag('health')">health</button>
              <button type="button" class="tag-suggestion" onclick="addTag('friends')">friends</button>
              <button type="button" class="tag-suggestion" onclick="addTag('reflection')">reflection</button>
              <button type="button" class="tag-suggestion" onclick="addTag('gratitude')">gratitude</button>
              <button type="button" class="tag-suggestion" onclick="addTag('travel')">travel</button>
              <button type="button" class="tag-suggestion" onclick="addTag('food')">food</button>
              <button type="button" class="tag-suggestion" onclick="addTag('learning')">learning</button>
              <button type="button" class="tag-suggestion" onclick="addTag('goals')">goals</button>
            </div>
          </div>

          <p class="text-xs text-gray-500 mt-2 flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1 text-secondary-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            Tags help organize your entries and are auto-suggested based on your content
          </p>
        </div>

        <!-- Enhanced suggestions section with better wrapping and animations -->
        <div class="mb-6">
          <div class="text-xs font-medium text-gray-600 mb-2 flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 text-secondary-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
            </svg>
            <span>Start with a prompt:</span>
          </div>
          <div class="flex flex-wrap gap-1 sm:gap-2">
            <button type="button" onclick="addSuggestion('Today I accomplished')" class="suggestions-pill bg-secondary-50 hover:bg-secondary-100 text-secondary-700 px-3 sm:px-4 py-1.5 sm:py-2 rounded-full text-xs font-medium transition shadow-sm border border-secondary-200/50 min-h-[32px] sm:min-h-[40px] mb-1 hover:scale-105 hover:shadow animate-fade-in" style="animation-delay: 100ms;" aria-label="Add 'Today I accomplished' prompt">Today I accomplished</button>
            <button type="button" onclick="addSuggestion('I felt happy when')" class="suggestions-pill bg-emerald-50 hover:bg-emerald-100 text-emerald-700 px-3 sm:px-4 py-1.5 rounded-full text-xs font-medium transition shadow-sm border border-emerald-200/50 mb-1 hover:scale-105 hover:shadow animate-fade-in" style="animation-delay: 200ms;" aria-label="Add 'I felt happy when' prompt">I felt happy when</button>
            <button type="button" onclick="addSuggestion('I learned that')" class="suggestions-pill bg-indigo-50 hover:bg-indigo-100 text-indigo-700 px-3 sm:px-4 py-1.5 rounded-full text-xs font-medium transition shadow-sm border border-indigo-200/50 mb-1 hover:scale-105 hover:shadow animate-fade-in" style="animation-delay: 300ms;" aria-label="Add 'I learned that' prompt">I learned that</button>
            <button type="button" onclick="addSuggestion('I met with')" class="suggestions-pill bg-purple-50 hover:bg-purple-100 text-purple-700 px-3 sm:px-4 py-1.5 rounded-full text-xs font-medium transition shadow-sm border border-purple-200/50 mb-1 hover:scale-105 hover:shadow animate-fade-in" style="animation-delay: 400ms;" aria-label="Add 'I met with' prompt">I met with</button>
            <button type="button" onclick="addSuggestion('I\'m grateful for')" class="suggestions-pill bg-amber-50 hover:bg-amber-100 text-amber-700 px-3 sm:px-4 py-1.5 rounded-full text-xs font-medium transition shadow-sm border border-amber-200/50 mb-1 hover:scale-105 hover:shadow animate-fade-in" style="animation-delay: 500ms;" aria-label="Add 'I'm grateful for' prompt">I'm grateful for</button>
          </div>
        </div>
      </div>

      <!-- Enhanced bottom action area with mobile optimizations -->
      <div class="bg-gradient-to-r from-secondary-50 to-primary-50 px-4 sm:px-6 py-4 sm:py-5 flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3 border-t border-white">
        <div class="text-xs text-gray-600 flex items-center gap-2">
          <span class="h-6 w-6 bg-white rounded-full flex items-center justify-center shadow-sm">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 text-secondary-600" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd" />
            </svg>
          </span>
          <span>{% if is_edit_mode %}Update your journal entry{% else %}Create your journal entry{% endif %}</span>
        </div>
        <div class="action-container flex gap-3">
          {% if is_edit_mode %}
            <a href="{% url 'entry_detail' form.instance.id %}" class="btn-modern btn-secondary">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
              </svg>
              Cancel
            </a>
          {% else %}
            <a href="{% url 'dashboard' %}" class="btn-modern btn-secondary">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
              </svg>
              Cancel
            </a>
          {% endif %}

          <button type="submit" class="btn-gradient text-white px-5 py-3 rounded-full text-sm font-medium flex items-center justify-center gap-2 shadow-md w-full sm:w-auto hover:shadow-lg transition-all" aria-label="{% if is_edit_mode %}Update journal entry{% else %}Save journal entry{% endif %}">
            <span>{% if is_edit_mode %}Update Entry{% else %}Save Entry{% endif %}</span>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
            </svg>
          </button>
        </div>
      </div>
    </div>
  </form>
</div>

<!-- SCROLL FIX: Enhanced JavaScript with scroll optimizations -->
<script>
// Advanced AI Journal Assistant - Much better than home.html
let chatHistory = [];
let quickPhotoFile = null;
let quickPhotoDataUrl = null;
let currentJournalTemplate = null;
let conversationState = 'initial'; // initial, gathering, deep-dive, finalizing
let userContext = {};
let voiceRecognition = null;
let isVoiceInputActive = false;

// Enhanced conversation templates
const journalTemplates = {
  'daily-reflection': {
    name: 'Daily Reflection',
    questions: [
      "What was the highlight of your day?",
      "How did you feel during different parts of your day?",
      "What challenged you today, and how did you handle it?",
      "What are you grateful for from today?",
      "What did you learn about yourself today?"
    ],
    followUps: [
      "Can you tell me more about that feeling?",
      "What do you think caused that reaction?",
      "How does this connect to your goals or values?",
      "What would you do differently next time?"
    ]
  },
  'gratitude-practice': {
    name: 'Gratitude Practice',
    questions: [
      "What are three things you're grateful for today?",
      "Who made a positive impact on your day?",
      "What small moment brought you joy?",
      "What about your health, relationships, or opportunities are you thankful for?",
      "How has practicing gratitude changed your perspective?"
    ],
    followUps: [
      "Why does that particular thing mean so much to you?",
      "How did that person's actions affect you?",
      "What made that moment special?",
      "How can you show appreciation for this in your life?"
    ]
  },
  'goal-tracking': {
    name: 'Goal & Progress',
    questions: [
      "What progress did you make toward your goals today?",
      "What obstacles did you encounter?",
      "What motivated you to keep going?",
      "What skills or insights did you develop?",
      "How will you build on today's progress tomorrow?"
    ],
    followUps: [
      "What specific steps led to that progress?",
      "How did overcoming that obstacle feel?",
      "Where do you find that motivation?",
      "How will you apply this learning going forward?"
    ]
  },
  'free-form': {
    name: 'Free Form',
    questions: [
      "Tell me about your day in your own words.",
      "What's been on your mind lately?",
      "How have you been feeling?",
      "What would you like to remember about today?",
      "Is there anything you'd like to explore deeper?"
    ],
    followUps: [
      "That sounds important - can you share more?",
      "How does that make you feel?",
      "What do you think that means for you?",
      "How would you like to move forward with that?"
    ]
  }
};

// Smart input suggestions based on context
const smartSuggestions = {
  emotions: ["happy", "excited", "content", "peaceful", "frustrated", "anxious", "proud", "grateful", "confused", "hopeful"],
  activities: ["work", "family time", "exercise", "reading", "cooking", "travel", "learning", "relaxing", "creating", "socializing"],
  relationships: ["friends", "family", "colleagues", "partner", "children", "parents", "mentors", "community"],
  achievements: ["completed", "accomplished", "learned", "improved", "helped", "created", "solved", "discovered"],
  challenges: ["difficult", "challenging", "overwhelming", "stressful", "uncertain", "complex", "demanding"]
};

// Initialize advanced chat interface
function initializeChatInterface() {
  countQuickChars();
  setupVoiceInput();
  initializeSmartSuggestions();
  setupAdvancedFeatures();

  // Set up auto-resize for quick notes
  const quickNotes = document.getElementById('quickNotes');
  if (quickNotes) {
    quickNotes.addEventListener('input', function() {
      handleSmartInput(this);
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 150) + 'px';
    });
  }
}

// Handle smart input with context awareness
function handleSmartInput(textarea) {
  const value = textarea.value;
  countQuickChars();

  // Enable/disable send button
  const sendBtn = document.getElementById('smartSendBtn');
  const contextDiv = document.getElementById('inputContext');

  if (sendBtn) {
    sendBtn.disabled = value.trim().length < 10;
  }

  // Provide contextual suggestions
  if (value.length > 20) {
    generateSmartSuggestions(value);
  }

  // Show context hints
  if (currentJournalTemplate && conversationState === 'gathering') {
    const template = journalTemplates[currentJournalTemplate];
    if (template && contextDiv) {
      contextDiv.classList.remove('hidden');
      document.getElementById('contextText').textContent = `💡 ${template.name} mode: ${getContextualHint(value)}`;
    }
  }
}

// Generate smart suggestions based on input
function generateSmartSuggestions(input) {
  const suggestions = [];
  const lowerInput = input.toLowerCase();

  // Analyze input and suggest relevant prompts
  Object.entries(smartSuggestions).forEach(([category, words]) => {
    words.forEach(word => {
      if (lowerInput.includes(word)) {
        suggestions.push(...getRelevantSuggestions(category, word));
      }
    });
  });

  // Update suggestion pills
  updateDynamicSuggestions(suggestions.slice(0, 4));
}

// Get relevant suggestions based on detected categories
function getRelevantSuggestions(category, trigger) {
  const suggestions = {
    emotions: [
      `What triggered that ${trigger} feeling?`,
      `How long did you feel ${trigger}?`,
      `What helped you process being ${trigger}?`
    ],
    activities: [
      `What did you enjoy most about ${trigger}?`,
      `How did ${trigger} impact your day?`,
      `What did you learn from ${trigger}?`
    ],
    relationships: [
      `How did time with ${trigger} affect you?`,
      `What did you appreciate about ${trigger}?`,
      `How has your relationship with ${trigger} grown?`
    ],
    achievements: [
      `What steps led to what you ${trigger}?`,
      `How do you feel about what you ${trigger}?`,
      `What will you do next after ${trigger} this?`
    ]
  };

  return suggestions[category] || [];
}

// Update dynamic suggestions
function updateDynamicSuggestions(suggestions) {
  const container = document.getElementById('dynamicSuggestions');
  if (!container || suggestions.length === 0) return;

  container.innerHTML = '';
  suggestions.forEach((suggestion, index) => {
    const button = document.createElement('button');
    button.className = 'suggestions-pill bg-indigo-50 hover:bg-indigo-100 text-indigo-700 px-3 py-1.5 rounded-full text-xs font-medium transition shadow-sm border border-indigo-200/50 animate-fade-in';
    button.style.animationDelay = `${index * 100}ms`;
    button.textContent = suggestion;
    button.onclick = () => addQuickSuggestion(suggestion);
    container.appendChild(button);
  });
}

// Handle keyboard shortcuts
function handleKeyboardShortcuts(event) {
  if ((event.ctrlKey || event.metaKey) && event.key === 'Enter') {
    event.preventDefault();
    handleSmartSend();
  }

  if (event.key === 'Escape') {
    const contextDiv = document.getElementById('inputContext');
    if (contextDiv) {
      contextDiv.classList.add('hidden');
    }
  }
}

// Quick start templates
function useQuickStart(template) {
  currentJournalTemplate = template;

  // Hide conversation starter
  const starter = document.getElementById('conversationStarter');
  if (starter) {
    starter.style.opacity = '0';
    starter.style.transform = 'translateY(-10px)';
    setTimeout(() => starter.classList.add('hidden'), 300);
  }

  // Send initial message to LLM to start the conversation
  sendInitialChatMessage(template);

  // Focus on input
  const quickNotes = document.getElementById('quickNotes');
  if (quickNotes) {
    quickNotes.placeholder = "Tell me about your day...";
    quickNotes.focus();
  }

  showFeedback(`🎯 Started ${getTemplateName(template)} session - I'll ask thoughtful questions!`, 'success', 4000);
}

// Get template-specific greeting
function getTemplateGreeting(template) {
  const greetings = {
    'daily-reflection': "Perfect! Let's reflect on your day together. I'll ask you some thoughtful questions to help you explore your experiences deeply. What was the highlight of your day?",
    'gratitude-practice': "Wonderful! Gratitude practice is so powerful for wellbeing. I'll help you explore what you're thankful for today. What are three things you're grateful for today, big or small?",
    'goal-tracking': "Excellent choice! Let's look at your progress and achievements. I'll help you reflect on how you're moving toward your goals. What progress did you make toward your goals today?",
    'free-form': "Great! I love free-form journaling. Just share whatever's on your mind, and I'll help you explore it deeper. Tell me about your day in your own words."
  };
  return greetings[template] || "Let's start your journal entry. What would you like to share?";
}

// Get template-specific placeholder
function getTemplatePlaceholder(template) {
  const placeholders = {
    'daily-reflection': "Share what stood out to you today...",
    'gratitude-practice': "What are you grateful for today?",
    'goal-tracking': "What progress did you make today?",
    'free-form': "Tell me about your day..."
  };
  return placeholders[template] || "Share what's on your mind...";
}

// Enhanced smart send with conversation flow
function handleSmartSend() {
  const quickNotes = document.getElementById('quickNotes');
  if (!quickNotes || quickNotes.value.trim().length < 10) {
    showFeedback('Please share at least 10 characters about your day', 'warning');
    quickNotes.focus();
    return;
  }

  const userMessage = quickNotes.value.trim();

  // Add to chat history
  chatHistory.push({ role: 'user', content: userMessage });
  addMessageToChat(userMessage, 'user');

  // Clear input
  quickNotes.value = '';
  quickNotes.style.height = 'auto';
  countQuickChars();

  // Update send button state
  const sendBtn = document.getElementById('smartSendBtn');
  if (sendBtn) {
    sendBtn.disabled = true;
  }

  // Show thinking indicator
  showAdvancedThinking();

  // Send to LLM for response
  sendMessageToLLM(userMessage);
}

// Show advanced thinking with random thoughtful messages
function showAdvancedThinking() {
  const thinkingIndicator = document.getElementById('thinkingIndicator');
  const thinkingText = document.getElementById('thinkingText');

  if (thinkingIndicator) {
    thinkingIndicator.classList.remove('hidden');
  }

  const thinkingMessages = [
    "Thinking deeply about your experience...",
    "Considering the best follow-up question...",
    "Analyzing the emotions in your words...",
    "Crafting a thoughtful response...",
    "Understanding the context of your day...",
    "Preparing insightful questions..."
  ];

  let messageIndex = 0;
  const messageInterval = setInterval(() => {
    if (thinkingText) {
      thinkingText.textContent = thinkingMessages[messageIndex];
      messageIndex = (messageIndex + 1) % thinkingMessages.length;
    }
  }, 2000);

  // Store interval ID to clear it later
  thinkingIndicator.dataset.intervalId = messageInterval;
}

// Hide thinking indicator
function hideAdvancedThinking() {
  const thinkingIndicator = document.getElementById('thinkingIndicator');
  if (thinkingIndicator) {
    const intervalId = thinkingIndicator.dataset.intervalId;
    if (intervalId) {
      clearInterval(parseInt(intervalId));
    }
    thinkingIndicator.classList.add('hidden');
  }
}

// Process intelligent response based on conversation state
function processIntelligentResponse(userMessage) {
  // This is now handled by sendMessageToLLM - keep this for compatibility
  sendMessageToLLM(userMessage);
}

// Send message to LLM backend
function sendMessageToLLM(userMessage, isInitial = false) {
  updateAIStatus("Having a genuine conversation with you...");

  // Get CSRF token
  const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

  // Prepare form data
  const formData = new FormData();
  formData.append('message', userMessage);
  formData.append('conversation_history', JSON.stringify(chatHistory));
  formData.append('chat_mode', currentJournalTemplate || 'free-form');

  // Add photo with the field name your backend expects
  if (quickPhotoFile) {
    formData.append('photo', quickPhotoFile);  // This matches your backend
    console.log('Photo attached:', quickPhotoFile.name, quickPhotoFile.size);
  }

  // Make API call to your chat endpoint
  fetch('/api/chat/', {
    method: 'POST',
    headers: {
      'X-CSRFToken': csrfToken
    },
    body: formData
  })
  .then(response => {
    if (!response.ok) {
      throw new Error('Server error: ' + response.status);
    }
    return response.json();
  })
  .then(data => {
    hideAdvancedThinking();

    if (data.error) {
      showFeedback(data.error, 'error');
      return;
    }

    // Add AI response to chat
    addMessageToChat(data.ai_message, 'ai');
    chatHistory.push({ role: 'assistant', content: data.ai_message });

    // Check if we should generate journal entry
    if (data.should_switch_to_form || data.type === 'journal_entry') {
      // Handle journal entry generation
      if (data.journal_entry) {
        populateFormWithAIContent(data.journal_entry);
      } else {
        // Fallback for older response format
        populateFormWithAIContent({
          entry: data.ai_message,
          title: generateTitleFromContent(data.ai_message)
        });
      }
      switchToManualForm();
      showFeedback('✨ Created your personalized journal entry!', 'success');
    } else {
      // Continue conversation
      if (data.conversation_suggestions) {
        updateConversationSuggestions(data.conversation_suggestions);
      }

      // Re-enable send button
      const sendBtn = document.getElementById('smartSendBtn');
      if (sendBtn) {
        sendBtn.disabled = false;
      }

      // Focus back on input
      const quickNotes = document.getElementById('quickNotes');
      if (quickNotes) {
        quickNotes.focus();
      }
    }

    updateConversationProgress();

    // Log success
    if (data.photo_uploaded) {
      console.log('Photo successfully processed by backend');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    hideAdvancedThinking();
    showFeedback(error.message || 'Sorry, something went wrong. Please try again.', 'error');

    // Re-enable send button
    const sendBtn = document.getElementById('smartSendBtn');
    if (sendBtn) {
      sendBtn.disabled = false;
    }
    updateAIStatus("Ready to help - let's try again!");
  });
}

// Update conversation suggestions based on LLM response
function updateConversationSuggestions(suggestions) {
  if (!suggestions || suggestions.length === 0) return;

  const container = document.getElementById('dynamicSuggestions');
  if (!container) return;

  container.innerHTML = '';
  suggestions.forEach((suggestion, index) => {
    const button = document.createElement('button');
    button.className = 'suggestions-pill bg-indigo-50 hover:bg-indigo-100 text-indigo-700 px-3 py-1.5 rounded-full text-xs font-medium transition shadow-sm border border-indigo-200/50 animate-fade-in';
    button.style.animationDelay = `${index * 100}ms`;
    button.textContent = suggestion;
    button.onclick = () => addQuickSuggestion(suggestion);
    container.appendChild(button);
  });
}

// Truly human-like conversation patterns and responses
const humanConversationStyles = {
  greetings: [
    "Hey there! I'm so glad you're here. What's been going on with you today?",
    "Hi! I've been excited to hear about your day. What's on your mind?",
    "Hello! I love getting to know people through their daily experiences. How are you feeling right now?",
    "Hey! Thanks for choosing to journal today. What's something that stood out to you?",
    "Hi there! I'm genuinely curious - what's been the energy of your day like?"
  ],

  followUps: {
    excited: [
      "Oh wow, I can feel your excitement! Tell me more about that feeling.",
      "That sounds amazing! What made it so special for you?",
      "I love hearing that energy in your voice! What was the best part?",
      "Your enthusiasm is contagious! How did that make you feel in the moment?"
    ],
    challenging: [
      "That sounds really tough. How are you processing that?",
      "Oof, that's a lot to handle. What's been helping you get through it?",
      "I can imagine that was difficult. What thoughts are you having about it now?",
      "That's heavy stuff. How are you taking care of yourself with all that?"
    ],
    accomplished: [
      "That's such a great feeling! What did it take to get there?",
      "I love that sense of accomplishment. What are you most proud of?",
      "Yes! Those breakthrough moments are the best. How does it feel to have pushed through?",
      "That's awesome progress. What do you think made the difference today?"
    ],
    reflective: [
      "That's really thoughtful. Where do you think that insight came from?",
      "I can tell you're really processing this. What else is coming up for you?",
      "That's such an interesting way to look at it. How does that sit with you?",
      "You're really tuning into something important there. What feels true about that?"
    ],
    grateful: [
      "That's beautiful. What is it about that experience that touches you?",
      "I can feel the gratitude in what you're sharing. How does that appreciation feel in your body?",
      "Those moments of thankfulness are so precious. What made you pause and notice it?",
      "That's really moving. How do you want to carry that feeling forward?"
    ]
  },

  encouragement: [
    "I'm really enjoying hearing about your day.",
    "You're sharing such thoughtful details.",
    "I can tell this means a lot to you.",
    "The way you describe things is really vivid.",
    "I appreciate how honest you're being.",
    "You have such interesting insights.",
    "I love how you notice the small moments.",
    "You're really good at capturing feelings."
  ],

  transitions: [
    "What else is coming up for you?",
    "I'm curious about something else...",
    "Can I ask you about another part of your day?",
    "Something else I'm wondering about...",
    "I'd love to hear more about...",
    "What about the emotional side of things?",
    "How did that ripple out into the rest of your day?",
    "I'm getting a sense that there's more to explore here..."
  ]
};

// Detect emotional context from user messages
function analyzeEmotionalContext(message) {
  const lowerMessage = message.toLowerCase();

  // Excitement indicators
  if (lowerMessage.match(/amazing|incredible|awesome|fantastic|excited|thrilled|love|perfect|wonderful|brilliant/)) {
    return 'excited';
  }

  // Challenge indicators
  if (lowerMessage.match(/difficult|hard|tough|struggling|stressed|overwhelmed|frustrating|challenging|tired|exhausted/)) {
    return 'challenging';
  }

  // Accomplishment indicators
  if (lowerMessage.match(/accomplished|finished|completed|achieved|proud|successful|breakthrough|progress|better|improved/)) {
    return 'accomplished';
  }

  // Gratitude indicators
  if (lowerMessage.match(/grateful|thankful|blessed|appreciate|lucky|gift|beautiful|peaceful|content|happy/)) {
    return 'grateful';
  }

  // Reflective indicators
  if (lowerMessage.match(/thinking|realized|understand|learning|discovered|noticed|reflected|wondering|considering/)) {
    return 'reflective';
  }

  return 'neutral';
}

// Generate human-like responses based on conversation flow
function generateHumanResponse(userMessage, conversationLength) {
  const emotionalContext = analyzeEmotionalContext(userMessage);
  const followUps = humanConversationStyles.followUps[emotionalContext] || humanConversationStyles.followUps.reflective;

  let response = '';

  // Add natural acknowledgment
  if (conversationLength === 1) {
    const encouragements = humanConversationStyles.encouragement;
    response += encouragements[Math.floor(Math.random() * encouragements.length)] + ' ';
  }

  // Add contextual follow-up
  const followUp = followUps[Math.floor(Math.random() * followUps.length)];
  response += followUp;

  // Sometimes add a transition or additional question
  if (Math.random() > 0.6 && conversationLength > 1) {
    const transitions = humanConversationStyles.transitions;
    const transition = transitions[Math.floor(Math.random() * transitions.length)];
    response += ' ' + transition;
  }

  return response;
}

// Quick start templates with human conversation starters
function useQuickStart(template) {
  currentJournalTemplate = template;
  conversationState = 'gathering';

  // Hide conversation starter
  const starter = document.getElementById('conversationStarter');
  if (starter) {
    starter.style.opacity = '0';
    starter.style.transform = 'translateY(-10px)';
    setTimeout(() => starter.classList.add('hidden'), 300);
  }

  // Start with human-like conversation based on template
  let greeting = '';

  switch(template) {
    case 'daily-reflection':
      greeting = "I love diving deep into how days unfold! What's something from today that's still sitting with you?";
      break;
    case 'gratitude-practice':
      greeting = "Gratitude journaling is one of my favorite things! What's making your heart feel full today?";
      break;
    case 'goal-tracking':
      greeting = "I get excited hearing about people's progress! What's one thing you moved forward on today, even if it was small?";
      break;
    case 'free-form':
      greeting = "I'm all ears! Just start wherever feels right - what's the energy of your day been like?";
      break;
    default:
      greeting = "I'm really curious to hear what's been on your mind today. What feels important to share?";
  }

  addMessageToChat(greeting, 'ai');
  chatHistory.push({ role: 'assistant', content: greeting, template: template });

  // Update AI status
  updateAIStatus("Having a genuine conversation with you...");

  // Focus on input with natural placeholder
  const quickNotes = document.getElementById('quickNotes');
  if (quickNotes) {
    quickNotes.placeholder = "Just start typing naturally...";
    quickNotes.focus();
  }

  showFeedback(`💬 Started a natural conversation about ${journalTemplates[template].name.toLowerCase()}`, 'success', 3000);
}

// Process intelligent response with more human conversation
function processIntelligentResponse(userMessage) {
  const userMessageCount = chatHistory.filter(m => m.role === 'user').length;
  let aiResponse;
  let shouldGenerateEntry = false;

  // More natural conversation flow
  if (userMessageCount === 1) {
    // First response - show interest and ask for more
    aiResponse = generateHumanResponse(userMessage, 1);
  } else if (userMessageCount === 2) {
    // Second response - go deeper
    const emotionalContext = analyzeEmotionalContext(userMessage);
    aiResponse = generateHumanResponse(userMessage, 2);
  } else if (userMessageCount === 3) {
    // Third response - maybe one more question or wrap up
    if (Math.random() > 0.4) { // 60% chance to wrap up
      shouldGenerateEntry = true;
      aiResponse = getWrapUpResponse();
    } else {
      aiResponse = generateHumanResponse(userMessage, 3);
    }
  } else {
    // After 3+ exchanges, definitely wrap up
    shouldGenerateEntry = true;
    aiResponse = getWrapUpResponse();
  }

  // Simulate human thinking time (more realistic)
  const thinkingTime = 1500 + Math.random() * 2500; // 1.5-4 seconds

  setTimeout(() => {
    hideAdvancedThinking();

    if (shouldGenerateEntry) {
      // Add final response then generate
      addMessageToChat(aiResponse, 'ai');
      chatHistory.push({ role: 'assistant', content: aiResponse });

      // Small pause before generation
      setTimeout(() => {
        generateTrulyDiverseEntry();
      }, 1000);
    } else {
      // Continue conversation
      addMessageToChat(aiResponse, 'ai');
      chatHistory.push({ role: 'assistant', content: aiResponse });

      // Re-enable send button
      const sendBtn = document.getElementById('smartSendBtn');
      if (sendBtn) {
        sendBtn.disabled = false;
      }

      // Focus back on input
      const quickNotes = document.getElementById('quickNotes');
      if (quickNotes) {
        quickNotes.focus();
      }
    }

    updateConversationProgress();
  }, thinkingTime);
}

// Natural wrap-up responses
function getWrapUpResponse() {
  const wrapUps = [
    "This has been such a rich conversation! I feel like I really understand the essence of your day. Let me create something beautiful that captures all of this.",
    "Wow, thank you for sharing so openly with me. I can feel the depth of your experience. I'm excited to weave this into a journal entry that honors your story.",
    "I love how thoughtfully you've shared about your day. There's so much meaning in what you've told me. Let me craft an entry that reflects your unique voice and experience.",
    "This conversation has given me such a clear picture of who you are and how you experience life. I want to create something that truly feels like you wrote it.",
    "Your insights and the way you see the world are really special. I'm going to create a journal entry that captures not just what happened, but who you are as a person."
  ];

  return wrapUps[Math.floor(Math.random() * wrapUps.length)];
}

// Generate truly diverse content with enhanced backend prompting
function generateTrulyDiverseEntry() {
  updateAIStatus("Crafting something that sounds authentically like you...");

  // Show loading indicator
  const loadingIndicator = document.getElementById('loadingIndicator');
  if (loadingIndicator) {
    loadingIndicator.classList.remove('hidden');
  }

  // Analyze the user's actual voice and style
  const userVoiceAnalysis = analyzeUserVoice();

  // Get CSRF token
  const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

  // Create comprehensive prompt data for your LLM
  const enhancedPromptData = createEnhancedPrompt(userVoiceAnalysis);

  // Prepare form data with much better prompting
  const formData = new FormData();

  // NEW: Send as chat message instead of journal_content
  formData.append('message', enhancedPromptData.enhancedPrompt);
  formData.append('conversation_history', JSON.stringify(chatHistory));
  formData.append('chat_mode', currentJournalTemplate || 'free-form');

  // Send detailed style instructions for your LLM
  formData.append('writing_style_analysis', JSON.stringify(userVoiceAnalysis));

  // Send specific instructions to avoid formulaic content
  formData.append('style_instructions', JSON.stringify({
    avoid_phrases: [
      "As I sit down to reflect",
      "As I look back on my day",
      "Reflecting on my day",
      "In conclusion",
      "As I close this journal entry"
    ],
    tone: userVoiceAnalysis.tone,
    structure: userVoiceAnalysis.structure,
    writing_guidelines: enhancedPromptData.guidelines
  }));

  formData.append('template_type', currentJournalTemplate || 'free-form');
  formData.append('personalize', 'true');

  if (quickPhotoFile) {
    formData.append('photo', quickPhotoFile);
  }

  // NEW: Use the chat endpoint instead of demo-journal
  fetch('/api/chat/', {
    method: 'POST',
    headers: {
      'X-CSRFToken': csrfToken
    },
    body: formData
  })
  .then(response => {
    if (!response.ok) {
      if (response.status === 429) {
        throw new Error('Rate limit exceeded. Please wait a moment before trying again.');
      }
      throw new Error('Server error: ' + response.status);
    }
    return response.json();
  })
  .then(data => {
    // Hide loading indicator
    if (loadingIndicator) {
      loadingIndicator.classList.add('hidden');
    }

    if (data.error) {
      showFeedback(data.error, 'error');
      return;
    }

    // Handle both chat response and journal entry response
    let finalContent, journalData;

    if (data.type === 'journal_entry' && data.journal_entry) {
      // Response from chat endpoint with journal entry
      journalData = data.journal_entry;
      finalContent = journalData.entry;
    } else if (data.entry) {
      // Direct journal entry response
      journalData = data;
      finalContent = data.entry;
    } else {
      // Fallback
      journalData = { entry: data.ai_message || 'Journal entry created', title: 'My Journal Entry' };
      finalContent = journalData.entry;
    }

    // Check if the content is still formulaic and enhance it as fallback
    if (isContentFormulaic(finalContent)) {
      finalContent = enhanceJournalContent(finalContent, userVoiceAnalysis);
      showFeedback('⚡ Enhanced the content to sound more like you!', 'info', 3000);
    }

    // Update the data with enhanced content
    journalData.entry = finalContent;

    // Add final AI response
    const finalResponse = "I've crafted an entry that captures your authentic voice and the essence of our conversation. It should feel like something you'd actually write!";
    addMessageToChat(finalResponse, 'ai');
    chatHistory.push({ role: 'assistant', content: finalResponse });

    // Populate form and switch
    populateFormWithAIContent(journalData);
    switchToManualForm();

    showFeedback('✨ Created an entry in your authentic voice!', 'success');
    updateAIStatus("Made something that truly sounds like you!");
  })
  .catch(error => {
    console.error('Error:', error);

    if (loadingIndicator) {
      loadingIndicator.classList.add('hidden');
    }

    showFeedback(error.message || 'Sorry, we encountered an error. Please try again later.', 'error');
    updateAIStatus("Ready to help - let's try again!");
  });
}

// Create an enhanced prompt that guides your LLM to write better content
function createEnhancedPrompt(voiceAnalysis) {
  const userMessages = chatHistory.filter(m => m.role === 'user').map(m => m.content);
  const conversationSummary = userMessages.join('\n\n');

  const guidelines = [
    `Write in a ${voiceAnalysis.tone} tone that matches how this person naturally communicates`,
    `Use ${voiceAnalysis.vocabulary} vocabulary - match their word choice level`,
    `Structure: ${voiceAnalysis.structure} - mirror their way of organizing thoughts`,
    `Emotional style: ${voiceAnalysis.emotionalStyle} - match how they express feelings`,
    "Start with something engaging, not 'As I sit down to reflect' or similar cliches",
    "Write like a real person's authentic diary entry, not an AI template",
    "Use their actual words and phrases where possible",
    "Make it sound like THEY wrote it, not like an AI assistant wrote it",
    "Avoid generic journal entry language - be specific and personal"
  ];

  const enhancedPrompt = `
CONVERSATION CONTEXT:
${conversationSummary}

WRITING STYLE TO MATCH:
- Tone: ${voiceAnalysis.tone}
- Structure: ${voiceAnalysis.structure}
- Vocabulary: ${voiceAnalysis.vocabulary}
- Emotional expression: ${voiceAnalysis.emotionalStyle}
- Average message length: ${Math.round(voiceAnalysis.avgLength)} characters

SPECIFIC INSTRUCTIONS:
- Write a journal entry that sounds like this person actually wrote it
- Use their natural language patterns and vocabulary
- Don't start with formulaic phrases like "As I reflect on my day"
- Make it feel authentic and personal, not like a template
- Include specific details from our conversation
- Match their emotional expression style
- Use a natural, conversational flow

SAMPLE PHRASES FROM THEIR CONVERSATION:
${extractKeyPhrases(voiceAnalysis.allText).join(', ')}

Please write a journal entry that captures the essence of our conversation while sounding authentically like this person wrote it themselves.`;

  return {
    enhancedPrompt,
    guidelines
  };
}

// Extract key phrases that are uniquely theirs
function extractKeyPhrases(text) {
  // Get phrases that show their personality
  const sentences = text.split(/[.!?]+/).filter(s => s.trim().length > 10 && s.trim().length < 80);
  const uniquePhrases = [];

  sentences.forEach(sentence => {
    const clean = sentence.trim().replace(/^(and|but|so|then|also)\s+/i, '');
    if (clean.length > 5 && clean.length < 60) {
      uniquePhrases.push(clean);
    }
  });

  return uniquePhrases.slice(0, 5); // Top 5 most characteristic phrases
}

// Check if content is still formulaic
function isContentFormulaic(content) {
  const formulaicPhrases = [
    'as i sit down to reflect',
    'as i look back on my day',
    'reflecting on my day',
    'in conclusion',
    'as i close this journal entry',
    'as i write this entry',
    'taking time to reflect',
    'looking back on today'
  ];

  const lowerContent = content.toLowerCase();
  return formulaicPhrases.some(phrase => lowerContent.includes(phrase));
}

// Analyze user's authentic voice from their messages
function analyzeUserVoice() {
  const userMessages = chatHistory.filter(m => m.role === 'user');
  const allText = userMessages.map(m => m.content).join(' ');

  return {
    messages: userMessages,
    allText: allText,
    avgLength: allText.length / userMessages.length,
    tone: detectActualTone(allText),
    structure: detectStructurePreference(userMessages),
    vocabulary: detectVocabularyStyle(allText),
    emotionalStyle: detectEmotionalStyle(allText)
  };
}

// Detect the user's actual tone from their writing
function detectActualTone(text) {
  const casual = (text.match(/\b(like|yeah|really|pretty|kinda|gonna|wanna)\b/gi) || []).length;
  const formal = (text.match(/\b(therefore|however|furthermore|nevertheless|consequently)\b/gi) || []).length;
  const enthusiastic = (text.match(/[!]{1,3}|amazing|awesome|love|excited|incredible/gi) || []).length;

  if (enthusiastic > 2) return 'enthusiastic';
  if (casual > formal) return 'casual';
  if (formal > casual) return 'formal';
  return 'balanced';
}

// Detect how the user structures their thoughts
function detectStructurePreference(messages) {
  const avgSentencesPerMessage = messages.reduce((sum, msg) => {
    const sentences = msg.content.split(/[.!?]+/).filter(s => s.trim().length > 5);
    return sum + sentences.length;
  }, 0) / messages.length;

  const hasLists = messages.some(msg => msg.content.includes('\n') || msg.content.match(/\d\.|•|-/));

  if (avgSentencesPerMessage > 4 || hasLists) return 'organized';
  if (avgSentencesPerMessage < 2) return 'concise';
  return 'flowing';
}

// Detect vocabulary style
function detectVocabularyStyle(text) {
  const simpleWords = (text.match(/\b(good|bad|nice|cool|fun|great|okay)\b/gi) || []).length;
  const complexWords = (text.match(/\b(magnificent|extraordinary|contemplative|intricate|profound)\b/gi) || []).length;
  const emotionalWords = (text.match(/\b(heart|soul|spirit|essence|energy|vibe)\b/gi) || []).length;

  if (complexWords > simpleWords) return 'sophisticated';
  if (emotionalWords > 2) return 'expressive';
  if (simpleWords > complexWords) return 'simple';
  return 'everyday';
}

// Detect emotional expression style
function detectEmotionalStyle(text) {
  const directEmotions = (text.match(/\b(I feel|I'm feeling|I felt|I am)\b/gi) || []).length;
  const metaphorical = (text.match(/\b(like|as if|reminds me|feels like)\b/gi) || []).length;
  const intensifiers = (text.match(/\b(very|really|so|extremely|absolutely|totally)\b/gi) || []).length;

  if (intensifiers > 3) return 'intense';
  if (metaphorical > directEmotions) return 'metaphorical';
  if (directEmotions > 2) return 'direct';
  return 'subtle';
}

// Create a completely custom journal entry that sounds like the user
function createCustomJournalEntry(voice) {
  const userMessages = voice.messages.map(m => m.content);
  const mainContent = userMessages.join('\n\n');

  // Get the user's actual words and phrases
  const userPhrases = extractUserPhrases(voice.allText);
  const userEmotions = extractUserEmotions(voice.allText);

  // Create an opening that mirrors their style
  let opening = createAuthenticOpening(userMessages[0], voice.tone);

  // Build the main content using their actual language
  let content = transformUserContentToJournal(mainContent, voice);

  // Create a natural ending in their voice
  let ending = createAuthenticEnding(voice);

  // Combine everything
  const fullEntry = `${opening}\n\n${content}\n\n${ending}`;

  // Create a natural title
  const title = createNaturalTitle(userMessages, voice);

  return {
    content: fullEntry,
    title: title
  };
}

// Extract phrases that are uniquely theirs
function extractUserPhrases(text) {
  // Look for unique expressions, not generic ones
  const phrases = [];
  const sentences = text.split(/[.!?]+/);

  sentences.forEach(sentence => {
    if (sentence.trim().length > 10 && sentence.trim().length < 100) {
      phrases.push(sentence.trim());
    }
  });

  return phrases;
}

// Extract their emotional expressions
function extractUserEmotions(text) {
  const emotionMap = {};
  const emotionWords = text.match(/\b(feel|felt|feeling|emotion|happy|sad|excited|nervous|proud|grateful|frustrated|peaceful|energized|tired|motivated|inspired|overwhelmed|content|anxious|hopeful|confident)\w*\b/gi) || [];

  emotionWords.forEach(word => {
    emotionMap[word.toLowerCase()] = (emotionMap[word.toLowerCase()] || 0) + 1;
  });

  return emotionMap;
}

// Create an opening that sounds like them, not a template
function createAuthenticOpening(firstMessage, tone) {
  const openings = {
    casual: [
      "So today was interesting...",
      "I've been thinking about today, and",
      "Today felt different somehow.",
      "There's something about today that",
      "I keep coming back to how"
    ],
    enthusiastic: [
      "Okay, I have to talk about today!",
      "Today was absolutely",
      "I'm still buzzing from",
      "I can't get over how",
      "Today reminded me why I love"
    ],
    formal: [
      "Today presented an opportunity to",
      "I find myself reflecting on",
      "Today offered some insights about",
      "I've been considering how",
      "Today highlighted the importance of"
    ],
    balanced: [
      "I've been thinking about today.",
      "Today brought some clarity about",
      "There was something meaningful about today.",
      "I noticed something important today.",
      "Today helped me realize"
    ]
  };

  const options = openings[tone] || openings.balanced;
  return options[Math.floor(Math.random() * options.length)];
}

// Transform their content into journal format while keeping their voice
function transformUserContentToJournal(content, voice) {
  // Don't completely rewrite - keep their authentic language
  // Just add some structure and flow

  const sections = content.split('\n\n');
  let transformed = '';

  sections.forEach((section, index) => {
    if (index > 0) {
      // Add natural transitions that match their style
      const transitions = voice.tone === 'casual' ?
        ['What really stuck with me was', 'And then there was', 'I also keep thinking about'] :
        voice.tone === 'enthusiastic' ?
        ['But the best part was', 'And get this', 'What made it even better was'] :
        ['Another aspect that stood out was', 'Additionally', 'What also resonated with me was'];

      const transition = transitions[Math.floor(Math.random() * transitions.length)];
      transformed += transition + ' ' + section.toLowerCase() + '\n\n';
    } else {
      transformed += section + '\n\n';
    }
  });

  return transformed.trim();
}

// Create an ending that sounds like their natural voice
function createAuthenticEnding(voice) {
  const endings = {
    casual: [
      "Anyway, that's where my head's at right now.",
      "Pretty good day overall, I'd say.",
      "Looking forward to seeing what tomorrow brings.",
      "Feeling pretty good about all of this.",
      "It's nice to have days like this."
    ],
    enthusiastic: [
      "I'm so energized thinking about all of this!",
      "Can't wait to see what builds from here!",
      "This feeling is exactly what I needed!",
      "I'm going to hold onto this energy!",
      "Today was absolutely perfect for where I'm at."
    ],
    formal: [
      "I'm grateful for the insights this day has provided.",
      "This experience has given me valuable perspective.",
      "I look forward to applying these learnings going forward.",
      "Today has reinforced some important principles for me.",
      "I appreciate the growth that today has offered."
    ],
    balanced: [
      "I'm thankful for today's experiences.",
      "It feels good to reflect on all of this.",
      "I'm curious to see how this influences tomorrow.",
      "Today was exactly what I needed.",
      "I feel centered after thinking through all of this."
    ]
  };

  const options = endings[voice.tone] || endings.balanced;
  return options[Math.floor(Math.random() * options.length)];
}

// Create a natural title from their content
function createNaturalTitle(userMessages, voice) {
  const today = new Date();
  const dateStr = today.toLocaleDateString('en-US', { month: 'long', day: 'numeric' });

  // Extract key themes from their messages
  const allText = userMessages.join(' ').toLowerCase();

  if (allText.includes('work') || allText.includes('project') || allText.includes('accomplish')) {
    return `Getting Things Done - ${dateStr}`;
  } else if (allText.includes('feel') || allText.includes('emotion') || allText.includes('heart')) {
    return `Feeling It All - ${dateStr}`;
  } else if (allText.includes('people') || allText.includes('friend') || allText.includes('family')) {
    return `Connections - ${dateStr}`;
  } else if (allText.includes('learn') || allText.includes('discover') || allText.includes('realize')) {
    return `Learning Something New - ${dateStr}`;
  } else {
    return `Today's Thoughts - ${dateStr}`;
  }
}

// Get contextual hint
function getContextualHint(input) {
  const hints = [
    "I'm listening for the emotions in your words",
    "Tell me about the details that stood out",
    "I'm curious about how this made you feel",
    "Share what this experience means to you"
  ];
  return hints[Math.floor(Math.random() * hints.length)];
}

// Enhanced AI generation with diverse writing styles and structures
const journalWritingStyles = {
  openings: {
    reflective: [
      "Today was one of those days that...",
      "I've been thinking about how...",
      "Something shifted in me today when...",
      "The most surprising thing about today was...",
      "I realized something important today..."
    ],
    immediate: [
      "Right now, I'm feeling...",
      "I can't stop thinking about...",
      "The energy of today was...",
      "I'm struck by how...",
      "What stands out most is..."
    ],
    narrative: [
      "It started when...",
      "The day unfolded in unexpected ways...",
      "I found myself...",
      "There was a moment today when...",
      "Everything changed when..."
    ],
    emotional: [
      "My heart feels...",
      "I'm buzzing with...",
      "There's this warmth in my chest because...",
      "I'm overwhelmed by the feeling of...",
      "Something beautiful happened today..."
    ],
    philosophical: [
      "I've been contemplating...",
      "It's fascinating how...",
      "I'm learning that...",
      "Life has a way of...",
      "There's something profound about..."
    ],
    grateful: [
      "I'm deeply grateful for...",
      "Today reminded me how blessed I am...",
      "My heart is full because...",
      "I feel so thankful that...",
      "What a gift it was to..."
    ],
    direct: [
      "I accomplished something today that...",
      "Today I chose to...",
      "I made progress on...",
      "I discovered that I...",
      "I'm proud because..."
    ]
  },

  transitions: [
    "What struck me most was",
    "The interesting thing is",
    "I found myself thinking",
    "It dawned on me that",
    "Looking deeper",
    "What surprised me",
    "I couldn't help but notice",
    "The beauty of it was",
    "What made it special",
    "I'm realizing"
  ],

  endings: {
    forward_looking: [
      "I'm excited to see where this leads me.",
      "Tomorrow feels full of possibility.",
      "I can't wait to build on this momentum.",
      "This feels like just the beginning.",
      "I'm curious what tomorrow will bring."
    ],
    grateful: [
      "I'm grateful for this reminder of what I'm capable of.",
      "Thank you, universe, for this beautiful day.",
      "I feel blessed to have experienced this.",
      "What a gift this day has been.",
      "I'm thankful for every moment of today."
    ],
    reflective: [
      "These are the moments that make life meaningful.",
      "I want to remember this feeling forever.",
      "This is what living feels like.",
      "Days like this remind me who I'm becoming.",
      "I'm proud of how far I've come."
    ],
    peaceful: [
      "I'm going to sleep with a smile tonight.",
      "My heart feels full as I end this day.",
      "I'm at peace with where I am right now.",
      "This contentment is exactly what I needed.",
      "I feel centered and whole."
    ],
    determined: [
      "This momentum is going to carry me forward.",
      "I'm more motivated than ever.",
      "Nothing can stop me when I feel like this.",
      "This confidence is going to change everything.",
      "I'm ready for whatever comes next."
    ]
  },

  writingTones: {
    conversational: {
      phrases: ["honestly", "you know what", "the thing is", "I have to say", "it's funny how"],
      style: "casual and intimate"
    },
    poetic: {
      phrases: ["like waves", "whispered", "danced through", "painted", "bloomed"],
      style: "metaphorical and lyrical"
    },
    analytical: {
      phrases: ["I analyzed", "the pattern I notice", "breaking it down", "the key insight", "strategically"],
      style: "thoughtful and systematic"
    },
    energetic: {
      phrases: ["amazing!", "incredible", "blown away", "absolutely thrilled", "can't contain"],
      style: "enthusiastic and vibrant"
    },
    contemplative: {
      phrases: ["I wonder", "perhaps", "it seems to me", "I'm beginning to understand", "slowly"],
      style: "thoughtful and measured"
    }
  }
};

// Enhanced content generation patterns
const contentStructures = {
  chronological: {
    template: "Start with morning/early events, move through the day, end with evening reflection",
    markers: ["This morning", "As the day progressed", "By afternoon", "As evening approached"]
  },
  thematic: {
    template: "Focus on one main theme or experience, explore it deeply",
    markers: ["The theme of today was", "Everything centered around", "I kept coming back to"]
  },
  emotional_journey: {
    template: "Track emotional changes throughout the day",
    markers: ["I started feeling", "My mood shifted when", "By the end, I felt"]
  },
  achievement_focused: {
    template: "Highlight accomplishments and progress",
    markers: ["I'm proud that", "A breakthrough moment was", "I achieved"]
  },
  relationship_centered: {
    template: "Focus on interactions and connections",
    markers: ["My connection with", "I was touched by", "The conversation that stood out"]
  },
  learning_oriented: {
    template: "Emphasize insights and growth",
    markers: ["I learned that", "It became clear", "I'm understanding"]
  }
};

// Generate diverse journal entry with enhanced AI
function generateAdvancedJournalEntry() {
  updateAIStatus("Analyzing your unique voice and crafting personalized content...");

  // Show loading indicator
  const loadingIndicator = document.getElementById('loadingIndicator');
  if (loadingIndicator) {
    loadingIndicator.classList.remove('hidden');
  }

  // Analyze conversation for personality and style
  const conversationAnalysis = analyzeConversationStyle();

  // Compile all user messages for context
  const userMessages = chatHistory.filter(m => m.role === 'user').map(m => m.content).join('\n\n');

  // Get CSRF token
  const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

  // Prepare enhanced form data with style analysis
  const formData = new FormData();
  formData.append('journal_content', userMessages);
  formData.append('conversation_context', JSON.stringify(chatHistory));
  formData.append('template_type', currentJournalTemplate || 'free-form');
  formData.append('writing_style_analysis', JSON.stringify(conversationAnalysis));
  formData.append('style_preferences', JSON.stringify({
    avoid_repetitive_openings: true,
    use_diverse_structures: true,
    match_user_voice: true,
    vary_sentence_length: true,
    include_specific_details: true
  }));

  if (quickPhotoFile) {
    formData.append('journal_photo', quickPhotoFile);
  }

  // Make enhanced API call
  fetch('/api/demo-journal/', {
    method: 'POST',
    headers: {
      'X-CSRFToken': csrfToken
    },
    body: formData
  })
  .then(response => {
    if (!response.ok) {
      if (response.status === 429) {
        throw new Error('Rate limit exceeded. Please wait a moment before trying again.');
      }
      throw new Error('Server error: ' + response.status);
    }
    return response.json();
  })
  .then(data => {
    // Hide loading indicator
    if (loadingIndicator) {
      loadingIndicator.classList.add('hidden');
    }

    if (data.error) {
      showFeedback(data.error, 'error');
      return;
    }

    // If the backend doesn't support the new parameters yet,
    // enhance the content on the frontend
    if (data.entry && data.entry.includes('As I sit down to reflect') ||
        data.entry.includes('As I look back')) {
      data.entry = enhanceJournalContent(data.entry, conversationAnalysis);
    }

    // Add final AI response
    const finalResponse = "I've crafted a unique journal entry that captures your personal voice and style. Each entry I create is tailored to sound like you, not like a template!";
    addMessageToChat(finalResponse, 'ai');
    chatHistory.push({ role: 'assistant', content: finalResponse });

    // Populate form and switch
    populateFormWithAIContent(data);
    switchToManualForm();

    showFeedback('🎉 Your personalized journal entry is ready! Notice how it sounds uniquely like you.', 'success');
    updateAIStatus("Created a unique entry that matches your voice!");
  })
  .catch(error => {
    console.error('Error:', error);

    if (loadingIndicator) {
      loadingIndicator.classList.add('hidden');
    }

    showFeedback(error.message || 'Sorry, we encountered an error. Please try again later.', 'error');
    updateAIStatus("Ready to help - let's try again!");
  });
}

// Analyze user's conversation style and preferences
function analyzeConversationStyle() {
  const userMessages = chatHistory.filter(m => m.role === 'user').map(m => m.content);
  const allText = userMessages.join(' ').toLowerCase();

  const analysis = {
    tone: 'conversational', // default
    energy_level: 'medium',
    detail_preference: 'moderate',
    emotional_expression: 'balanced',
    structure_preference: 'mixed',
    vocabulary_style: 'everyday'
  };

  // Analyze tone
  const enthusiasticWords = ['amazing', 'incredible', 'awesome', 'fantastic', 'love', 'excited'];
  const contemplativeWords = ['think', 'reflect', 'consider', 'ponder', 'realize', 'understand'];
  const analyticalWords = ['analyze', 'process', 'systematic', 'logical', 'structure', 'organize'];

  const enthusiasticCount = enthusiasticWords.filter(word => allText.includes(word)).length;
  const contemplativeCount = contemplativeWords.filter(word => allText.includes(word)).length;
  const analyticalCount = analyticalWords.filter(word => allText.includes(word)).length;

  if (enthusiasticCount > contemplativeCount && enthusiasticCount > analyticalCount) {
    analysis.tone = 'energetic';
    analysis.energy_level = 'high';
  } else if (contemplativeCount > enthusiasticCount && contemplativeCount > analyticalCount) {
    analysis.tone = 'contemplative';
    analysis.energy_level = 'calm';
  } else if (analyticalCount > enthusiasticCount && analyticalCount > contemplativeCount) {
    analysis.tone = 'analytical';
    analysis.structure_preference = 'organized';
  }

  // Analyze detail level
  const avgMessageLength = userMessages.reduce((sum, msg) => sum + msg.length, 0) / userMessages.length;
  if (avgMessageLength > 200) {
    analysis.detail_preference = 'high';
  } else if (avgMessageLength < 100) {
    analysis.detail_preference = 'concise';
  }

  // Analyze emotional expression
  const emotionWords = ['feel', 'felt', 'emotion', 'heart', 'soul', 'joy', 'sad', 'happy', 'angry', 'peaceful'];
  const emotionCount = emotionWords.filter(word => allText.includes(word)).length;

  if (emotionCount > 3) {
    analysis.emotional_expression = 'high';
  } else if (emotionCount < 1) {
    analysis.emotional_expression = 'reserved';
  }

  return analysis;
}

// Enhance journal content to be more diverse and personal
function enhanceJournalContent(originalContent, styleAnalysis) {
  // Remove formulaic openings
  let enhanced = originalContent.replace(/^As I sit down to reflect[^.]*\./i, '');
  enhanced = enhanced.replace(/^As I look back[^.]*\./i, '');
  enhanced = enhanced.replace(/^Reflecting on my day[^.]*\./i, '');
  enhanced = enhanced.trim();

  // Choose a diverse opening based on style analysis
  const openingStyle = chooseOpeningStyle(styleAnalysis);
  const openings = journalWritingStyles.openings[openingStyle];
  const selectedOpening = openings[Math.floor(Math.random() * openings.length)];

  // Choose appropriate ending
  const endingStyle = chooseEndingStyle(styleAnalysis);
  const endings = journalWritingStyles.endings[endingStyle];
  const selectedEnding = endings[Math.floor(Math.random() * endings.length)];

  // Replace formulaic ending if it exists
  enhanced = enhanced.replace(/As I close this journal entry[^.]*\./i, selectedEnding);
  enhanced = enhanced.replace(/In conclusion[^.]*\./i, selectedEnding);

  // Add diverse opening
  enhanced = selectedOpening + ' ' + enhanced;

  // Add better transitions
  const transitions = journalWritingStyles.transitions;
  const randomTransition = transitions[Math.floor(Math.random() * transitions.length)];

  // Replace repetitive transitions
  enhanced = enhanced.replace(/\bAnd\b/g, randomTransition);
  enhanced = enhanced.replace(/\bAlso\b/g, randomTransition);

  // Ensure it ends properly if it doesn't already
  if (!enhanced.match(/[.!?]$/)) {
    enhanced += ' ' + selectedEnding;
  }

  return enhanced;
}

// Choose opening style based on user's communication pattern
function chooseOpeningStyle(analysis) {
  const styles = ['reflective', 'immediate', 'narrative', 'emotional', 'philosophical', 'grateful', 'direct'];

  if (analysis.tone === 'energetic') {
    return Math.random() > 0.5 ? 'immediate' : 'emotional';
  } else if (analysis.tone === 'contemplative') {
    return Math.random() > 0.5 ? 'philosophical' : 'reflective';
  } else if (analysis.tone === 'analytical') {
    return Math.random() > 0.5 ? 'direct' : 'narrative';
  }

  // For balanced/conversational tone, use variety
  return styles[Math.floor(Math.random() * styles.length)];
}

// Choose ending style based on content and mood
function chooseEndingStyle(analysis) {
  const styles = ['forward_looking', 'grateful', 'reflective', 'peaceful', 'determined'];

  if (analysis.energy_level === 'high') {
    return Math.random() > 0.5 ? 'determined' : 'forward_looking';
  } else if (analysis.emotional_expression === 'high') {
    return Math.random() > 0.5 ? 'grateful' : 'peaceful';
  }

  return styles[Math.floor(Math.random() * styles.length)];
}

// Update AI status
function updateAIStatus(message) {
  const statusText = document.getElementById('aiStatusText');
  if (statusText) {
    statusText.textContent = message;
  }
}

// Update conversation progress
function updateConversationProgress() {
  const progressElement = document.getElementById('conversationProgress');
  if (!progressElement) return;

  const userMessageCount = chatHistory.filter(m => m.role === 'user').length;

  const progressMessages = {
    0: "Ready to start your journal",
    1: "Great start! Tell me more",
    2: "Getting deeper insights",
    3: "Almost ready to create your entry",
    4: "Perfect! Creating your journal"
  };

  const message = progressMessages[Math.min(userMessageCount, 4)] || "Creating amazing content";
  progressElement.textContent = message;
}

// Enhanced quick character counter
function countQuickChars() {
  const textArea = document.getElementById('quickNotes');
  const charCount = document.getElementById('quickCharCount');

  if (!textArea || !charCount) {
    return;
  }

  const count = textArea.value.length;
  charCount.textContent = count;

  // Color coding
  if (count < 10) {
    charCount.className = 'text-gray-400';
  } else if (count < 100) {
    charCount.className = 'text-yellow-600';
  } else {
    charCount.className = 'text-green-600';
  }
}

// Voice input functionality
function setupVoiceInput() {
  if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
    const voiceBtn = document.getElementById('voiceInputBtn');
    if (voiceBtn) {
      voiceBtn.style.display = 'none';
    }
    return;
  }

  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  voiceRecognition = new SpeechRecognition();

  voiceRecognition.continuous = true;
  voiceRecognition.interimResults = true;
  voiceRecognition.lang = 'en-US';

  voiceRecognition.onstart = function() {
    isVoiceInputActive = true;
    updateVoiceButton();
  };

  voiceRecognition.onend = function() {
    isVoiceInputActive = false;
    updateVoiceButton();
  };

  voiceRecognition.onresult = function(event) {
    let finalTranscript = '';
    let interimTranscript = '';

    for (let i = event.resultIndex; i < event.results.length; i++) {
      const transcript = event.results[i][0].transcript;
      if (event.results[i].isFinal) {
        finalTranscript += transcript;
      } else {
        interimTranscript += transcript;
      }
    }

    const quickNotes = document.getElementById('quickNotes');
    if (quickNotes) {
      if (finalTranscript) {
        quickNotes.value += finalTranscript;
        handleSmartInput(quickNotes);
      }
    }
  };
}

function toggleVoiceInput() {
  if (!voiceRecognition) return;

  if (isVoiceInputActive) {
    voiceRecognition.stop();
  } else {
    voiceRecognition.start();
  }
}

function updateVoiceButton() {
  const voiceBtn = document.getElementById('voiceInputBtn');
  if (!voiceBtn) return;

  if (isVoiceInputActive) {
    voiceBtn.classList.add('bg-red-100', 'text-red-600');
    voiceBtn.classList.remove('hover:bg-gray-100');
  } else {
    voiceBtn.classList.remove('bg-red-100', 'text-red-600');
    voiceBtn.classList.add('hover:bg-gray-100');
  }
}

// Initialize smart suggestions
function initializeSmartSuggestions() {
  // This will be enhanced based on user's writing patterns over time
}

// Setup advanced features
function setupAdvancedFeatures() {
  // Auto-save draft functionality
  const quickNotes = document.getElementById('quickNotes');
  if (quickNotes) {
    const debouncedSave = debounce(() => {
      if (quickNotes.value.length > 20) {
        localStorage.setItem('journal_draft', quickNotes.value);
      }
    }, 1000);

    quickNotes.addEventListener('input', debouncedSave);

    // Restore draft
    const draft = localStorage.getItem('journal_draft');
    if (draft && quickNotes.value === '') {
      quickNotes.value = draft;
      handleSmartInput(quickNotes);
    }
  }
}

// SCROLL FIX: Optimized debounce function
function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

// SCROLL FIX: Initialize with better performance
document.addEventListener('DOMContentLoaded', function() {
  initializeJournalForm();
  initializeAnimations();
  setupEnhancedUX();
  setupScrollOptimizations();
  initializeChatInterface();
  enhanceFormSubmission();
  updateAIStatus("Ready to create amazing journal entries!");
});

function initializeChatInterface() {
  // Initialize quick notes character counter
  countQuickChars();

  // Set up auto-resize for quick notes
  const quickNotes = document.getElementById('quickNotes');
  if (quickNotes) {
    quickNotes.addEventListener('input', function() {
      countQuickChars();
      // Auto-resize
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 120) + 'px';
    });
  }
}

// Quick notes character counter
function countQuickChars() {
  const textArea = document.getElementById('quickNotes');
  const charCount = document.getElementById('quickCharCount');

  if (!textArea || !charCount) {
    return;
  }

  charCount.textContent = textArea.value.length;
}

// Add suggestion to quick notes
function addQuickSuggestion(text) {
  const textArea = document.getElementById('quickNotes');
  if (!textArea) return;

  let currentText = textArea.value;

  if (currentText && !currentText.endsWith('\n') && !currentText.endsWith(' ')) {
    currentText += ' ';
  }

  textArea.value = currentText + text + ' ';
  textArea.focus();

  countQuickChars();

  // Auto-resize
  textArea.style.height = 'auto';
  textArea.style.height = Math.min(textArea.scrollHeight, 120) + 'px';

  // Move cursor to end
  textArea.selectionStart = textArea.selectionEnd = textArea.value.length;

  showFeedback(`Added "${text}" to your notes`, 'success', 1500);
}

// Handle quick photo selection
function handleQuickFileSelect(input) {
  if (!input.files || !input.files[0]) return;

  const file = input.files[0];

  // Check file size (max 5MB)
  if (file.size > 5 * 1024 * 1024) {
    showFeedback('Image file is too large. Please select an image under 5MB.', 'error');
    input.value = '';
    return;
  }

  // Check file type
  if (!file.type.match('image.*')) {
    showFeedback('Only image files are allowed.', 'error');
    input.value = '';
    return;
  }

  quickPhotoFile = file;

  const reader = new FileReader();
  reader.onload = function(e) {
    quickPhotoDataUrl = e.target.result;

    const preview = document.getElementById('quickPhotoPreview');
    if (preview) {
      preview.src = quickPhotoDataUrl;
    }

    const container = document.getElementById('quickPhotoContainer');
    if (container) {
      container.classList.remove('hidden');
    }

    const photoName = document.getElementById('quickPhotoName');
    if (photoName) {
      photoName.textContent = file.name;
    }

    showFeedback('Photo added successfully', 'success', 2000);
  };

  reader.readAsDataURL(file);
}

// Remove quick photo
function removeQuickPhoto() {
  const photoInput = document.getElementById('quickPhotoInput');
  if (photoInput) {
    photoInput.value = '';
  }

  const container = document.getElementById('quickPhotoContainer');
  if (container) {
    container.classList.add('hidden');
  }

  quickPhotoFile = null;
  quickPhotoDataUrl = null;

  showFeedback('Photo removed', 'info', 2000);
}

// Generate journal entry with AI
function generateJournalEntry() {
  const quickNotes = document.getElementById('quickNotes');
  if (!quickNotes || quickNotes.value.trim() === '') {
    showFeedback('Please share some notes about your day first', 'warning');
    quickNotes.focus();
    return;
  }

  const userMessage = quickNotes.value.trim();

  // Add to chat history
  chatHistory.push({ role: 'user', content: userMessage });

  // Display user message
  addMessageToChat(userMessage, 'user');

  // Clear input
  quickNotes.value = '';
  quickNotes.style.height = 'auto';
  countQuickChars();

  // Show thinking indicator
  const thinkingIndicator = document.getElementById('thinkingIndicator');
  if (thinkingIndicator) {
    thinkingIndicator.classList.remove('hidden');
  }

  // Show loading indicator
  const loadingIndicator = document.getElementById('loadingIndicator');
  if (loadingIndicator) {
    loadingIndicator.classList.remove('hidden');
  }

  // Disable generate button
  const generateBtn = document.getElementById('generateEntryBtn');
  if (generateBtn) {
    generateBtn.disabled = true;
    generateBtn.innerHTML = `
      <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
    `;
  }

  // Get CSRF token
  const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

  // Prepare form data
  const formData = new FormData();
  formData.append('journal_content', userMessage);

  if (quickPhotoFile) {
    formData.append('journal_photo', quickPhotoFile);
  }

  // Make API call to generate journal entry
  fetch('/api/demo-journal/', {
    method: 'POST',
    headers: {
      'X-CSRFToken': csrfToken
    },
    body: formData
  })
  .then(response => {
    if (!response.ok) {
      if (response.status === 429) {
        throw new Error('Rate limit exceeded. Please wait a moment before trying again.');
      }
      throw new Error('Server error: ' + response.status);
    }
    return response.json();
  })
  .then(data => {
    // Hide loading indicator
    if (loadingIndicator) {
      loadingIndicator.classList.add('hidden');
    }

    // Hide thinking indicator
    if (thinkingIndicator) {
      thinkingIndicator.classList.add('hidden');
    }

    // Re-enable generate button
    if (generateBtn) {
      generateBtn.disabled = false;
      generateBtn.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7" />
        </svg>
      `;
    }

    if (data.error) {
      showFeedback(data.error, 'error');
      return;
    }

    // Add AI response to chat
    const aiResponse = "Perfect! I've created a beautiful journal entry based on what you shared. You can now review and edit it in the form below.";
    chatHistory.push({ role: 'assistant', content: aiResponse });
    addMessageToChat(aiResponse, 'ai');

    // Populate the form with generated content
    populateFormWithAIContent(data);

    // Switch to manual form
    switchToManualForm();

    showFeedback('Journal entry generated successfully!', 'success');
  })
  .catch(error => {
    console.error('Error:', error);

    // Hide loading indicator
    if (loadingIndicator) {
      loadingIndicator.classList.add('hidden');
    }

    // Hide thinking indicator
    if (thinkingIndicator) {
      thinkingIndicator.classList.add('hidden');
    }

    // Re-enable generate button
    if (generateBtn) {
      generateBtn.disabled = false;
      generateBtn.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7" />
        </svg>
      `;
    }

    showFeedback(error.message || 'Sorry, we encountered an error. Please try again later.', 'error');
  });
}

// Add message to chat
function addMessageToChat(message, role) {
  const chatHistoryContainer = document.getElementById('chatHistory');
  if (!chatHistoryContainer) {
    return;
  }

  const messageElement = document.createElement('div');
  messageElement.classList.add('chat-bubble', role);

  // Use handwritten class for AI messages
  if (role === 'ai') {
    messageElement.classList.add('handwritten');
  } else {
    messageElement.classList.add('diary-font');
  }

  messageElement.innerHTML = `<p>${message}</p>`;
  chatHistoryContainer.appendChild(messageElement);

  // Scroll to the bottom of the chat
  const chatContainer = document.getElementById('chatContainer');
  if (chatContainer) {
    chatContainer.scrollTop = chatContainer.scrollHeight;
  }
}

// Populate form with AI-generated content
function populateFormWithAIContent(data) {
  // Set title
  const titleField = document.getElementById('id_title');
  if (titleField && data.title) {
    titleField.value = data.title;
    titleField.classList.add('auto-populated');
    setTimeout(() => titleField.classList.remove('auto-populated'), 2000);
  }

  // Set content
  const contentField = document.getElementById('journalInput');
  if (contentField && data.entry) {
    contentField.value = data.entry;
    contentField.classList.add('auto-populated');
    setTimeout(() => contentField.classList.remove('auto-populated'), 2000);

    // Auto-resize content field
    contentField.style.height = 'auto';
    const newHeight = Math.min(contentField.scrollHeight, window.innerHeight * 0.4);
    contentField.style.height = newHeight + 'px';
  }

  // Transfer photo if exists from AI chat
  if (quickPhotoFile && quickPhotoDataUrl) {
    // Update main form photo preview
    const preview = document.getElementById('photoPreview');
    if (preview) {
      preview.src = quickPhotoDataUrl;
    }

    const previewContainer = document.getElementById('photoPreviewContainer');
    if (previewContainer) {
      previewContainer.classList.remove('hidden');
    }

    const photoName = document.getElementById('photoName');
    if (photoName) {
      photoName.textContent = quickPhotoFile.name;
    }

    // Transfer the file to the main form input
    const fileInput = document.getElementById('journalPhoto');
    if (fileInput) {
      try {
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(quickPhotoFile);
        fileInput.files = dataTransfer.files;
        console.log('Photo transferred to main form:', quickPhotoFile.name);
      } catch (error) {
        console.warn('Could not transfer photo to main form:', error);
        // Fallback: Keep the photo data for manual submission
        window.pendingPhotoFile = quickPhotoFile;
      }
    }
  }

  // Update character count
  countChars();

  // Re-initialize form components
  if (typeof initModernMoodSlider === 'function') {
    initModernMoodSlider();
  }
  if (typeof initModernTagsInput === 'function') {
    initModernTagsInput();
  }
}

// Helper function to generate title from content
function generateTitleFromContent(content) {
  if (!content) return 'My Journal Entry';

  const today = new Date();
  const dateStr = today.toLocaleDateString('en-US', { month: 'long', day: 'numeric' });

  // Try to extract a meaningful title from the first sentence
  const firstSentence = content.split(/[.!?]/)[0].trim();
  if (firstSentence.length > 10 && firstSentence.length < 50) {
    return firstSentence;
  }

  return `Journal Entry - ${dateStr}`;
}

// Show editing tips after AI generation
function showEditingTips() {
  setTimeout(() => {
    showFeedback('💡 Tip: You can now edit the title, content, mood, and tags before saving!', 'info', 5000);
  }, 1000);
}

// Switch to manual form with editing enhancements
function switchToManualForm() {
  const chatArea = document.getElementById('chatArea');
  const journalForm = document.getElementById('journalForm');

  if (chatArea) {
    chatArea.classList.add('hidden');
  }

  if (journalForm) {
    journalForm.classList.remove('hidden');

    // Scroll to form
    setTimeout(() => {
      journalForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 100);
  }

  // Add editing controls
  addEditingControls();

  // Focus on content field for immediate editing
  setTimeout(() => {
    const contentField = document.getElementById('journalInput');
    if (contentField) {
      contentField.focus();
      // Position cursor at the end
      contentField.setSelectionRange(contentField.value.length, contentField.value.length);
    }
  }, 500);
}

// Add enhanced editing controls
function addEditingControls() {
  const journalForm = document.getElementById('journalForm');
  if (!journalForm) return;

  // Check if controls already exist
  if (document.getElementById('editingControls')) return;

  const editingControls = document.createElement('div');
  editingControls.id = 'editingControls';
  editingControls.className = 'mb-6 bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-xl border border-blue-200 animate-fade-in';
  editingControls.innerHTML = `
    <div class="flex items-start gap-3">
      <div class="flex-shrink-0">
        <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
          </svg>
        </div>
      </div>
      <div class="flex-1">
        <h4 class="text-sm font-semibold text-blue-900 mb-1">✨ Your AI-generated journal is ready to edit!</h4>
        <p class="text-sm text-blue-700 mb-3">Feel free to personalize the content, adjust the mood, add tags, or modify anything to make it truly yours.</p>
        <div class="flex flex-wrap gap-2">
          <button type="button" onclick="highlightEditableAreas()" class="inline-flex items-center gap-1 text-xs bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-1 rounded-full transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            Show what you can edit
          </button>
          <button type="button" onclick="regenerateWithMoreDetails()" class="inline-flex items-center gap-1 text-xs bg-green-100 hover:bg-green-200 text-green-700 px-3 py-1 rounded-full transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg>
            Add more details with AI
          </button>
          <button type="button" onclick="switchBackToChat()" class="inline-flex items-center gap-1 text-xs bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1 rounded-full transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
            </svg>
            Back to AI chat
          </button>
        </div>
      </div>
      <button type="button" onclick="dismissEditingControls()" class="flex-shrink-0 text-blue-400 hover:text-blue-600 transition-colors" title="Dismiss">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
  `;

  journalForm.parentNode.insertBefore(editingControls, journalForm);
}

// Highlight editable areas
function highlightEditableAreas() {
  const editableElements = [
    document.getElementById('id_title'),
    document.getElementById('journalInput'),
    document.getElementById('moodSlider'),
    document.getElementById('id_tags')
  ];

  editableElements.forEach(element => {
    if (element) {
      element.style.transition = 'all 0.3s ease';
      element.style.boxShadow = '0 0 0 3px rgba(59, 130, 246, 0.3)';
      element.style.borderColor = '#3B82F6';
    }
  });

  // Show tooltip-style messages
  showFieldTooltips();

  // Remove highlights after 3 seconds
  setTimeout(() => {
    editableElements.forEach(element => {
      if (element) {
        element.style.boxShadow = '';
        element.style.borderColor = '';
      }
    });
    hideFieldTooltips();
  }, 3000);

  showFeedback('✨ Highlighted all editable areas - click on any to start editing!', 'info', 3000);
}

// Show field tooltips
function showFieldTooltips() {
  const tooltips = [
    { element: document.getElementById('id_title'), message: 'Edit your journal title' },
    { element: document.getElementById('journalInput'), message: 'Modify your journal content' },
    { element: document.getElementById('moodSlider'), message: 'Adjust your mood' },
    { element: document.getElementById('id_tags'), message: 'Add or remove tags' }
  ];

  tooltips.forEach(({ element, message }) => {
    if (element) {
      const tooltip = document.createElement('div');
      tooltip.className = 'absolute z-50 bg-gray-800 text-white text-xs rounded px-2 py-1 pointer-events-none whitespace-nowrap editing-tooltip';
      tooltip.textContent = message;

      const rect = element.getBoundingClientRect();
      tooltip.style.top = (rect.top - 30) + 'px';
      tooltip.style.left = rect.left + 'px';

      document.body.appendChild(tooltip);
    }
  });
}

// Hide field tooltips
function hideFieldTooltips() {
  document.querySelectorAll('.editing-tooltip').forEach(tooltip => {
    tooltip.remove();
  });
}

// Regenerate with more details
function regenerateWithMoreDetails() {
  // Switch back to chat but keep the current content as context
  const currentContent = document.getElementById('journalInput').value;

  // Add current content to chat history as context
  chatHistory.push({
    role: 'assistant',
    content: `I can help you add more details to your journal entry. Here's what we have so far: "${currentContent.substring(0, 100)}..." What would you like me to expand on or add?`
  });

  switchBackToChat();

  // Add message to chat
  addMessageToChat("I can help you add more details to your journal entry. What would you like me to expand on or add?", 'ai');

  // Pre-populate the input with a helpful prompt
  const quickNotes = document.getElementById('quickNotes');
  if (quickNotes) {
    quickNotes.placeholder = "Tell me what to add or expand on...";
    quickNotes.focus();
  }

  showFeedback('💬 Tell the AI what details you\'d like to add to your journal!', 'info', 4000);
}

// Dismiss editing controls
function dismissEditingControls() {
  const editingControls = document.getElementById('editingControls');
  if (editingControls) {
    editingControls.style.opacity = '0';
    editingControls.style.transform = 'translateY(-10px)';
    setTimeout(() => {
      editingControls.remove();
    }, 300);
  }
}

// Enhanced switch back to chat with content preservation
function switchBackToChat() {
  const chatArea = document.getElementById('chatArea');
  const journalForm = document.getElementById('journalForm');
  const editingControls = document.getElementById('editingControls');

  if (chatArea) {
    chatArea.classList.remove('hidden');
  }

  if (journalForm) {
    journalForm.classList.add('hidden');
  }

  if (editingControls) {
    editingControls.remove();
  }

  // Scroll to chat
  setTimeout(() => {
    chatArea.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }, 100);
}

// Enhanced form submission with validation
function enhanceFormSubmission() {
  const form = document.getElementById('journalForm');
  if (!form) return;

  form.addEventListener('submit', function(e) {
    // Add a loading state to the submit button
    const submitBtn = form.querySelector('button[type="submit"]');
    if (submitBtn) {
      const originalText = submitBtn.innerHTML;
      submitBtn.disabled = true;
      submitBtn.innerHTML = `
        <svg class="animate-spin h-4 w-4 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        Saving...
      `;

      // Re-enable after 3 seconds in case of issues
      setTimeout(() => {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
      }, 3000);
    }

    showFeedback('Saving your journal entry...', 'info', 2000);
  });
}

// SCROLL FIX: New scroll optimization function
function setupScrollOptimizations() {
  let isScrolling = false;
  let scrollTimeout;
  let ticking = false;

  function handleScrollPerformance() {
    if (!ticking) {
      requestAnimationFrame(() => {
        if (isScrolling) {
          document.body.classList.add('is-scrolling');
        } else {
          document.body.classList.remove('is-scrolling');
        }
        ticking = false;
      });
      ticking = true;
    }
  }

  window.addEventListener('scroll', function() {
    if (!isScrolling) {
      isScrolling = true;
    }

    handleScrollPerformance();

    clearTimeout(scrollTimeout);
    scrollTimeout = setTimeout(() => {
      isScrolling = false;
      handleScrollPerformance();
    }, 150);
  }, { passive: true });

  // SCROLL FIX: Prevent scroll jank on mobile
  if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
    document.addEventListener('touchmove', function(e) {
      const target = e.target.closest('#journalContainer, .mobile-menu');
      if (!target) return;

      if (target.id === 'journalContainer') {
        return;
      }

      const scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
      const scrollHeight = document.documentElement.scrollHeight || document.body.scrollHeight;
      const clientHeight = document.documentElement.clientHeight;

      if ((scrollTop === 0 && e.touches[0].clientY > e.touches[0].clientY) ||
          (scrollTop + clientHeight >= scrollHeight && e.touches[0].clientY < e.touches[0].clientY)) {
        e.preventDefault();
      }
    }, { passive: false });
  }
}

function setupEnhancedUX() {
  initFeedbackSystem();
  setupKeyboardShortcuts();
  setupAccessibilityFeatures();
}

function initFeedbackSystem() {
  if (!document.getElementById('feedback-container')) {
    const container = document.createElement('div');
    container.id = 'feedback-container';
    container.className = 'fixed bottom-4 right-4 flex flex-col gap-2 z-50';
    document.body.appendChild(container);
  }
}

// SCROLL FIX: Optimized feedback system
function showFeedback(message, type = 'info', duration = 3000) {
  const container = document.getElementById('feedback-container');
  if (!container) return;

  const toast = document.createElement('div');
  toast.className = `feedback-toast ${type}`;

  let icon = '';
  switch (type) {
    case 'success':
      icon = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>';
      break;
    case 'error':
      icon = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>';
      break;
    case 'warning':
      icon = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>';
      break;
    default:
      icon = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>';
  }

  toast.innerHTML = `
    ${icon}
    <span>${message}</span>
    <button class="ml-auto text-white opacity-80 hover:opacity-100" onclick="this.parentElement.remove()" aria-label="Dismiss">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
      </svg>
    </button>
  `;

  container.appendChild(toast);
  toast.offsetHeight;
  toast.classList.add('show');

  if (duration > 0) {
    setTimeout(() => {
      toast.classList.remove('show');
      setTimeout(() => toast.remove(), 300);
    }, duration);
  }

  return toast;
}

function setupKeyboardShortcuts() {
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      document.querySelectorAll('.fixed.inset-0').forEach(modal => {
        if (modal.classList.contains('z-50')) {
          modal.remove();
        }
      });
    }

    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
      e.preventDefault();
      const searchInput = document.getElementById('journalInput');
      if (searchInput) {
        searchInput.focus();
      }
    }

    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
      e.preventDefault();
      const submitBtn = document.querySelector('button[type="submit"]');
      if (submitBtn && !submitBtn.disabled) {
        submitBtn.click();
      }
    }
  });
}

function setupAccessibilityFeatures() {
  document.querySelectorAll('button:not([aria-label])').forEach(btn => {
    if (btn.title) {
      btn.setAttribute('aria-label', btn.title);
    }
  });

  document.addEventListener('keydown', function(e) {
    if (e.key === 'Tab') {
      document.body.classList.add('keyboard-navigation');
    }
  });

  document.addEventListener('mousedown', function() {
    document.body.classList.remove('keyboard-navigation');
  });
}

// SCROLL FIX: Initialize journal form with better performance
function initializeJournalForm() {
  setupOptimizedDragAndDrop();
  initModernMoodSlider();
  initModernTagsInput();

  // SCROLL FIX: Better textarea handling
  const journalInput = document.getElementById('journalInput');
  if (journalInput) {
    const debouncedResize = debounce(function() {
      // SCROLL FIX: Limit max height to prevent scroll issues
      const maxHeight = window.innerHeight * 0.4; // 40% of viewport height
      this.style.height = 'auto';
      const newHeight = Math.min(this.scrollHeight, maxHeight);
      this.style.height = newHeight + 'px';
    }, 100);

    journalInput.addEventListener('input', function() {
      countChars();
      debouncedResize.call(this);
    });

    // SCROLL FIX: Initial sizing with height limit
    setTimeout(() => {
      const maxHeight = window.innerHeight * 0.4;
      journalInput.style.height = 'auto';
      const newHeight = Math.min(journalInput.scrollHeight, maxHeight);
      journalInput.style.height = newHeight + 'px';
    }, 100);

    const journalContainer = document.getElementById('journalContainer');
    if (journalContainer) {
      journalInput.addEventListener('focus', function() {
        journalContainer.classList.add('input-focused');
      });

      journalInput.addEventListener('blur', function() {
        journalContainer.classList.remove('input-focused');
      });
    }
  }

  countChars();
}

// Character counter function
function countChars() {
  const textArea = document.getElementById('journalInput');
  const charCount = document.getElementById('charCount');

  if (!textArea || !charCount) {
    return;
  }

  const updateCount = () => {
    charCount.textContent = textArea.value.length;
  };

  // Set initial count
  updateCount();
}

// SCROLL FIX: Optimized drag and drop
function setupOptimizedDragAndDrop() {
  const dropArea = document.getElementById('journalContainer');
  const dropIndicator = document.getElementById('dropZoneIndicator');

  if (!dropArea || !dropIndicator) {
    return;
  }

  ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    dropArea.addEventListener(eventName, preventDefaults, { passive: false });
  });

  let isDraggingOver = false;

  dropArea.addEventListener('dragenter', function() {
    isDraggingOver = true;
    requestAnimationFrame(() => {
      if (isDraggingOver) {
        dropIndicator.classList.remove('hidden');
      }
    });
  }, { passive: true });

  dropArea.addEventListener('dragleave', function(e) {
    const rect = dropArea.getBoundingClientRect();
    const x = e.clientX;
    const y = e.clientY;

    if (x <= rect.left || x >= rect.right || y <= rect.top || y >= rect.bottom) {
      isDraggingOver = false;
      requestAnimationFrame(() => {
        if (!isDraggingOver) {
          dropIndicator.classList.add('hidden');
        }
      });
    }
  }, { passive: true });

  dropArea.addEventListener('drop', function(e) {
    isDraggingOver = false;
    requestAnimationFrame(() => {
      dropIndicator.classList.add('hidden');
    });

    const dt = e.dataTransfer;
    if (!dt.files || dt.files.length === 0) return;

    const file = dt.files[0];

    if (file.type.match('image.*')) {
      handleImageFile(file);
    } else {
      showFeedback('Only image files are allowed', 'error');
    }
  }, { passive: false });

  function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
  }
}

function handleImageFile(file) {
  if (file.size > 5 * 1024 * 1024) {
    showFeedback('File is too large. Maximum size is 5MB.', 'error');
    return;
  }

  currentPhotoFile = file;

  const reader = new FileReader();
  reader.onload = function(e) {
    currentPhotoDataUrl = e.target.result;

    const preview = document.getElementById('photoPreview');
    if (preview) {
      preview.src = currentPhotoDataUrl;
    }

    const previewContainer = document.getElementById('photoPreviewContainer');
    if (previewContainer) {
      previewContainer.classList.remove('hidden');
    }

    const photoName = document.getElementById('photoName');
    if (photoName) {
      photoName.textContent = file.name;
    }

    showFeedback('Photo added successfully', 'success', 2000);
  };

  reader.readAsDataURL(file);

  const fileInput = document.getElementById('journalPhoto');
  if (fileInput) {
    const dataTransfer = new DataTransfer();
    dataTransfer.items.add(file);
    fileInput.files = dataTransfer.files;
  }
}

function previewPhoto(event) {
  const fileInput = event.target;
  const file = fileInput.files[0];

  if (file) {
    if (file.size > 5 * 1024 * 1024) {
      showFeedback('File is too large. Maximum size is 5MB.', 'error');
      fileInput.value = '';
      return;
    }

    if (!file.type.match('image.*')) {
      showFeedback('Only image files are allowed.', 'error');
      fileInput.value = '';
      return;
    }

    handleImageFile(file);
  }
}

function removePhoto() {
  const fileInput = document.getElementById('journalPhoto');
  if (fileInput) {
    fileInput.value = '';
  }

  const previewContainer = document.getElementById('photoPreviewContainer');
  if (previewContainer) {
    previewContainer.classList.add('hidden');
  }

  currentPhotoFile = null;
  currentPhotoDataUrl = null;

  showFeedback('Photo removed', 'info', 2000);
}

function addSuggestion(text) {
  const textArea = document.getElementById('journalInput');
  if (!textArea) return;

  let currentText = textArea.value;

  if (currentText && !currentText.endsWith('\n') && !currentText.endsWith(' ')) {
    currentText += ' ';
  }

  textArea.value = currentText + text + ' ';
  textArea.focus();

  countChars();

  const inputEvent = new Event('input');
  textArea.dispatchEvent(inputEvent);

  textArea.selectionStart = textArea.selectionEnd = textArea.value.length;

  showFeedback(`Added "${text}" to your entry`, 'success', 1500);
}

// Modern Mood Slider
function initModernMoodSlider() {
  const moodSlider = document.getElementById('moodSlider');
  const moodThumb = document.getElementById('moodThumb');
  const moodValue = document.getElementById('moodValue');
  const moodEmoji = document.getElementById('moodEmoji');
  const moodThumbEmoji = document.getElementById('moodThumbEmoji');

  if (!moodSlider || !moodThumb || !moodValue) {
    return;
  }

  // Mood options mapping
  const moods = [
    { value: 'happy', emoji: '😊', position: '16.6%', color: '#4ade80' },
    { value: 'excited', emoji: '🤩', position: '33.3%', color: '#34d399' },
    { value: 'content', emoji: '😌', position: '50%', color: '#a78bfa' },
    { value: 'neutral', emoji: '😐', position: '66.6%', color: '#c4b5fd' },
    { value: 'anxious', emoji: '😰', position: '83.3%', color: '#fb923c' },
    { value: 'sad', emoji: '😢', position: '100%', color: '#f87171' }
  ];

  // Set initial position based on selected mood radio
  setMoodFromRadio();

  // Make the thumb draggable
  let isDragging = false;

  moodThumb.addEventListener('mousedown', function(e) {
    isDragging = true;
    updateMoodPosition(e);
  });

  document.addEventListener('mousemove', function(e) {
    if (!isDragging) return;
    updateMoodPosition(e);
  });

  document.addEventListener('mouseup', function() {
    isDragging = false;
  });

  // Touch support
  moodThumb.addEventListener('touchstart', function(e) {
    isDragging = true;
    updateMoodPosition(e.touches[0]);
  });

  document.addEventListener('touchmove', function(e) {
    if (!isDragging) return;
    updateMoodPosition(e.touches[0]);
  });

  document.addEventListener('touchend', function() {
    isDragging = false;
  });

  // Click anywhere on the track to set mood
  moodSlider.addEventListener('click', updateMoodPosition);

  function updateMoodPosition(e) {
    try {
      // Get position relative to the slider
      const sliderRect = moodSlider.getBoundingClientRect();
      const clientX = e.clientX || (e.touches && e.touches[0].clientX);

      if (!clientX) {
        return;
      }

      const relativeX = clientX - sliderRect.left;
      const percentage = Math.max(0, Math.min(100, (relativeX / sliderRect.width) * 100));

      // Find the closest mood
      const moodIndex = Math.min(
        Math.floor((percentage / 100) * moods.length),
        moods.length - 1
      );

      // Update the UI
      const selectedMood = moods[moodIndex];
      moodThumb.style.left = selectedMood.position;

      if (moodThumbEmoji) {
        moodThumbEmoji.textContent = selectedMood.emoji;
      }
      if (moodEmoji) {
        moodEmoji.textContent = selectedMood.emoji;
      }

      moodValue.textContent = selectedMood.value.charAt(0).toUpperCase() + selectedMood.value.slice(1);

      // Update the hidden radio button
      const radioToCheck = document.querySelector(`input[name="mood"][value="${selectedMood.value}"]`);
      if (radioToCheck) {
        radioToCheck.checked = true;
      }

      // Update background color with a smooth transition
      moodThumb.style.backgroundColor = 'white';
      moodThumb.style.boxShadow = `0 0 0 2px ${selectedMood.color}, 0 4px 6px -1px rgba(0, 0, 0, 0.1)`;
    } catch (error) {
      console.error("Error updating mood position:", error);
    }
  }

  function setMoodFromRadio() {
    // Find checked radio
    const checkedRadio = document.querySelector('input[name="mood"]:checked');
    if (!checkedRadio) {
      // Default to "content" if nothing is selected
      const defaultRadio = document.querySelector('input[name="mood"][value="content"]');
      if (defaultRadio) defaultRadio.checked = true;
      const defaultMood = moods.find(mood => mood.value === "content");
      if (defaultMood) {
        setMoodUI(defaultMood);
      }
      return;
    }

    // Find corresponding mood
    const selectedMood = moods.find(mood => mood.value === checkedRadio.value);
    if (!selectedMood) return;

    setMoodUI(selectedMood);
  }

  function setMoodUI(selectedMood) {
    // Update UI
    moodThumb.style.left = selectedMood.position;

    if (moodThumbEmoji) {
      moodThumbEmoji.textContent = selectedMood.emoji;
    }
    if (moodEmoji) {
      moodEmoji.textContent = selectedMood.emoji;
    }

    moodValue.textContent = selectedMood.value.charAt(0).toUpperCase() + selectedMood.value.slice(1);
    moodThumb.style.backgroundColor = 'white';
    moodThumb.style.boxShadow = `0 0 0 2px ${selectedMood.color}, 0 4px 6px -1px rgba(0, 0, 0, 0.1)`;
  }
}

// Modern Tags Input
function initModernTagsInput() {
  const tagsInput = document.getElementById('id_tags');
  const tagsList = document.getElementById('selectedTags');

  if (!tagsInput || !tagsList) {
    return;
  }

  // Display existing tags as pills
  updateTagPills();

  // Handle input changes
  tagsInput.addEventListener('input', function() {
    updateTagPills();
  });

  tagsInput.addEventListener('keydown', function(e) {
    // If Enter or comma is pressed, update pills
    if (e.key === 'Enter' || e.key === ',') {
      e.preventDefault();
      setTimeout(() => updateTagPills(), 10);
    }
  });
}

// Update visual tags pills
function updateTagPills() {
  const tagsInput = document.getElementById('id_tags');
  const tagsList = document.getElementById('selectedTags');

  if (!tagsInput || !tagsList) {
    return;
  }

  // Clear existing pills
  tagsList.innerHTML = '';

  // Get current tags
  const currentTags = tagsInput.value ? tagsInput.value.split(',').map(t => t.trim()).filter(t => t) : [];

  // Create a pill for each tag
  currentTags.forEach(tag => {
    const pill = document.createElement('div');
    pill.className = 'tag-pill';
    pill.innerHTML = `
      ${tag}
      <span class="remove-tag ml-1" data-tag="${tag}">×</span>
    `;
    tagsList.appendChild(pill);
  });

  // Add event listeners to remove buttons
  document.querySelectorAll('.remove-tag').forEach(button => {
    button.addEventListener('click', function() {
      removeTag(this.dataset.tag);
    });
  });
}

// Add tag
function addTag(tag) {
  const tagField = document.getElementById('id_tags');
  if (!tagField) {
    return;
  }

  let currentTags = tagField.value;

  // Don't add if tag already exists
  if (currentTags.split(',').map(t => t.trim()).includes(tag)) {
    return;
  }

  // Add comma if needed
  if (currentTags && !currentTags.endsWith(',') && currentTags.trim() !== '') {
    currentTags += ', ';
  }

  tagField.value = currentTags + tag;

  // Update visual pills
  updateTagPills();

  tagField.focus();

  // Move cursor to end
  tagField.selectionStart = tagField.selectionEnd = tagField.value.length;

  showFeedback(`Added tag: ${tag}`, 'success', 1000);
}

// Remove tag
function removeTag(tagToRemove) {
  const tagsInput = document.getElementById('id_tags');
  if (!tagsInput) return;

  // Get current tags
  let currentTags = tagsInput.value.split(',').map(t => t.trim()).filter(t => t);

  // Remove the tag
  currentTags = currentTags.filter(tag => tag !== tagToRemove);

  // Update the input value
  tagsInput.value = currentTags.join(', ');

  // Update visual representation
  updateTagPills();

  showFeedback(`Removed tag: ${tagToRemove}`, 'info', 1000);
}

function initializeAnimations() {
  if ('IntersectionObserver' in window) {
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          entry.target.classList.add('visible');
          observer.unobserve(entry.target);
        }
      });
    }, { threshold: 0.1 });

    document.querySelectorAll('.animate-fade-in, .animate-scale-in').forEach(el => {
      observer.observe(el);
    });
  }
}

// Initialize existing photo for edit mode
function initExistingPhoto() {
  const photoPreview = document.getElementById('photoPreview');
  const photoPreviewContainer = document.getElementById('photoPreviewContainer');

  if (photoPreview && photoPreview.src && photoPreview.src !== window.location.href) {
    if (photoPreviewContainer) {
      photoPreviewContainer.classList.remove('hidden');
    }
  }
}

// Make functions available globally for debugging
window.diaryFunctions = {
  addSuggestion,
  addTag,
  removeTag,
  updateTagPills,
  initModernMoodSlider,
  initModernTagsInput,
  showFeedback,
  countChars
};

// Initialize existing photo on load
document.addEventListener('DOMContentLoaded', function() {
  initExistingPhoto();
});

</script>
{% endblock %}
