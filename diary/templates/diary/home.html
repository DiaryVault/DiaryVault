{% extends "base.html" %}

{% block title %}DiaryVault{% endblock %}

{% block extra_css %}
<style>
  /* MOBILE-OPTIMIZED JOURNAL DESIGN */
  :root {
    --safe-area-inset-top: env(safe-area-inset-top);
    --safe-area-inset-bottom: env(safe-area-inset-bottom);
  }

  /* Core mobile styles */
  #journalInput {
    resize: none !important;
    width: 100% !important;
    border: none !important;
    outline: none !important;
    min-height: 250px;
    box-sizing: border-box !important;
    overflow-wrap: break-word;
    font-size: 16px !important; /* Prevents zoom on iOS */
    line-height: 1.7;
    -webkit-appearance: none;
    border-radius: 0;
    background: transparent;
    padding: 1rem !important;
  }

  #journalContainer {
    width: 100% !important;
    box-sizing: border-box !important;
    transition: all 0.2s ease;
    position: relative;
    -webkit-tap-highlight-color: transparent;
    background: white;
    border-radius: 1rem;
    border: 2px solid #e5e7eb;
    overflow: hidden;
  }

  #journalContainer:focus-within {
    border-color: #6366f1;
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
  }

  /* Main content wrapper */
  #main-content {
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
    padding: 0.75rem;
    padding-bottom: 2rem;
  }

  /* Typography */
  .diary-font {
    font-family: 'Playfair Display', serif;
    letter-spacing: -0.01em;
    line-height: 1.5;
  }

  .handwritten {
    font-family: 'Caveat', cursive;
    letter-spacing: 0.01em;
    line-height: 1.7;
  }

  /* Mobile-optimized cards */
  .mobile-card {
    background: white;
    border-radius: 1rem;
    padding: 1rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    border: 1px solid #f3f4f6;
    margin-bottom: 1rem;
  }

  /* Enhanced photo handling */
  .photo-attachment-area {
    background: #f9fafb;
    border-top: 1px solid #e5e7eb;
    padding: 0.75rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .photo-preview-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
    gap: 0.5rem;
    margin-top: 0.5rem;
  }

  .photo-thumbnail {
    position: relative;
    aspect-ratio: 1;
    border-radius: 0.5rem;
    overflow: hidden;
    background: #f3f4f6;
    border: 1px solid #e5e7eb;
  }

  .photo-thumbnail img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .photo-remove {
    position: absolute;
    top: 0.25rem;
    right: 0.25rem;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    border-radius: 50%;
    width: 1.5rem;
    height: 1.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    cursor: pointer;
  }

  /* Wallet connection card */
  .wallet-card {
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.05), rgba(139, 92, 246, 0.05));
    border: 1px solid rgba(99, 102, 241, 0.2);
    border-radius: 1rem;
    padding: 1rem;
    margin-bottom: 1rem;
  }

  .wallet-connected {
    background: linear-gradient(135deg, rgba(34, 197, 94, 0.05), rgba(16, 185, 129, 0.05));
    border-color: rgba(34, 197, 94, 0.2);
  }

  /* Buttons */
  .btn-primary {
    background: linear-gradient(135deg, #6366f1, #4f46e5);
    color: white;
    padding: 0.875rem 1.5rem;
    border-radius: 0.75rem;
    font-weight: 600;
    font-size: 0.9375rem;
    border: none;
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    transition: all 0.2s ease;
    cursor: pointer;
    touch-action: manipulation;
    min-height: 48px;
    box-shadow: 0 2px 8px rgba(99, 102, 241, 0.2);
  }

  .btn-primary:active {
    transform: translateY(1px);
    box-shadow: 0 1px 4px rgba(99, 102, 241, 0.2);
  }

  .btn-secondary {
    background: white;
    color: #4b5563;
    padding: 0.75rem 1.25rem;
    border-radius: 0.75rem;
    font-weight: 500;
    font-size: 0.875rem;
    border: 1px solid #e5e7eb;
    transition: all 0.2s ease;
    cursor: pointer;
    touch-action: manipulation;
    min-height: 44px;
  }

  .btn-secondary:active {
    background: #f9fafb;
  }

  /* AI features section */
  .ai-features {
    background: #f9fafb;
    border-radius: 0.75rem;
    padding: 0.875rem;
    margin-top: 0.75rem;
  }

  .ai-toggle {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .ai-toggle input[type="checkbox"] {
    width: 1.25rem;
    height: 1.25rem;
    cursor: pointer;
  }

  /* Suggestions pills */
  .suggestions-container {
    display: flex;
    gap: 0.5rem;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    padding: 0.75rem 0;
    scrollbar-width: none;
  }

  .suggestions-container::-webkit-scrollbar {
    display: none;
  }

  .suggestion-pill {
    padding: 0.5rem 1rem;
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 2rem;
    font-size: 0.875rem;
    color: #4b5563;
    white-space: nowrap;
    cursor: pointer;
    transition: all 0.2s ease;
    flex-shrink: 0;
  }

  .suggestion-pill:active {
    background: #f3f4f6;
    transform: scale(0.98);
  }

  /* Loading state */
  .loading-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 3rem 1rem;
    text-align: center;
  }

  .loading-spinner {
    width: 3rem;
    height: 3rem;
    border: 3px solid rgba(99, 102, 241, 0.2);
    border-top-color: #6366f1;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin-bottom: 1rem;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* Result preview */
  .result-container {
    background: white;
    border-radius: 1rem;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    overflow: hidden;
    margin-top: 1.5rem;
  }

  .result-header {
    background: linear-gradient(135deg, #f9fafb, #f3f4f6);
    padding: 1rem;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .result-content {
    padding: 1.5rem 1rem;
  }

  .result-photo {
    width: 100%;
    border-radius: 0.75rem;
    margin-bottom: 1rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  .result-actions {
    padding: 1rem;
    background: #f9fafb;
    border-top: 1px solid #e5e7eb;
    display: flex;
    gap: 0.5rem;
  }

  /* Character/word counter */
  .input-counter {
    display: flex;
    justify-content: space-between;
    padding: 0.5rem 0.75rem;
    background: #f9fafb;
    border-top: 1px solid #e5e7eb;
    font-size: 0.75rem;
    color: #6b7280;
  }

  /* Privacy indicator */
  .privacy-indicator {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0.75rem;
    background: rgba(34, 197, 94, 0.05);
    border-radius: 0.5rem;
    font-size: 0.75rem;
    color: #15803d;
    margin-bottom: 0.75rem;
  }

  /* Animations */
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @keyframes slideUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .animate-fade-in {
    animation: fadeIn 0.4s ease forwards;
  }

  .animate-slide-up {
    animation: slideUp 0.5s ease forwards;
  }

  /* Toast notifications */
  .toast {
    position: fixed;
    bottom: calc(1rem + var(--safe-area-inset-bottom));
    left: 50%;
    transform: translateX(-50%) translateY(100px);
    background: rgba(17, 24, 39, 0.95);
    color: white;
    padding: 0.875rem 1.25rem;
    border-radius: 0.5rem;
    font-size: 0.875rem;
    z-index: 50;
    transition: transform 0.3s ease;
    max-width: calc(100vw - 2rem);
  }

  .toast.show {
    transform: translateX(-50%) translateY(0);
  }

  /* Drag and drop */
  .drag-active {
    background: rgba(99, 102, 241, 0.05);
    border-color: #6366f1;
  }

  .drag-overlay {
    position: absolute;
    inset: 0;
    background: rgba(99, 102, 241, 0.1);
    border: 2px dashed #6366f1;
    border-radius: 1rem;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10;
  }

  /* Tablet and desktop */
  @media (min-width: 768px) {
    #main-content {
      max-width: 42rem;
      margin: 0 auto;
      padding: 1rem;
    }

    #journalInput {
      min-height: 300px;
      font-size: 18px !important;
      padding: 1.5rem !important;
    }

    .mobile-card {
      padding: 1.5rem;
      border-radius: 1.25rem;
    }

    .btn-primary {
      max-width: 20rem;
      margin: 0 auto;
    }

    .suggestions-container {
      flex-wrap: wrap;
      overflow-x: visible;
    }

    .result-container {
      border-radius: 1.25rem;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
    }
  }

  /* Focus states */
  *:focus-visible {
    outline: 2px solid #6366f1;
    outline-offset: 2px;
  }

  /* Animation delays */
  .delay-100 { animation-delay: 100ms; }
  .delay-200 { animation-delay: 200ms; }
  .delay-300 { animation-delay: 300ms; }
  .delay-400 { animation-delay: 400ms; }
</style>
{% endblock %}

{% block content %}
<!-- Main content -->
<div id="main-content" class="animate-fade-in">
  <!-- Header section -->
  <div class="text-center mb-4">
    <div class="inline-flex items-center gap-2 px-3 py-1.5 bg-white rounded-full text-xs font-medium text-primary-600 border border-primary-100 mb-3">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
      </svg>
      <span>{{ current_date|default:"Today" }} • Write & Earn</span>
    </div>
    
    <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 diary-font mb-2">
      Your thoughts. Encrypted. Rewarded.
    </h1>
    
    <p class="text-sm sm:text-base text-gray-600 max-w-lg mx-auto">
      Write privately, earn rewards. AI enhances your entries.
    </p>
  </div>

  <!-- Wallet Connection Status -->
  <div id="walletStatusSection" class="animate-slide-up delay-100">
    <!-- Not Connected -->
    <div id="walletNotConnected" class="wallet-card">
      <div class="flex items-start gap-3 mb-3">
        <div class="p-2 bg-white rounded-lg">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-primary-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
          </svg>
        </div>
        <div class="flex-1">
          <h3 class="font-semibold text-gray-800 text-sm">Connect Wallet for Full Features</h3>
          <p class="text-xs text-gray-600 mt-1">Enable encryption, save entries, and earn rewards for journaling.</p>
        </div>
      </div>
      
      <div class="flex gap-2">
        <button onclick="connectWallet()" class="btn-primary">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
          </svg>
          Connect Wallet
        </button>
        <button onclick="showWalletOptions()" class="btn-secondary flex-1">
          Get a Wallet
        </button>
      </div>
    </div>

    <!-- Connected -->
    <div id="walletConnected" class="wallet-card wallet-connected hidden">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-2">
          <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
          <span class="text-sm font-medium text-gray-800">Connected</span>
          <span id="connectedAddress" class="text-xs text-gray-600">0x1234...5678</span>
        </div>
        <button onclick="disconnectWallet()" class="text-xs text-gray-500">Disconnect</button>
      </div>
      <div class="flex items-center gap-4 mt-2 text-xs text-gray-600">
        <span>✓ Full encryption</span>
        <span>✓ Earning rewards</span>
        <span id="networkIndicator">✓ Base network</span>
      </div>
    </div>
  </div>

  <!-- Main Journal Form -->
  <form id="demoForm" class="animate-slide-up delay-200" enctype="multipart/form-data">
    {% csrf_token %}
    
    <div class="mobile-card">
      <!-- Privacy indicator -->
      <div class="privacy-indicator">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
        </svg>
        <span id="privacyStatus">Your entry is private. Connect wallet for encryption.</span>
      </div>

      <!-- Main input container -->
      <div id="journalContainer" class="relative">
        <!-- Drag overlay -->
        <div id="dragOverlay" class="drag-overlay hidden">
          <div class="text-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-primary-500 mx-auto mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
            <p class="text-sm font-medium text-primary-600">Drop your photo here</p>
          </div>
        </div>

        <!-- Textarea -->
        <textarea
          id="journalInput"
          name="journal_content"
          placeholder="What's on your mind today? Write about your thoughts, feelings, experiences, or anything you want to remember..."
          oninput="updateCounter()"
          aria-label="Journal content"
          autocomplete="off"
          spellcheck="true"
        ></textarea>

        <!-- Photo attachment area -->
        <div id="photoAttachmentArea" class="photo-attachment-area hidden">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd" />
          </svg>
          <div class="flex-1">
            <p class="text-sm font-medium text-gray-700">Photos attached</p>
            <div id="photoPreviewGrid" class="photo-preview-grid"></div>
          </div>
        </div>

        <!-- Character counter -->
        <div class="input-counter">
          <span><span id="charCount">0</span> characters</span>
          <span><span id="wordCount">0</span> words</span>
        </div>
      </div>

      <!-- Quick suggestions -->
      <div class="mt-3">
        <p class="text-xs text-gray-600 mb-2">Quick prompts:</p>
        <div class="suggestions-container">
          <button type="button" onclick="addSuggestion('Today I felt')" class="suggestion-pill">Today I felt</button>
          <button type="button" onclick="addSuggestion('I\'m grateful for')" class="suggestion-pill">I'm grateful for</button>
          <button type="button" onclick="addSuggestion('I accomplished')" class="suggestion-pill">I accomplished</button>
          <button type="button" onclick="addSuggestion('Something I learned')" class="suggestion-pill">Something I learned</button>
          <button type="button" onclick="addSuggestion('A moment to remember')" class="suggestion-pill">A moment to remember</button>
          <button type="button" onclick="addSuggestion('My biggest challenge was')" class="suggestion-pill">My biggest challenge</button>
        </div>
      </div>

      <!-- AI Features -->
      <div class="ai-features">
        <div class="ai-toggle">
          <input type="checkbox" id="aiEnhancement" checked>
          <label for="aiEnhancement" class="flex-1">
            <div class="font-medium text-sm text-gray-700">AI Enhancement</div>
            <div class="text-xs text-gray-500">Transform your thoughts into polished entries</div>
          </label>
        </div>
        
        <div id="aiOptions" class="mt-2 pl-8 text-xs text-gray-600">
          <div class="flex items-center gap-2">
            <span>Style:</span>
            <select id="writingStyle" class="text-xs border rounded px-2 py-1">
              <option value="reflective">Reflective</option>
              <option value="gratitude">Gratitude-focused</option>
              <option value="narrative">Story-like</option>
              <option value="concise">Brief & Clear</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Action buttons -->
      <div class="mt-4 space-y-2">
        <button type="button" id="transformBtn" onclick="generateDemo()" class="btn-primary">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
          </svg>
          Transform into Journal Entry
        </button>
        
        <div class="flex gap-2">
          <input id="photoInput" name="journal_photo" type="file" accept="image/*" multiple class="hidden" onchange="handlePhotoSelect(event)">
          <label for="photoInput" class="btn-secondary flex-1 flex items-center justify-center gap-2 cursor-pointer">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd" />
            </svg>
            Add Photos
          </label>
          <button type="button" onclick="resetForm()" class="btn-secondary flex-1">Clear</button>
        </div>
      </div>
    </div>
  </form>

  <!-- Loading State -->
  <div id="loadingIndicator" class="mobile-card hidden">
    <div class="loading-container">
      <div class="loading-spinner"></div>
      <p class="text-gray-700 font-medium">Creating your journal entry...</p>
      <p class="text-sm text-gray-500 mt-1">Using AI to enhance your writing</p>
    </div>
  </div>

  <!-- Result Preview -->
  <div id="resultPreview" class="result-container hidden animate-slide-up">
    <div class="result-header">
      <h3 class="font-semibold text-gray-800">Your Journal Entry</h3>
      <button onclick="editEntry()" class="p-2 hover:bg-gray-100 rounded-lg transition">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
          <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
        </svg>
      </button>
    </div>

    <div class="result-content">
      <div id="resultPhotos" class="hidden">
        <!-- Photos will be displayed here -->
      </div>
      
      <h2 id="entryTitle" class="text-xl font-bold text-gray-900 diary-font mb-3">
        My Journal Entry
      </h2>
      
      <div id="journalEntry" class="prose prose-gray max-w-none">
        <!-- Generated content -->
      </div>
    </div>

    <div class="result-actions">
      <button type="button" onclick="saveEntry()" id="saveBtn" class="btn-primary flex-1">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
        </svg>
        Save Entry
      </button>
      <button type="button" onclick="tryAgain()" class="btn-secondary flex-1">Try Again</button>
    </div>
  </div>

  <!-- Toast Container -->
  <div id="toastContainer"></div>
</div>

<!-- JavaScript -->
<script>
// Global variables
let currentPhotos = [];
let journalCache = {
  entries: {},
  init() {
    try {
      const stored = localStorage.getItem('diaryVaultCache');
      if (stored) {
        const data = JSON.parse(stored);
        this.entries = data.entries || {};
      }
    } catch (e) {
      console.error('Cache init error:', e);
    }
  },
  get(key) {
    return this.entries[key];
  },
  set(key, value) {
    this.entries[key] = value;
    try {
      localStorage.setItem('diaryVaultCache', JSON.stringify({ entries: this.entries }));
    } catch (e) {
      console.error('Cache save error:', e);
    }
  }
};

// Initialize
document.addEventListener('DOMContentLoaded', function() {
  journalCache.init();
  initializeForm();
  setupWalletIntegration();
  setupDragAndDrop();
  updateCounter();
});

function initializeForm() {
  const input = document.getElementById('journalInput');
  const aiToggle = document.getElementById('aiEnhancement');
  const aiOptions = document.getElementById('aiOptions');
  
  // Auto-resize textarea
  input.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = Math.min(this.scrollHeight, 500) + 'px';
  });
  
  // AI toggle
  aiToggle.addEventListener('change', function() {
    aiOptions.style.display = this.checked ? 'block' : 'none';
  });
  
  // Focus input on load
  setTimeout(() => input.focus(), 300);
}

function setupWalletIntegration() {
  window.addEventListener('walletConnectionChanged', function(event) {
    const { isConnected, address, chainId } = event.detail;
    updateWalletUI(isConnected, address, chainId);
  });
  
  // Check initial state
  setTimeout(() => {
    if (typeof getWalletInfo === 'function') {
      const info = getWalletInfo();
      updateWalletUI(info.isConnected, info.address, info.chainId);
    }
  }, 1000);
}

function updateWalletUI(isConnected, address, chainId) {
  const notConnected = document.getElementById('walletNotConnected');
  const connected = document.getElementById('walletConnected');
  const addressSpan = document.getElementById('connectedAddress');
  const privacyStatus = document.getElementById('privacyStatus');
  const networkIndicator = document.getElementById('networkIndicator');
  
  if (isConnected && address) {
    notConnected.classList.add('hidden');
    connected.classList.remove('hidden');
    addressSpan.textContent = `${address.slice(0, 6)}...${address.slice(-4)}`;
    privacyStatus.textContent = 'Your entry is fully encrypted and earning rewards.';
    
    if (chainId !== 8453) {
      networkIndicator.textContent = '⚠️ Switch to Base network';
      networkIndicator.className = 'text-amber-600';
    }
  } else {
    notConnected.classList.remove('hidden');
    connected.classList.add('hidden');
    privacyStatus.textContent = 'Your entry is private. Connect wallet for encryption.';
  }
}

function setupDragAndDrop() {
  const container = document.getElementById('journalContainer');
  const overlay = document.getElementById('dragOverlay');
  
  ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    container.addEventListener(eventName, preventDefaults, false);
  });
  
  function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
  }
  
  container.addEventListener('dragenter', function() {
    container.classList.add('drag-active');
    overlay.classList.remove('hidden');
  });
  
  container.addEventListener('dragleave', function(e) {
    if (e.target === container) {
      container.classList.remove('drag-active');
      overlay.classList.add('hidden');
    }
  });
  
  container.addEventListener('drop', function(e) {
    container.classList.remove('drag-active');
    overlay.classList.add('hidden');
    
    const files = Array.from(e.dataTransfer.files);
    handlePhotoFiles(files.filter(f => f.type.startsWith('image/')));
  });
}

function updateCounter() {
  const input = document.getElementById('journalInput');
  const charCount = document.getElementById('charCount');
  const wordCount = document.getElementById('wordCount');
  const transformBtn = document.getElementById('transformBtn');
  
  const text = input.value.trim();
  const chars = text.length;
  const words = text ? text.split(/\s+/).length : 0;
  
  charCount.textContent = chars;
  wordCount.textContent = words;
  
  // Enable/disable transform button
  transformBtn.disabled = words < 5;
  transformBtn.style.opacity = words < 5 ? '0.6' : '1';
}

function addSuggestion(text) {
  const input = document.getElementById('journalInput');
  const current = input.value;
  
  if (current && !current.endsWith(' ')) {
    input.value = current + ' ' + text + ' ';
  } else {
    input.value = current + text + ' ';
  }
  
  input.focus();
  updateCounter();
  input.dispatchEvent(new Event('input'));
}

function handlePhotoSelect(event) {
  const files = Array.from(event.target.files);
  handlePhotoFiles(files);
}

function handlePhotoFiles(files) {
  const validFiles = files.filter(file => {
    if (file.size > 5 * 1024 * 1024) {
      showToast('Image must be smaller than 5MB', 'error');
      return false;
    }
    return true;
  });
  
  validFiles.forEach(file => {
    const reader = new FileReader();
    reader.onload = function(e) {
      currentPhotos.push({
        file: file,
        url: e.target.result,
        name: file.name
      });
      updatePhotoDisplay();
    };
    reader.readAsDataURL(file);
  });
}

function updatePhotoDisplay() {
  const area = document.getElementById('photoAttachmentArea');
  const grid = document.getElementById('photoPreviewGrid');
  
  if (currentPhotos.length > 0) {
    area.classList.remove('hidden');
    grid.innerHTML = currentPhotos.map((photo, index) => `
      <div class="photo-thumbnail">
        <img src="${photo.url}" alt="${photo.name}">
        <button type="button" onclick="removePhoto(${index})" class="photo-remove">×</button>
      </div>
    `).join('');
  } else {
    area.classList.add('hidden');
  }
}

function removePhoto(index) {
  currentPhotos.splice(index, 1);
  updatePhotoDisplay();
}

function generateDemo() {
  const input = document.getElementById('journalInput');
  const content = input.value.trim();
  
  if (content.split(/\s+/).length < 5) return;
  
  // Check cache
  const cacheKey = content + (currentPhotos.length > 0 ? '_photos' : '');
  const cached = journalCache.get(cacheKey);
  if (cached && currentPhotos.length === 0) {
    displayResult(cached);
    return;
  }
  
  // Show loading
  document.getElementById('loadingIndicator').classList.remove('hidden');
  document.getElementById('demoForm').style.display = 'none';
  
  // Prepare form data
  const formData = new FormData();
  formData.append('journal_content', content);
  formData.append('csrfmiddlewaretoken', getCsrfToken());
  
  if (document.getElementById('aiEnhancement').checked) {
    formData.append('personalize', 'true');
    formData.append('writing_style', document.getElementById('writingStyle').value);
  }
  
  // Add photos
  currentPhotos.forEach((photo, index) => {
    formData.append(`photo_${index}`, photo.file);
  });
  
  // Add wallet info if connected
  if (typeof getWalletInfo === 'function') {
    const wallet = getWalletInfo();
    if (wallet.isConnected) {
      formData.append('wallet_address', wallet.address);
      formData.append('encrypted', 'true');
    }
  }
  
  // Make request
  fetch('/api/demo-journal/', {
    method: 'POST',
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    document.getElementById('loadingIndicator').classList.add('hidden');
    
    if (data.error) {
      showToast(data.error, 'error');
      document.getElementById('demoForm').style.display = 'block';
      return;
    }
    
    // Cache result
    journalCache.set(cacheKey, data);
    displayResult(data);
  })
  .catch(error => {
    document.getElementById('loadingIndicator').classList.add('hidden');
    document.getElementById('demoForm').style.display = 'block';
    showToast('Failed to generate entry. Please try again.', 'error');
  });
}

function displayResult(data) {
  document.getElementById('demoForm').style.display = 'none';
  
  const preview = document.getElementById('resultPreview');
  const entryDiv = document.getElementById('journalEntry');
  const titleDiv = document.getElementById('entryTitle');
  const photosDiv = document.getElementById('resultPhotos');
  
  // Set content
  entryDiv.innerHTML = data.entry.replace(/\n/g, '<br>');
  titleDiv.textContent = data.title || 'My Journal Entry';
  
  // Display photos
  if (currentPhotos.length > 0) {
    photosDiv.innerHTML = currentPhotos.map(photo => 
      `<img src="${photo.url}" alt="${photo.name}" class="result-photo">`
    ).join('');
    photosDiv.classList.remove('hidden');
  } else {
    photosDiv.classList.add('hidden');
  }
  
  preview.classList.remove('hidden');
  preview.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function editEntry() {
  const entry = document.getElementById('journalEntry');
  const input = document.getElementById('journalInput');
  
  input.value = entry.innerText;
  
  document.getElementById('resultPreview').classList.add('hidden');
  document.getElementById('demoForm').style.display = 'block';
  
  input.focus();
  updateCounter();
  input.dispatchEvent(new Event('input'));
}

function tryAgain() {
  document.getElementById('resultPreview').classList.add('hidden');
  document.getElementById('demoForm').style.display = 'block';
  document.getElementById('journalInput').focus();
}

function saveEntry() {
  const wallet = typeof getWalletInfo === 'function' ? getWalletInfo() : { isConnected: false };
  
  if (!wallet.isConnected) {
    if (confirm('Connect your wallet to save and earn rewards. Continue?')) {
      connectWallet();
    }
    return;
  }
  
  const btn = document.getElementById('saveBtn');
  btn.disabled = true;
  btn.innerHTML = '<svg class="animate-spin h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg>Saving...';
  
  // Prepare save data
  const formData = new FormData();
  formData.append('title', document.getElementById('entryTitle').textContent);
  formData.append('content', document.getElementById('journalEntry').innerText);
  formData.append('wallet_address', wallet.address);
  formData.append('csrfmiddlewaretoken', getCsrfToken());
  
  currentPhotos.forEach((photo, index) => {
    formData.append(`photo_${index}`, photo.file);
  });
  
  fetch('/save-generated-entry/', {
    method: 'POST',
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showToast(`Entry saved! Earned ${data.rewards || 10} tokens`, 'success');
      setTimeout(() => {
        window.location.href = data.redirect_url || '/dashboard/';
      }, 1500);
    } else {
      throw new Error(data.error || 'Save failed');
    }
  })
  .catch(error => {
    btn.disabled = false;
    btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>Save Entry';
    showToast(error.message || 'Failed to save. Please try again.', 'error');
  });
}

function resetForm() {
  if (confirm('Clear all content and start over?')) {
    document.getElementById('journalInput').value = '';
    currentPhotos = [];
    updatePhotoDisplay();
    updateCounter();
    document.getElementById('journalInput').focus();
  }
}

function showToast(message, type = 'info') {
  const container = document.getElementById('toastContainer');
  const toast = document.createElement('div');
  toast.className = 'toast';
  toast.textContent = message;
  
  if (type === 'error') {
    toast.style.background = 'rgba(239, 68, 68, 0.95)';
  } else if (type === 'success') {
    toast.style.background = 'rgba(34, 197, 94, 0.95)';
  }
  
  container.appendChild(toast);
  
  setTimeout(() => toast.classList.add('show'), 10);
  setTimeout(() => {
    toast.classList.remove('show');
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

function getCsrfToken() {
  return document.querySelector('[name=csrfmiddlewaretoken]').value;
}
</script>

{% endblock %}