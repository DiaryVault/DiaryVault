{% extends "base.html" %}
{% load static %}

{% block title %}Smart Journal Compiler - DiaryVault{% endblock %}

{% block extra_css %}
<style>
    .glass-card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .btn-primary {
        background: linear-gradient(135deg, #6366f1, #4f46e5);
        color: white;
        border: none;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(99, 102, 241, 0.3);
    }

    .btn-primary:disabled {
        opacity: 0.6;
        transform: none;
        cursor: not-allowed;
    }

    .btn-secondary {
        background: #f8fafc;
        color: #475569;
        border: 1px solid #e2e8f0;
        font-weight: 500;
        transition: all 0.3s ease;
    }

    .btn-secondary:hover {
        background: #f1f5f9;
        border-color: #cbd5e1;
    }

    /* Enhanced Mobile-First Step Indicator */
    .step-container {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        padding: 1rem;
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(10px);
        border-radius: 1rem;
        margin-bottom: 1rem;
        overflow-x: auto;
        scrollbar-width: none;
        -ms-overflow-style: none;
    }

    .step-container::-webkit-scrollbar {
        display: none;
    }

    .step-indicator {
        width: 2rem;
        height: 2rem;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 0.875rem;
        transition: all 0.3s ease;
        flex-shrink: 0;
        position: relative;
    }

    .step-indicator.completed {
        background: #10b981;
        color: white;
    }

    .step-indicator.active {
        background: #6366f1;
        color: white;
        animation: pulse 2s infinite;
    }

    .step-indicator.pending {
        background: #e5e7eb;
        color: #6b7280;
    }

    .step-line {
        height: 2px;
        background: #e5e7eb;
        width: 1rem;
        flex-shrink: 0;
    }

    .step-line.completed {
        background: #10b981;
    }

    /* Mobile-Optimized Step Labels */
    .step-label {
        font-size: 0.625rem;
        font-weight: 500;
        text-align: center;
        margin-top: 0.25rem;
        color: #6b7280;
        line-height: 1.2;
    }

    .step-label.active {
        color: #6366f1;
        font-weight: 600;
    }

    /* Mobile-Optimized Method Cards */
    .method-card {
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border: 2px solid transparent;
        padding: 1rem;
        text-align: center;
    }

    .method-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 20px rgba(0, 0, 0, 0.1);
    }

    .method-card.selected {
        border-color: #6366f1;
        background: linear-gradient(135deg, rgba(99, 102, 241, 0.05), rgba(79, 70, 229, 0.02));
    }

    /* Mobile-Optimized Entry Cards */
    .entry-card {
        transition: all 0.2s ease;
        cursor: pointer;
        border: 2px solid transparent;
        padding: 0.75rem;
    }

    .entry-card:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .entry-card.selected {
        border-color: #10b981;
        background: rgba(16, 185, 129, 0.05);
    }

    /* Mobile-Optimized Journal Cards */
    .journal-card {
        transition: all 0.3s ease;
        border: 1px solid #e5e7eb;
        padding: 1rem;
    }

    .journal-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        border-color: #cbd5e1;
    }

    /* Enhanced Mobile Loading Overlay */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        padding: 1rem;
    }

    .loading-spinner {
        background: white;
        padding: 1.5rem;
        border-radius: 1rem;
        text-align: center;
        max-width: 300px;
        width: 100%;
        margin: 0 auto;
    }

    /* Mobile-Optimized Modal */
    .mobile-modal {
        background: white;
        border-radius: 1rem;
        padding: 1rem;
        max-width: 95vw;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
        margin: 1rem;
    }

    .fade-in {
        animation: fadeIn 0.5s ease-out;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.8; }
    }

    .gradient-text {
        background: linear-gradient(135deg, #6366f1, #4f46e5);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    /* Utility Colors */
    .primary-600 { color: #4f46e5; }
    .secondary-600 { color: #475569; }
    .secondary-800 { color: #1e293b; }
    .success-600 { color: #059669; }
    .warning-600 { color: #d97706; }
    .error-600 { color: #dc2626; }

    /* Mobile-Specific Responsive Improvements */
    @media (max-width: 768px) {
        .container-mobile {
            padding-left: 0.75rem;
            padding-right: 0.75rem;
        }

        .glass-card {
            border-radius: 1rem;
            margin-bottom: 1rem;
        }

        .method-card {
            padding: 0.75rem;
        }

        .method-card .icon-container {
            width: 3rem;
            height: 3rem;
            margin-bottom: 0.75rem;
        }

        .method-card .icon-container svg {
            width: 1.5rem;
            height: 1.5rem;
        }

        .method-card h3 {
            font-size: 1rem;
            margin-bottom: 0.5rem;
        }

        .method-card p {
            font-size: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .entry-card {
            padding: 0.5rem;
        }

        .journal-card {
            padding: 0.75rem;
        }

        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
        }

        .stats-card {
            padding: 0.75rem;
            text-align: center;
        }

        .stats-value {
            font-size: 1.5rem;
            font-weight: 700;
            line-height: 1.2;
        }

        .stats-label {
            font-size: 0.625rem;
            margin-top: 0.25rem;
        }

        /* Mobile Form Improvements */
        .form-input {
            font-size: 16px; /* Prevents zoom on iOS */
            padding: 0.75rem;
        }

        .form-textarea {
            font-size: 16px;
            padding: 0.75rem;
            min-height: 6rem;
        }

        /* Mobile Button Improvements */
        .btn-mobile {
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
            border-radius: 0.75rem;
            min-height: 44px; /* Touch target size */
        }

        .btn-mobile-full {
            width: 100%;
            margin-bottom: 0.5rem;
        }

        /* Mobile Navigation Improvements */
        .mobile-nav-buttons {
            position: sticky;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 0.75rem;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            margin: 0 -0.75rem -0.75rem -0.75rem;
            border-radius: 0 0 1rem 1rem;
        }

        /* Mobile Checkbox and Radio Improvements */
        .mobile-checkbox {
            transform: scale(1.2);
            margin-right: 0.75rem;
        }

        .mobile-radio {
            transform: scale(1.2);
            margin-right: 0.75rem;
        }

        /* Mobile Grid Improvements */
        .mobile-grid {
            grid-template-columns: 1fr;
            gap: 0.75rem;
        }

        .mobile-grid-2 {
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
        }

        /* Mobile Text Sizing */
        .mobile-title {
            font-size: 1.5rem;
            line-height: 1.3;
            margin-bottom: 0.5rem;
        }

        .mobile-subtitle {
            font-size: 0.875rem;
            line-height: 1.4;
            margin-bottom: 1rem;
        }

        .mobile-text {
            font-size: 0.75rem;
            line-height: 1.4;
        }

        /* Hide desktop-only elements */
        .desktop-only {
            display: none;
        }
    }

    /* Tablet Specific */
    @media (min-width: 769px) and (max-width: 1024px) {
        .tablet-grid-2 {
            grid-template-columns: repeat(2, 1fr);
        }

        .tablet-grid-3 {
            grid-template-columns: repeat(3, 1fr);
        }
    }

    /* Desktop Specific */
    @media (min-width: 1025px) {
        .mobile-only {
            display: none;
        }
    }

    /* Improved Touch Targets */
    @media (hover: none) and (pointer: coarse) {
        .method-card,
        .entry-card,
        .journal-card,
        button,
        .btn-primary,
        .btn-secondary {
            min-height: 44px;
            min-width: 44px;
        }

        .entry-checkbox,
        .mobile-checkbox,
        .mobile-radio {
            min-height: 44px;
            min-width: 44px;
        }
    }

    /* Dark mode support for mobile */
    @media (prefers-color-scheme: dark) {
        .glass-card {
            background: rgba(30, 41, 59, 0.9);
            border-color: rgba(148, 163, 184, 0.2);
        }

        .loading-spinner {
            background: rgba(30, 41, 59, 0.95);
            color: white;
        }

        .mobile-modal {
            background: rgba(30, 41, 59, 0.95);
            color: white;
        }
    }

    /* Accessibility improvements */
    @media (prefers-reduced-motion: reduce) {
        .method-card,
        .entry-card,
        .journal-card,
        .step-indicator {
            animation: none;
            transition: none;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto container-mobile py-4 space-y-4">
    <!-- Mobile-Optimized Header -->
    <div class="glass-card rounded-2xl p-4 md:p-8">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-4 md:mb-6">
            <div class="mb-4 md:mb-0">
                <h1 class="text-2xl md:text-4xl font-bold gradient-text mobile-title">Smart Journal Compiler</h1>
                <p class="text-sm md:text-lg text-secondary-600 mt-1 md:mt-2 mobile-subtitle">Transform your journal entries into publishable content</p>
            </div>

            <!-- Mobile-Optimized Progress Steps -->
            <div class="step-container">
                <div class="flex flex-col items-center">
                    <div class="step-indicator active" id="step1">1</div>
                    <div class="step-label active">Method</div>
                </div>
                <div class="step-line" id="line1"></div>
                <div class="flex flex-col items-center">
                    <div class="step-indicator pending" id="step2">2</div>
                    <div class="step-label">Select</div>
                </div>
                <div class="step-line" id="line2"></div>
                <div class="flex flex-col items-center">
                    <div class="step-indicator pending" id="step3">3</div>
                    <div class="step-label">Analyze</div>
                </div>
                <div class="step-line" id="line3"></div>
                <div class="flex flex-col items-center">
                    <div class="step-indicator pending" id="step4">4</div>
                    <div class="step-label">Publish</div>
                </div>
            </div>
        </div>

        <!-- Mobile-Optimized Stats Overview -->
        <div class="stats-grid grid grid-cols-2 md:grid-cols-4 gap-2 md:gap-4">
            <div class="stats-card text-center p-3 md:p-4 bg-white rounded-xl md:rounded-2xl">
                <div class="stats-value text-xl md:text-3xl font-bold text-primary-600">{{ analysis.total_entries|default:0 }}</div>
                <div class="stats-label text-xs md:text-sm text-secondary-600">Total Entries</div>
            </div>
            <div class="stats-card text-center p-3 md:p-4 bg-white rounded-xl md:rounded-2xl">
                <div class="stats-value text-xl md:text-3xl font-bold text-success-600">{{ analysis.themes|length|default:0 }}</div>
                <div class="stats-label text-xs md:text-sm text-secondary-600">Themes</div>
            </div>
            <div class="stats-card text-center p-3 md:p-4 bg-white rounded-xl md:rounded-2xl">
                <div class="stats-value text-xl md:text-3xl font-bold text-warning-600">{{ analysis.quality_score.score|default:0 }}%</div>
                <div class="stats-label text-xs md:text-sm text-secondary-600">Quality Score</div>
            </div>
            <div class="stats-card text-center p-3 md:p-4 bg-white rounded-xl md:rounded-2xl">
                <div class="stats-value text-xl md:text-3xl font-bold text-error-600">{{ analysis.story_arcs|length|default:0 }}</div>
                <div class="stats-label text-xs md:text-sm text-secondary-600">Story Arcs</div>
            </div>
        </div>
    </div>

    <!-- Recent Compiled Journals -->
    <div class="glass-card rounded-2xl p-4 md:p-6">
        <div class="flex items-center justify-between mb-4 md:mb-6">
            <h2 class="text-lg md:text-2xl font-bold text-secondary-800">Your Compiled Journals</h2>
            {% if compiled_journals %}
            <span class="text-xs md:text-sm text-secondary-600">{{ compiled_journals|length }} journal{{ compiled_journals|length|pluralize }}</span>
            {% endif %}
        </div>

        {% if compiled_journals %}
        <div class="grid mobile-grid md:grid-cols-2 lg:grid-cols-3 gap-3 md:gap-6">
            {% for journal in compiled_journals %}
            <div class="journal-card bg-white rounded-xl">
                <div class="flex items-start justify-between mb-2 md:mb-3">
                    <h3 class="font-bold text-secondary-800 text-sm md:text-lg leading-tight flex-1 mr-2 md:mr-3">{{ journal.title }}</h3>
                    <div class="flex items-center space-x-1">
                        {% if journal.is_published %}
                        <span class="inline-flex items-center px-2 py-1 bg-green-100 text-green-800 text-xs font-medium rounded-full">
                            <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                            </svg>
                            Published
                        </span>
                        {% else %}
                        <span class="inline-flex items-center px-2 py-1 bg-yellow-100 text-yellow-800 text-xs font-medium rounded-full">
                            <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                            </svg>
                            Draft
                        </span>
                        {% endif %}
                    </div>
                </div>

                <p class="text-xs md:text-sm text-secondary-600 mb-3 md:mb-4 line-clamp-3">{{ journal.description|truncatechars:120 }}</p>

                <div class="flex justify-between items-center text-xs md:text-sm mb-3 md:mb-4">
                    <div class="flex flex-col md:flex-row md:items-center md:space-x-4 space-y-1 md:space-y-0">
                        <span class="text-secondary-500">
                            <svg class="w-3 h-3 md:w-4 md:h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                            {{ journal.date_published|date:"M d, Y"|default:journal.created_at|date:"M d, Y" }}
                        </span>
                        <span class="text-secondary-500">
                            {% if journal.entries.count > 0 %}
                                {{ journal.entries.count }} entries
                            {% elif journal.entry_count_cached > 0 %}
                                {{ journal.entry_count_cached }} entries
                            {% else %}
                                Draft journal
                            {% endif %}
                        </span>
                    </div>
                    {% if journal.price %}
                    <span class="font-bold text-success-600">${{ journal.price }}</span>
                    {% else %}
                    <span class="text-secondary-500">Free</span>
                    {% endif %}
                </div>

                <div class="flex flex-col md:flex-row items-stretch md:items-center space-y-2 md:space-y-0 md:space-x-2">
                    {% if journal.is_published %}
                    <a href="/marketplace/journal/{{ journal.id }}/" class="btn-primary btn-mobile btn-mobile-full md:flex-1 text-center rounded-lg">
                        View in Marketplace
                    </a>
                    {% else %}
                    <a href="/diary/journal/{{ journal.id }}/edit/" class="btn-secondary btn-mobile btn-mobile-full md:flex-1 text-center rounded-lg">
                        Continue Editing
                    </a>
                    {% endif %}
                    <button class="desktop-only text-secondary-500 hover:text-secondary-700 p-2" title="More options">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"></path>
                        </svg>
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>

        {% if compiled_journals|length > 6 %}
        <div class="text-center mt-4 md:mt-6">
            <a href="/diary/journals/" class="btn-secondary btn-mobile px-6 py-2 rounded-lg">
                View All Journals
            </a>
        </div>
        {% endif %}

        {% else %}
        <div class="text-center py-8 md:py-12">
            <div class="w-12 h-12 md:w-16 md:h-16 bg-gradient-to-br from-blue-100 to-purple-100 rounded-xl md:rounded-2xl flex items-center justify-center mx-auto mb-3 md:mb-4">
                <svg class="w-6 h-6 md:w-8 md:h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                </svg>
            </div>
            <h3 class="text-base md:text-lg font-medium text-secondary-800 mb-2">No journals yet</h3>
            <p class="text-sm md:text-base text-secondary-600 mb-4 md:mb-6">Create your first compiled journal using the steps below!</p>
        </div>
        {% endif %}
    </div>

    <!-- Step 1: Method Selection -->
    <div id="step1Content" class="glass-card rounded-2xl p-4 md:p-8">
        <h2 class="text-lg md:text-2xl font-bold text-secondary-800 mb-4 md:mb-6">Choose Your Compilation Method</h2>

        <div class="grid mobile-grid md:grid-cols-3 gap-4 md:gap-6">
            <div class="method-card glass-card rounded-xl md:rounded-2xl" data-method="ai">
                <div class="text-center">
                    <div class="icon-container w-12 h-12 md:w-16 md:h-16 bg-gradient-to-br from-blue-500 to-purple-600 rounded-xl md:rounded-2xl flex items-center justify-center mx-auto mb-3 md:mb-4">
                        <svg class="w-6 h-6 md:w-8 md:h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                        </svg>
                    </div>
                    <h3 class="text-lg md:text-xl font-bold mb-2">AI Smart Compilation</h3>
                    <p class="text-secondary-600 text-sm mb-3 md:mb-4">Let AI analyze your entries and create the optimal structure</p>
                    <div class="space-y-1">
                        <span class="inline-block px-2 md:px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-xs">Theme Detection</span>
                        <span class="inline-block px-2 md:px-3 py-1 bg-purple-100 text-purple-800 rounded-full text-xs">Story Arcs</span>
                    </div>
                </div>
            </div>

            <div class="method-card glass-card rounded-xl md:rounded-2xl" data-method="thematic">
                <div class="text-center">
                    <div class="icon-container w-12 h-12 md:w-16 md:h-16 bg-gradient-to-br from-green-500 to-teal-600 rounded-xl md:rounded-2xl flex items-center justify-center mx-auto mb-3 md:mb-4">
                        <svg class="w-6 h-6 md:w-8 md:h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"></path>
                        </svg>
                    </div>
                    <h3 class="text-lg md:text-xl font-bold mb-2">Thematic Collection</h3>
                    <p class="text-secondary-600 text-sm mb-3 md:mb-4">Organize entries around specific themes and topics</p>
                    <div class="space-y-1">
                        <span class="inline-block px-2 md:px-3 py-1 bg-green-100 text-green-800 rounded-full text-xs">Travel</span>
                        <span class="inline-block px-2 md:px-3 py-1 bg-teal-100 text-teal-800 rounded-full text-xs">Growth</span>
                    </div>
                </div>
            </div>

            <div class="method-card glass-card rounded-xl md:rounded-2xl" data-method="chronological">
                <div class="text-center">
                    <div class="icon-container w-12 h-12 md:w-16 md:h-16 bg-gradient-to-br from-orange-500 to-red-600 rounded-xl md:rounded-2xl flex items-center justify-center mx-auto mb-3 md:mb-4">
                        <svg class="w-6 h-6 md:w-8 md:h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                    </div>
                    <h3 class="text-lg md:text-xl font-bold mb-2">Timeline Journey</h3>
                    <p class="text-secondary-600 text-sm mb-3 md:mb-4">Create a chronological narrative of your experiences</p>
                    <div class="space-y-1">
                        <span class="inline-block px-2 md:px-3 py-1 bg-orange-100 text-orange-800 rounded-full text-xs">Timeline</span>
                        <span class="inline-block px-2 md:px-3 py-1 bg-red-100 text-red-800 rounded-full text-xs">Journey</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Step 2: Entry Selection -->
    <div id="step2Content" class="glass-card rounded-2xl p-4 md:p-8 hidden">
        <div class="flex flex-col md:flex-row md:justify-between md:items-center mb-4 md:mb-6 space-y-2 md:space-y-0">
            <h2 class="text-lg md:text-2xl font-bold text-secondary-800">Select Entries</h2>
            <div class="flex flex-col md:flex-row md:items-center space-y-2 md:space-y-0 md:space-x-4">
                <span class="text-sm text-secondary-600">Selected: <span id="selectedCount">0</span></span>
                <div class="flex space-x-2">
                    <button id="selectAllBtn" class="btn-secondary btn-mobile px-3 py-1 text-sm rounded-lg">All</button>
                    <button id="selectNoneBtn" class="btn-secondary btn-mobile px-3 py-1 text-sm rounded-lg">None</button>
                </div>
            </div>
        </div>

        <div id="entriesGrid" class="grid mobile-grid md:grid-cols-2 lg:grid-cols-3 gap-3 md:gap-4 mb-4 md:mb-6">
            {% for entry in entries %}
            <div class="entry-card glass-card rounded-lg md:rounded-xl" data-entry-id="{{ entry.id }}">
                <div class="flex items-start space-x-2 md:space-x-3">
                    <input type="checkbox" class="entry-checkbox mobile-checkbox mt-1" value="{{ entry.id }}">
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="font-medium text-secondary-800 flex-1 mr-2 entry-title text-sm md:text-base truncate" data-original="{{ entry.title }}">{{ entry.title|truncatechars:40 }}</h4>
                            <button class="edit-entry-btn text-blue-600 hover:text-blue-800 text-sm flex-shrink-0" data-entry-id="{{ entry.id }}" title="Edit entry">
                                <svg class="w-3 h-3 md:w-4 md:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                </svg>
                            </button>
                        </div>
                        <p class="text-xs md:text-sm text-secondary-600 mb-2 entry-content line-clamp-2" data-original="{{ entry.content }}">{{ entry.content|truncatechars:80 }}</p>
                        <div class="flex justify-between text-xs text-secondary-500 mb-2">
                            <span>{{ entry.created_at|date:"M d, Y" }}</span>
                            <span class="word-count">{{ entry.content|wordcount }} words</span>
                        </div>
                        {% if entry.tags.exists %}
                        <div class="flex flex-wrap gap-1 mt-2">
                            {% for tag in entry.tags.all|slice:":2" %}
                            <span class="px-1.5 md:px-2 py-0.5 md:py-1 bg-blue-100 text-blue-800 rounded text-xs">{{ tag.name }}</span>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <div class="mobile-nav-buttons">
            <div class="flex flex-col md:flex-row justify-between items-center space-y-2 md:space-y-0">
                <div class="text-sm text-secondary-600">
                    Estimated: <span id="totalWords">0</span> words
                </div>
                <button id="analyzeBtn" class="btn-primary btn-mobile btn-mobile-full md:w-auto px-6 py-3 rounded-xl" disabled>
                    Analyze Selected Entries
                </button>
            </div>
        </div>
    </div>

    <!-- Step 3: Analysis Results -->
    <div id="step3Content" class="glass-card rounded-2xl p-4 md:p-8 hidden">
        <h2 class="text-lg md:text-2xl font-bold text-secondary-800 mb-4 md:mb-6">Analysis Results</h2>
        <div id="analysisResults">
            <div class="text-center py-6 md:py-8">
                <div class="text-secondary-600">Analysis results will appear here...</div>
            </div>
        </div>
        <div class="mobile-nav-buttons">
            <button id="generateStructureBtn" class="btn-primary btn-mobile btn-mobile-full px-6 py-3 rounded-xl" disabled>
                Generate Journal Structure
            </button>
        </div>
    </div>

    <!-- Step 4: Structure & Publishing -->
    <div id="step4Content" class="glass-card rounded-2xl p-4 md:p-8 hidden">
        <h2 class="text-lg md:text-2xl font-bold text-secondary-800 mb-4 md:mb-6">Journal Structure & Publishing</h2>

        <div class="grid mobile-grid lg:grid-cols-2 gap-4 md:gap-8">
            <!-- Structure Preview -->
            <div>
                <h3 class="font-bold text-secondary-800 mb-4">Generated Structure</h3>
                <div id="structurePreview" class="space-y-4">
                    <div class="text-center py-6 md:py-8 text-secondary-600">
                        Structure will appear here...
                    </div>
                </div>
            </div>

            <!-- Publishing Form -->
            <div>
                <h3 class="font-bold text-secondary-800 mb-4">Publishing Details</h3>
                <form id="publishForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-secondary-700 mb-2">Title</label>
                        <input type="text" id="journalTitle" required
                               class="form-input w-full px-3 md:px-4 py-2 md:py-3 border border-gray-300 rounded-lg md:rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                               placeholder="Enter journal title...">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-secondary-700 mb-2">Description</label>
                        <textarea id="journalDescription" rows="4" required
                                  class="form-textarea w-full px-3 md:px-4 py-2 md:py-3 border border-gray-300 rounded-lg md:rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none"
                                  placeholder="Describe your journal..."></textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-secondary-700 mb-2">Price ($)</label>
                        <input type="number" id="journalPrice" step="0.01" min="0"
                               class="form-input w-full px-3 md:px-4 py-2 md:py-3 border border-gray-300 rounded-lg md:rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                               placeholder="9.99">
                    </div>

                    <div class="space-y-3">
                        <h4 class="font-medium text-secondary-700">Journal Type</h4>
                        <div class="space-y-2">
                            <label class="flex items-center">
                                <input type="radio" name="journalType" value="growth" class="mobile-radio mr-2" checked>
                                <span class="text-sm">Personal Growth</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="journalType" value="travel" class="mobile-radio mr-2">
                                <span class="text-sm">Travel & Adventures</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="journalType" value="career" class="mobile-radio mr-2">
                                <span class="text-sm">Career Journey</span>
                            </label>
                        </div>
                    </div>

                    <div class="pt-4">
                        <button type="submit" id="publishBtn" class="btn-primary btn-mobile btn-mobile-full py-3 rounded-xl text-lg font-semibold">
                            Publish Journal
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced Mobile Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay">
    <div class="loading-spinner">
        <div class="animate-spin rounded-full h-8 w-8 md:h-12 md:w-12 border-b-2 border-blue-600 mx-auto mb-3 md:mb-4"></div>
        <div id="loadingText" class="text-secondary-800 font-medium text-sm md:text-base">Processing...</div>
        <div class="text-xs md:text-sm text-secondary-600 mt-2">This may take a moment</div>
    </div>
</div>

<!-- Mobile-Optimized Edit Entry Modal -->
<div id="editModal" class="loading-overlay" style="display: none;">
    <div class="mobile-modal">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg md:text-xl font-bold text-secondary-800">Edit Entry</h3>
            <button id="closeEditModal" class="text-gray-400 hover:text-gray-600 p-1">
                <svg class="w-5 h-5 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>

        <form id="editEntryForm" class="space-y-4">
            <input type="hidden" id="editEntryId">
            <div>
                <label class="block text-sm font-medium text-secondary-700 mb-2">Title</label>
                <input type="text" id="editEntryTitle" required
                       class="form-input w-full px-3 md:px-4 py-2 md:py-3 border border-gray-300 rounded-lg md:rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>

            <div>
                <label class="block text-sm font-medium text-secondary-700 mb-2">Content</label>
                <textarea id="editEntryContent" rows="6" required
                          class="form-textarea w-full px-3 md:px-4 py-2 md:py-3 border border-gray-300 rounded-lg md:rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none"></textarea>
            </div>

            <div class="flex flex-col md:flex-row justify-end space-y-2 md:space-y-0 md:space-x-3 pt-4">
                <button type="button" id="cancelEdit" class="btn-secondary btn-mobile px-4 py-2 rounded-lg">Cancel</button>
                <button type="submit" class="btn-primary btn-mobile px-6 py-2 rounded-lg">Save Changes</button>
            </div>
        </form>
    </div>
</div>

<!-- Success Modal -->
<div id="successModal" class="loading-overlay" style="display: none;">
    <div class="loading-spinner">
        <div class="text-4xl md:text-6xl text-green-500 mb-3 md:mb-4">✓</div>
        <div class="text-secondary-800 font-medium text-lg md:text-xl mb-2">Journal Published!</div>
        <div class="text-xs md:text-sm text-secondary-600 mb-3 md:mb-4">Your journal has been successfully published to the marketplace.</div>
        <button id="viewJournalBtn" class="btn-primary btn-mobile px-6 py-2 rounded-lg">View Journal</button>
    </div>
</div>

{% csrf_token %}
{% endblock %}

{% block extra_js %}
<script>
class SmartJournalCompiler {
    constructor() {
        this.selectedMethod = null;
        this.selectedEntries = new Set();
        this.currentStep = 1;
        this.analysisData = null;
        this.structureData = null;

        this.init();
    }

    init() {
        this.bindEvents();
        this.updateStepDisplay();
        this.setupMobileOptimizations();
    }

    setupMobileOptimizations() {
        // Prevent zoom on iOS inputs
        const inputs = document.querySelectorAll('input[type="text"], input[type="number"], textarea');
        inputs.forEach(input => {
            input.addEventListener('focus', () => {
                if (window.innerWidth < 768) {
                    input.style.fontSize = '16px';
                }
            });
            input.addEventListener('blur', () => {
                input.style.fontSize = '';
            });
        });

        // Enhanced touch feedback
        const cards = document.querySelectorAll('.method-card, .entry-card, .journal-card');
        cards.forEach(card => {
            card.addEventListener('touchstart', () => {
                card.style.transform = 'scale(0.98)';
            }, { passive: true });

            card.addEventListener('touchend', () => {
                card.style.transform = '';
            }, { passive: true });
        });

        // Optimize scrolling for mobile
        const scrollableElements = document.querySelectorAll('.step-container');
        scrollableElements.forEach(element => {
            element.style.webkitOverflowScrolling = 'touch';
        });
    }

    bindEvents() {
        // Method selection
        document.querySelectorAll('.method-card').forEach(card => {
            card.addEventListener('click', (e) => this.selectMethod(e));
        });

        // Entry selection
        document.querySelectorAll('.entry-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', (e) => this.updateSelectedEntries());
        });

        // Entry editing
        document.querySelectorAll('.edit-entry-btn').forEach(btn => {
            btn.addEventListener('click', (e) => this.openEditModal(e));
        });

        document.getElementById('selectAllBtn')?.addEventListener('click', () => this.selectAllEntries());
        document.getElementById('selectNoneBtn')?.addEventListener('click', () => this.selectNoneEntries());

        // Edit modal events
        document.getElementById('closeEditModal')?.addEventListener('click', () => this.closeEditModal());
        document.getElementById('cancelEdit')?.addEventListener('click', () => this.closeEditModal());
        document.getElementById('editEntryForm')?.addEventListener('submit', (e) => this.saveEntryEdit(e));

        // Action buttons
        document.getElementById('analyzeBtn')?.addEventListener('click', (e) => this.analyzeEntries(e));
        document.getElementById('generateStructureBtn')?.addEventListener('click', (e) => this.generateStructure(e));
        document.getElementById('publishForm')?.addEventListener('submit', (e) => this.publishJournal(e));

        // Handle mobile back button
        window.addEventListener('popstate', (e) => {
            if (this.currentStep > 1) {
                e.preventDefault();
                this.goToStep(this.currentStep - 1);
            }
        });
    }

    selectMethod(event) {
        // Remove previous selections
        document.querySelectorAll('.method-card').forEach(card => {
            card.classList.remove('selected');
        });

        // Select clicked method
        const card = event.currentTarget;
        card.classList.add('selected');
        this.selectedMethod = card.dataset.method;

        console.log('Selected method:', this.selectedMethod);

        // Add haptic feedback for mobile
        if (navigator.vibrate) {
            navigator.vibrate(50);
        }

        // Move to next step with slight delay for visual feedback
        setTimeout(() => {
            this.goToStep(2);
        }, 150);
    }

    updateSelectedEntries() {
        const checkboxes = document.querySelectorAll('.entry-checkbox:checked');
        this.selectedEntries = new Set(Array.from(checkboxes).map(cb => parseInt(cb.value)));

        // Update UI
        document.getElementById('selectedCount').textContent = this.selectedEntries.size;

        // Calculate total words
        let totalWords = 0;
        checkboxes.forEach(cb => {
            const card = cb.closest('.entry-card');
            const wordCountEl = card.querySelector('.word-count');
            const wordCount = wordCountEl.textContent.match(/\d+/);
            if (wordCount) totalWords += parseInt(wordCount[0]);
        });
        document.getElementById('totalWords').textContent = totalWords.toLocaleString();

        // Enable/disable analyze button
        const analyzeBtn = document.getElementById('analyzeBtn');
        if (analyzeBtn) {
            analyzeBtn.disabled = this.selectedEntries.size === 0;
        }

        // Update entry card styling
        document.querySelectorAll('.entry-card').forEach(card => {
            const checkbox = card.querySelector('.entry-checkbox');
            if (checkbox.checked) {
                card.classList.add('selected');
            } else {
                card.classList.remove('selected');
            }
        });

        // Haptic feedback for mobile
        if (navigator.vibrate && this.selectedEntries.size > 0) {
            navigator.vibrate(25);
        }
    }

    openEditModal(event) {
        event.stopPropagation();
        const entryId = event.currentTarget.dataset.entryId;
        const entryCard = event.currentTarget.closest('.entry-card');

        // Get current entry data
        const title = entryCard.querySelector('.entry-title').dataset.original;
        const content = entryCard.querySelector('.entry-content').dataset.original;

        // Populate modal
        document.getElementById('editEntryId').value = entryId;
        document.getElementById('editEntryTitle').value = title;
        document.getElementById('editEntryContent').value = content;

        // Show modal
        const modal = document.getElementById('editModal');
        modal.style.display = 'flex';

        // Focus first input for better UX
        setTimeout(() => {
            document.getElementById('editEntryTitle').focus();
        }, 100);

        // Prevent body scroll
        document.body.style.overflow = 'hidden';
    }

    closeEditModal() {
        document.getElementById('editModal').style.display = 'none';
        document.body.style.overflow = '';
    }

    async saveEntryEdit(event) {
        event.preventDefault();

        const entryId = document.getElementById('editEntryId').value;
        const title = document.getElementById('editEntryTitle').value;
        const content = document.getElementById('editEntryContent').value;

        if (!title.trim() || !content.trim()) {
            this.showError('Title and content are required');
            return;
        }

        const submitBtn = event.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;

        try {
            submitBtn.disabled = true;
            submitBtn.textContent = 'Saving...';

            const response = await fetch(`/entry/${entryId}/edit/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': this.getCSRFToken(),
                },
                body: new URLSearchParams({
                    'title': title,
                    'content': content,
                    'csrfmiddlewaretoken': this.getCSRFToken()
                })
            });

            if (response.ok) {
                // Update the entry card in the UI
                this.updateEntryCardAfterEdit(entryId, title, content);
                this.closeEditModal();
                this.showSuccess('Entry updated successfully!');

                // If this entry was selected, update the word count
                const checkbox = document.querySelector(`input[value="${entryId}"]`);
                if (checkbox && checkbox.checked) {
                    this.updateSelectedEntries();
                }

                // Haptic feedback
                if (navigator.vibrate) {
                    navigator.vibrate([50, 50, 50]);
                }
            } else {
                throw new Error('Failed to save entry');
            }

        } catch (error) {
            console.error('Save error:', error);
            this.showError('Failed to save entry: ' + error.message);
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
        }
    }

    updateEntryCardAfterEdit(entryId, newTitle, newContent) {
        const entryCard = document.querySelector(`[data-entry-id="${entryId}"]`);
        if (!entryCard) return;

        // Update title
        const titleEl = entryCard.querySelector('.entry-title');
        titleEl.textContent = newTitle.length > 40 ? newTitle.substring(0, 40) + '...' : newTitle;
        titleEl.dataset.original = newTitle;

        // Update content
        const contentEl = entryCard.querySelector('.entry-content');
        contentEl.textContent = newContent.length > 80 ? newContent.substring(0, 80) + '...' : newContent;
        contentEl.dataset.original = newContent;

        // Update word count
        const wordCount = newContent.split(/\s+/).filter(word => word.length > 0).length;
        const wordCountEl = entryCard.querySelector('.word-count');
        wordCountEl.textContent = `${wordCount} words`;
    }

    selectAllEntries() {
        document.querySelectorAll('.entry-checkbox').forEach(cb => cb.checked = true);
        this.updateSelectedEntries();
    }

    selectNoneEntries() {
        document.querySelectorAll('.entry-checkbox').forEach(cb => cb.checked = false);
        this.updateSelectedEntries();
    }

    async analyzeEntries(event) {
        event.preventDefault();

        if (!this.selectedMethod || this.selectedEntries.size === 0) {
            this.showError('Please select a method and entries first');
            return;
        }

        const button = event.target;
        const originalText = button.textContent;

        try {
            this.showLoading('Analyzing your entries...');
            button.disabled = true;
            button.textContent = 'Analyzing...';

            const response = await fetch('/diary/api/analyze-entries/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken(),
                },
                body: JSON.stringify({
                    method: this.selectedMethod,
                    entry_ids: Array.from(this.selectedEntries)
                })
            });

            const data = await response.json();

            if (data.success) {
                this.analysisData = data.analysis;
                this.displayAnalysisResults(data.analysis);
                this.goToStep(3);
                this.showSuccess('Analysis completed successfully!');

                // Haptic feedback
                if (navigator.vibrate) {
                    navigator.vibrate([100, 50, 100]);
                }
            } else {
                throw new Error(data.error || 'Analysis failed');
            }

        } catch (error) {
            console.error('Analysis error:', error);
            this.showError('Failed to analyze entries: ' + error.message);
        } finally {
            this.hideLoading();
            button.disabled = false;
            button.textContent = originalText;
        }
    }

    async generateStructure(event) {
        event.preventDefault();

        if (!this.analysisData) {
            this.showError('Please complete analysis first');
            return;
        }

        const button = event.target;
        const originalText = button.textContent;

        try {
            this.showLoading('Generating journal structure...');
            button.disabled = true;
            button.textContent = 'Generating...';

            const journalType = document.querySelector('input[name="journalType"]:checked')?.value || 'growth';

            const response = await fetch('/diary/api/generate-structure/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken(),
                },
                body: JSON.stringify({
                    method: this.selectedMethod,
                    journal_type: journalType,
                    entry_ids: Array.from(this.selectedEntries),
                    ai_enhancements: []
                })
            });

            const data = await response.json();

            if (data.success) {
                this.structureData = data.structure;
                this.displayStructure(data.structure);
                this.populatePublishingForm(data.structure);
                this.goToStep(4);
                this.showSuccess('Structure generated successfully!');

                // Haptic feedback
                if (navigator.vibrate) {
                    navigator.vibrate([100, 50, 100]);
                }
            } else {
                throw new Error(data.error || 'Structure generation failed');
            }

        } catch (error) {
            console.error('Structure generation error:', error);
            this.showError('Failed to generate structure: ' + error.message);
        } finally {
            this.hideLoading();
            button.disabled = false;
            button.textContent = originalText;
        }
    }

    async publishJournal(event) {
        event.preventDefault();

        if (!this.structureData) {
            this.showError('Please generate structure first');
            return;
        }

        const formData = new FormData(event.target);
        const title = formData.get('title') || document.getElementById('journalTitle').value;
        const description = formData.get('description') || document.getElementById('journalDescription').value;
        const price = parseFloat(document.getElementById('journalPrice').value || 0);

        if (!title || !description) {
            this.showError('Please fill in all required fields');
            return;
        }

        if (!confirm('Are you sure you want to publish this journal?')) {
            return;
        }

        const button = document.getElementById('publishBtn');
        const originalText = button.textContent;

        try {
            this.showLoading('Publishing your journal...');
            button.disabled = true;
            button.textContent = 'Publishing...';

            const response = await fetch('/diary/api/publish-journal/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken(),
                },
                body: JSON.stringify({
                    title: title,
                    description: description,
                    price: price
                })
            });

            const data = await response.json();

            if (data.success) {
                this.hideLoading();
                this.showSuccessModal(data.journal_id);

                // Haptic feedback
                if (navigator.vibrate) {
                    navigator.vibrate([200, 100, 200, 100, 200]);
                }
            } else {
                throw new Error(data.error || 'Publishing failed');
            }

        } catch (error) {
            console.error('Publishing error:', error);
            this.showError('Failed to publish journal: ' + error.message);
            this.hideLoading();
            button.disabled = false;
            button.textContent = originalText;
        }
    }

    displayAnalysisResults(analysis) {
        const container = document.getElementById('analysisResults');
        container.innerHTML = `
            <div class="grid grid-cols-2 md:grid-cols-4 gap-2 md:gap-4 mb-4 md:mb-6">
                <div class="text-center p-3 md:p-4 bg-white rounded-xl">
                    <div class="text-xl md:text-2xl font-bold text-blue-600">${analysis.total_entries || 0}</div>
                    <div class="text-xs md:text-sm text-gray-600">Entries</div>
                </div>
                <div class="text-center p-3 md:p-4 bg-white rounded-xl">
                    <div class="text-xl md:text-2xl font-bold text-green-600">${analysis.themes?.length || 0}</div>
                    <div class="text-xs md:text-sm text-gray-600">Themes</div>
                </div>
                <div class="text-center p-3 md:p-4 bg-white rounded-xl">
                    <div class="text-xl md:text-2xl font-bold text-yellow-600">${analysis.quality_score?.score || 0}%</div>
                    <div class="text-xs md:text-sm text-gray-600">Quality</div>
                </div>
                <div class="text-center p-3 md:p-4 bg-white rounded-xl">
                    <div class="text-xl md:text-2xl font-bold text-purple-600">${analysis.story_arcs?.length || 0}</div>
                    <div class="text-xs md:text-sm text-gray-600">Story Arcs</div>
                </div>
            </div>
            <div class="bg-blue-50 rounded-xl p-3 md:p-4">
                <h4 class="font-semibold text-blue-800 mb-2 text-sm md:text-base">Analysis Summary</h4>
                <p class="text-blue-700 text-xs md:text-sm">${analysis.ai_insights || 'Your entries have been analyzed and are ready for compilation.'}</p>
            </div>
        `;

        document.getElementById('generateStructureBtn').disabled = false;
    }

    displayStructure(structure) {
        const container = document.getElementById('structurePreview');

        let chaptersHtml = '';
        if (structure.chapters) {
            chaptersHtml = structure.chapters.map((chapter, index) => `
                <div class="border-l-4 border-blue-500 pl-3 md:pl-4 py-2">
                    <h4 class="font-medium text-gray-800 text-sm md:text-base">${chapter.title}</h4>
                    <p class="text-xs md:text-sm text-gray-600">${chapter.entry_count || 0} entries</p>
                    <p class="text-xs text-gray-500">${chapter.description || ''}</p>
                </div>
            `).join('');
        }

        container.innerHTML = `
            <div class="space-y-4">
                <div class="bg-white rounded-xl p-3 md:p-4">
                    <h3 class="font-bold text-gray-800 mb-2 text-sm md:text-base">${structure.title || 'Generated Journal'}</h3>
                    <p class="text-gray-600 text-xs md:text-sm">${structure.description || ''}</p>
                </div>
                <div class="space-y-3">${chaptersHtml}</div>
                <div class="bg-green-50 rounded-xl p-3 md:p-4">
                    <div class="text-xs md:text-sm">
                        <strong>Estimated Length:</strong> ${(structure.estimated_length || 0).toLocaleString()} words<br>
                        <strong>Suggested Price:</strong> ${structure.suggested_price || '9.99'}
                    </div>
                </div>
            </div>
        `;
    }

    populatePublishingForm(structure) {
        if (structure.title) {
            document.getElementById('journalTitle').value = structure.title;
        }
        if (structure.description) {
            document.getElementById('journalDescription').value = structure.description;
        }
        if (structure.suggested_price) {
            const price = typeof structure.suggested_price === 'string'
                ? structure.suggested_price.replace(', '')
                : structure.suggested_price;
            document.getElementById('journalPrice').value = price;
        }
    }

    goToStep(step) {
        this.currentStep = step;
        this.updateStepDisplay();

        // Scroll to top on mobile when changing steps
        if (window.innerWidth < 768) {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    }

    updateStepDisplay() {
        // Hide all step contents
        for (let i = 1; i <= 4; i++) {
            const content = document.getElementById(`step${i}Content`);
            if (content) {
                if (i === this.currentStep) {
                    content.classList.remove('hidden');
                    content.classList.add('fade-in');
                } else {
                    content.classList.add('hidden');
                    content.classList.remove('fade-in');
                }
            }
        }

        // Update step indicators
        for (let i = 1; i <= 4; i++) {
            const indicator = document.getElementById(`step${i}`);
            const line = document.getElementById(`line${i}`);

            if (indicator) {
                indicator.classList.remove('active', 'completed', 'pending');
                if (i < this.currentStep) {
                    indicator.classList.add('completed');
                } else if (i === this.currentStep) {
                    indicator.classList.add('active');
                } else {
                    indicator.classList.add('pending');
                }
            }

            if (line && i < 4) {
                line.classList.toggle('completed', i < this.currentStep);
            }
        }

        // Update step labels
        const stepLabels = document.querySelectorAll('.step-label');
        stepLabels.forEach((label, index) => {
            if (index + 1 === this.currentStep) {
                label.classList.add('active');
            } else {
                label.classList.remove('active');
            }
        });
    }

    showLoading(message) {
        document.getElementById('loadingText').textContent = message;
        document.getElementById('loadingOverlay').style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }

    hideLoading() {
        document.getElementById('loadingOverlay').style.display = 'none';
        document.body.style.overflow = '';
    }

    showSuccessModal(journalId) {
        const modal = document.getElementById('successModal');
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';

        document.getElementById('viewJournalBtn').onclick = () => {
            window.location.href = `/marketplace/journal/${journalId}/`;
        };
    }

    showSuccess(message) {
        this.showToast(message, 'success');
    }

    showError(message) {
        this.showToast(message, 'error');
    }

    showToast(message, type = 'info', duration = 4000) {
        // Use the global toast function if available, otherwise create a simple fallback
        if (window.showToast) {
            window.showToast(message, type, duration);
        } else {
            // Simple fallback for mobile
            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 left-4 md:left-auto md:max-w-md p-4 rounded-lg shadow-lg z-50 transform transition-transform duration-300 ${
                type === 'success' ? 'bg-green-500 text-white' :
                type === 'error' ? 'bg-red-500 text-white' :
                'bg-blue-500 text-white'
            }`;
            toast.textContent = message;
            toast.style.transform = 'translateY(-100px)';

            document.body.appendChild(toast);

            // Show toast
            setTimeout(() => {
                toast.style.transform = 'translateY(0)';
            }, 100);

            // Hide toast
            setTimeout(() => {
                toast.style.transform = 'translateY(-100px)';
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, duration);
        }
    }

    getCSRFToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
               document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
    }
}

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    // Check if we're on mobile and add appropriate class
    if (window.innerWidth < 768) {
        document.body.classList.add('mobile-device');
    }

    // Initialize the compiler
    new SmartJournalCompiler();

    // Add viewport meta tag if not present (for better mobile experience)
    if (!document.querySelector('meta[name="viewport"]')) {
        const viewport = document.createElement('meta');
        viewport.name = 'viewport';
        viewport.content = 'width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0';
        document.head.appendChild(viewport);
    }

    // Prevent double-tap zoom on mobile
    let lastTouchEnd = 0;
    document.addEventListener('touchend', function (event) {
        const now = (new Date()).getTime();
        if (now - lastTouchEnd <= 300) {
            event.preventDefault();
        }
        lastTouchEnd = now;
    }, { passive: false });

    // Handle orientation change
    window.addEventListener('orientationchange', function() {
        setTimeout(() => {
            // Force a reflow to handle any layout issues
            document.body.style.height = window.innerHeight + 'px';
            setTimeout(() => {
                document.body.style.height = '';
            }, 100);
        }, 100);
    });

    // Handle safe area for devices with notches
    if (CSS.supports('padding-top: env(safe-area-inset-top)')) {
        document.documentElement.style.setProperty('--safe-area-top', 'env(safe-area-inset-top)');
        document.documentElement.style.setProperty('--safe-area-bottom', 'env(safe-area-inset-bottom)');
    }

    console.log('Mobile-optimized Smart Journal Compiler initialized');
});

// Handle resize events
window.addEventListener('resize', function() {
    // Update mobile class based on screen size
    if (window.innerWidth < 768) {
        document.body.classList.add('mobile-device');
    } else {
        document.body.classList.remove('mobile-device');
    }
}, { passive: true });

// Performance optimization: Throttle scroll events
let ticking = false;
function updateScrollPosition() {
    // Add any scroll-based animations or effects here
    ticking = false;
}

window.addEventListener('scroll', function() {
    if (!ticking) {
        requestAnimationFrame(updateScrollPosition);
        ticking = true;
    }
}, { passive: true });
</script>
{% endblock %}
